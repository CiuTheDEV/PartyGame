<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tajniacy</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
*{box-sizing:border-box}
html,body{height:100%;margin:0}
/* ANCHOR: BASE_UI */
body{
  /* ANCHOR: THEME_TAJNIACY */
  --accent:#e74c3c;
  --accent2:#3498db;
  --accentA15:rgba(231,76,60,.15);
  --accent2A15:rgba(52,152,219,.15);
  --focusRing:0 0 0 2px var(--accent);

  /* ANCHOR: BTN_TOKENS */
  --btnShadow:0 8px 16px rgba(0,0,0,.35);
  --btnShadowHover:0 9px 18px rgba(0,0,0,.40);
  --btnLine:rgba(255,255,255,.10);
  --btnInset:0 1px 0 rgba(255,255,255,.06) inset;

  /* ANCHOR: ACTION_TOKENS */
  --danger:#e74c3c;
  --dangerHover:#c0392b;

  /* ANCHOR: ROUND_RANGE_TOKENS */
  --rangeLabelW:170px;
  --rangeBadgeW:64px;

  font-family:'Segoe UI',Tahoma,sans-serif;
  background:#1a1a1a;
  color:#fff;
  text-align:center;
  padding:0;
  display:flex;
  flex-direction:column;
}
body.game-active{height:100vh;height:100dvh;overflow:hidden}

/* GAME SCREEN - nowy layout */
/* ANCHOR: GAME_SCREEN */
#gameScreen{display:none;flex-direction:column;height:100%;overflow:hidden}

.top-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:clamp(5px,1vh,15px) clamp(10px,2vw,30px);
    background:linear-gradient(180deg,#252525,#1a1a1a);
    flex-shrink:0;
    gap:clamp(10px,2vw,30px);
}

.team-bar{
    display:flex;
    align-items:center;
    gap:clamp(8px,1.5vw,20px);
    padding:clamp(8px,1.5vh,20px) clamp(15px,2.5vw,35px);
    border-radius:clamp(8px,1vw,15px);
    flex:1;
    max-width:40%;
}
.team-bar.red{
    background:linear-gradient(135deg,rgba(231,76,60,0.3),rgba(231,76,60,0.1));
    border:2px solid #e74c3c;
    justify-content:flex-start;
}
.team-bar.blue{
    background:linear-gradient(135deg,rgba(52,152,219,0.1),rgba(52,152,219,0.3));
    border:2px solid #3498db;
    justify-content:flex-end;
}

.team-bar .team-emoji{font-size:clamp(1.5rem,4vmin,3.5rem)}
.team-bar .team-name{
    font-size:clamp(1rem,2.5vmin,2rem);
    font-weight:bold;
    flex:1;
    min-width:0;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
}
.team-bar.red .team-name{color:#e74c3c;text-align:left}
.team-bar.blue .team-name{color:#3498db;text-align:right}
.team-bar .team-score{
    font-size:clamp(1.5rem,4vmin,3.5rem);
    font-weight:bold;
    min-width:clamp(40px,5vmin,80px);
    text-align:center;
    padding:clamp(3px,0.5vmin,8px) clamp(10px,1.5vmin,20px);
    border-radius:clamp(6px,0.8vmin,12px);
    flex-shrink:0;
}
.team-bar.red .team-score{background:#e74c3c}
.team-bar.blue .team-score{background:#3498db}

.top-controls{
    display:flex;
    gap:clamp(5px,1vw,15px);
    flex-shrink:0;
}

.icon-btn{
    width:clamp(40px,6vmin,70px);
    height:clamp(40px,6vmin,70px);
    border-radius:clamp(8px,1vmin,15px);
    border:none;
    background:#333;
    color:#fff;
    font-size:clamp(1.2rem,3vmin,2.5rem);
    cursor:pointer;
    transition:background .2s;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    position:relative;
}
.icon-btn span{position:relative;z-index:2}
.icon-btn svg.hold-progress{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    z-index:1;
}
.icon-btn svg.hold-progress path{
    fill:none;
    stroke:#4CAF50;
    stroke-width:4;
    stroke-dasharray:1000;
    stroke-dashoffset:1000;
}
.icon-btn:hover{background:#444}
.icon-btn.active{background:#FF9800;box-shadow:0 0 15px rgba(255,152,0,0.5)}

.board-container{
    flex-grow:1;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:clamp(5px,1vmin,15px);
    min-height:0;
    overflow:hidden;
}

.grid-container{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    grid-template-rows:repeat(5,1fr);
    gap:clamp(4px,0.8vmin,12px);
    width:100%;
    height:100%;
}

.card{
    perspective:1000px;
    background:transparent;
    border-radius:clamp(8px,1.5vmin,20px);
    cursor:pointer;
    user-select:none;
    transition:transform .15s,box-shadow .15s;
}
.card:hover{transform:translateY(-3px) scale(1.02)}
.card.keyboard-selected{
    transform:translateY(-3px) scale(1.02);
    outline:3px solid #FFD700;
    outline-offset:2px;
    box-shadow:0 0 20px rgba(255,215,0,0.5);
}
.card.holding{
    transform:scale(0.95);
    transition:transform 0.1s;
}
.card.holding .card-inner{
    box-shadow:0 0 15px rgba(255,255,255,0.3);
}

.card-inner{
    position:relative;
    width:100%;
    height:100%;
    transform-style:preserve-3d;
    transition:transform 0.6s ease;
}
.card.flipped .card-inner{
    transform:rotateY(180deg);
}

.card-front,.card-back{
    position:absolute;
    inset:0;
    backface-visibility:hidden;
    -webkit-backface-visibility:hidden;
    border-radius:clamp(8px,1.5vmin,20px);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:clamp(14px,4vmin,52px);
    font-weight:bold;
    text-transform:uppercase;
    padding:clamp(5px,1vmin,15px);
    text-align:center;
    word-break:break-word;
    overflow:hidden;
    box-shadow:0 clamp(2px,0.4vmin,6px) clamp(4px,0.8vmin,12px) rgba(0,0,0,0.3);
    letter-spacing:0.5px;
}

.card-back{
    background:linear-gradient(135deg,#3a3a3a,#2a2a2a);
    border:2px solid #4a4a4a;
}
.card-back::before{
    content:'?';
    font-size:clamp(24px,6vmin,60px);
    color:#555;
    font-weight:bold;
}

.card-front{
    transform:rotateY(180deg);
    background:#f5f5f5;
    color:#222;
    border:2px solid transparent;
}

/* Style talii - awers */
.deck-white .card-front{background:#f5f5f5;color:#222}
.deck-classic .card-front{background:#2a2a2a;color:#f0f0f0;border:2px solid #3a3a3a}
.deck-night .card-front{background:linear-gradient(145deg,#1a1a2e,#0d0d18);color:#d0d0f0;border:2px solid #2a2a4e}

/* Obramówka zabójcy w białej talii */
.deck-white .card.is-assassin .card-front{border:2px solid #ddd}

/* Style talii - rewers */
.deck-white .card-back{background:linear-gradient(135deg,#e8e8e8,#d0d0d0);border-color:#ccc}
.deck-white .card-back::before{color:#aaa}
.deck-classic .card-back{background:linear-gradient(135deg,#1a1a1a,#0a0a0a);border-color:#3a3a3a}
.deck-classic .card-back::before{color:#444}
.deck-night .card-back{background:linear-gradient(135deg,#0d0d18,#05050a);border-color:#2a2a4e}
.deck-night .card-back::before{color:#3a3a5e}

.is-red{--true:#e74c3c;--text:#fff;--soft:rgba(231,76,60,0.7)}
.is-blue{--true:#3498db;--text:#fff;--soft:rgba(52,152,219,0.7)}
.is-neutral{--true:#7f8c8d;--text:#fff;--soft:rgba(127,140,141,0.5)}
.is-assassin{--true:#1a1a1a;--text:#fff;--soft:rgba(20,20,20,0.9)}

.card.revealed .card-front{
    background:var(--true)!important;
    color:var(--text)!important;
    cursor:default;
    box-shadow:inset 0 0 clamp(15px,3vmin,40px) rgba(0,0,0,0.3);
    text-shadow:2px 2px 4px rgba(0,0,0,0.5);
    border-color:var(--true)!important;
}
.card.revealed:hover{transform:none}

/* Tryb klucza - pełne tło w stonowanych kolorach */
body.spymaster-mode .card .card-front{
    background:var(--soft)!important;
    color:#fff!important;
    text-shadow:1px 1px 3px rgba(0,0,0,0.5);
}
body.spymaster-mode .card:hover{
    transform:none;
}
body.spymaster-mode .card.is-assassin .card-front{
    color:#e74c3c!important;
    text-shadow:0 0 10px rgba(0,0,0,0.8);
    flex-direction:column;
    gap:clamp(2px,0.5vmin,8px);
}
body.spymaster-mode .card.is-assassin .card-front::after{
    content:'☠';
    font-size:clamp(16px,3.5vmin,40px);
    opacity:0.9;
}
body.spymaster-mode .card.is-assassin.revealed .card-front::after{
    display:none;
}
body.spymaster-mode .card.revealed .card-front{
    background:var(--true)!important;
    box-shadow:inset 0 0 clamp(15px,3vmin,40px) rgba(0,0,0,0.3);
}

.bottom-bar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:clamp(5px,1vh,12px) clamp(10px,2vw,30px);
    background:linear-gradient(0deg,#252525,#1a1a1a);
    flex-shrink:0;
    gap:clamp(5px,1vw,20px);
    overflow:hidden;
}

.remaining-cards{
    display:flex;
    gap:clamp(2px,0.4vmin,8px);
    align-items:center;
    flex-shrink:1;
    min-width:0;
    flex-wrap:wrap;
    max-width:45%;
}
.remaining-cards.red{justify-content:flex-start}
.remaining-cards.blue{flex-direction:row-reverse;justify-content:flex-start}

.remaining-card{
    width:clamp(28px,4vmin,55px);
    height:clamp(36px,5.5vmin,70px);
    border-radius:clamp(4px,0.6vmin,10px);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    transition:all .3s;
    box-shadow:0 2px 5px rgba(0,0,0,0.3);
    gap:1px;
    flex-shrink:0;
}
.remaining-card .card-emoji{font-size:clamp(0.8rem,2vmin,1.6rem)}
.remaining-card .card-num{font-weight:bold;opacity:0.9;font-size:clamp(0.65rem,1.5vmin,1.2rem)}
.remaining-cards.red .remaining-card{background:#e74c3c}
.remaining-cards.blue .remaining-card{background:#3498db}
.remaining-card.revealed{opacity:0.2;transform:scale(0.85)}

#status{
    font-size:clamp(0.9rem,2.5vmin,1.8rem);
    font-weight:bold;
    white-space:nowrap;
    padding:0 clamp(10px,2vw,30px);
}
#status .team-red{color:#e74c3c}
#status .team-blue{color:#3498db}

/* OVERLAYS */
/* ANCHOR: OVERLAYS_UI */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:999;padding:2vh 2vw;overflow-y:auto}

.overlay-title{font-size:clamp(1.5rem,4vmin,2.5rem);margin-bottom:clamp(15px,3vmin,25px)}
.confirm-msg{font-size:clamp(1rem,2.2vmin,1.1rem);color:#f39c12;margin:0 0 clamp(18px,3vmin,25px);text-align:center}
.overlay-text{font-size:clamp(0.9rem,2vmin,1.1rem);color:#ccc;margin-bottom:clamp(15px,2.5vmin,25px)}

/* ANCHOR: HOME_UI */
.home-container{max-width:min(900px,90vw);width:90%}
.home-version{margin-top:14px;font-size:clamp(.75rem,1.6vmin,.95rem);color:#666;opacity:.85}

.home-title{
    font-size:clamp(2.5rem,8vmin,5rem);
    margin-bottom:2vh;
    background:linear-gradient(135deg,#e74c3c,#3498db);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    animation:titlePulse 3s ease-in-out infinite;
    filter:drop-shadow(0 0 20px rgba(231,76,60,0.6)) drop-shadow(0 0 40px rgba(52,152,219,0.4));
}

@keyframes titlePulse{
    0%,100%{
        transform:scale(1);
        filter:drop-shadow(0 0 20px rgba(231,76,60,0.6)) drop-shadow(0 0 40px rgba(52,152,219,0.4));
    }
    50%{
        transform:scale(1.02);
        filter:drop-shadow(0 0 30px rgba(231,76,60,0.8)) drop-shadow(0 0 60px rgba(52,152,219,0.6));
    }
}
.home-subtitle{font-size:clamp(1rem,3vmin,2rem);color:#aaa;margin-bottom:4vh}
/* ANCHOR: MODE_CARDS_UI */
.mode-selection{
    display:flex;
    flex-direction:column;
    gap:clamp(10px,2vmin,20px);
    margin-bottom:3vh;
}
.mode-card{
    background:linear-gradient(135deg,#2a2a2a,#1a1a1a);
    border-radius:clamp(12px,2vmin,20px);
    transition:all .3s;
    border:2px solid transparent;
    overflow:hidden;
}
.mode-card:hover{box-shadow:0 5px 20px rgba(0,0,0,.4)}
.mode-card.classic{border-color:var(--accent)}
.mode-card.crazy{border-color:#FF9800}
.mode-card.wip{border-color:#9E9E9E}

.mode-header{
    display:flex;
    align-items:center;
    padding:clamp(12px,2.5vmin,25px) clamp(15px,3vmin,30px);
    position:relative;
    cursor:pointer;
}
.mode-icon{
    font-size:clamp(2rem,5vmin,3.5rem);
    position:absolute;
    left:clamp(15px,3vmin,30px);
}
.mode-title-wrapper{
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:clamp(8px,1.5vmin,15px);
}
.mode-title{
    font-size:clamp(1.3rem,3.5vmin,2.2rem);
    font-weight:bold;
}
.mode-card.classic .mode-title{color:var(--accent)}
.mode-card.crazy .mode-title{color:#FF9800}
.mode-card.wip .mode-title{color:#9E9E9E}

.mode-arrow{
    position:absolute;
    right:clamp(15px,3vmin,30px);
    font-size:clamp(0.8rem,2vmin,1.2rem);
    color:#666;
    transition:transform .3s;
}
.mode-card.open .mode-arrow{transform:rotate(180deg)}

.mode-wip-badge{
    background:#9E9E9E;
    color:#1a1a1a;
    font-size:clamp(0.6rem,1.5vmin,0.8rem);
    font-weight:bold;
    padding:clamp(3px,0.5vmin,5px) clamp(8px,1.2vmin,12px);
    border-radius:clamp(4px,0.8vmin,8px);
    text-transform:uppercase;
    letter-spacing:1px;
}
.mode-arrow{
    position:absolute;
    right:clamp(15px,3vmin,30px);
    font-size:clamp(0.8rem,2vmin,1.2rem);
    color:#666;
    transition:transform .3s ease;
}
.mode-card.open .mode-arrow{transform:rotate(180deg)}

.mode-content{
    max-height:0;
    overflow:hidden;
    transition:max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    border-top:1px solid transparent;
}
.mode-card.open .mode-content{
    max-height:500px;
    border-top-color:#333;
}
.mode-content-inner{
    display:flex;
    flex-direction:row;
    align-items:flex-end;
    justify-content:space-between;
    gap:clamp(15px,3vmin,25px);
    padding:clamp(12px,2vmin,20px) clamp(15px,3vmin,30px);
    background:rgba(0,0,0,0.2);
}

.mode-details{
    flex:1;
    min-width:0;
    opacity:0;
    transform:translateY(-10px);
    transition:opacity 0.4s ease 0.15s, transform 0.4s ease 0.15s;
}
.mode-card.open .mode-details{
    opacity:1;
    transform:translateY(0);
}

.mode-buttons{
    display:flex;
    gap:clamp(8px,1.5vmin,12px);
    flex-shrink:0;
    align-self:flex-end;
    opacity:0;
    transform:translateX(10px);
    transition:opacity 0.4s ease 0.2s, transform 0.4s ease 0.2s;
}
.mode-card.open .mode-buttons{
    opacity:1;
    transform:translateX(0);
}

.mode-description{
    font-size:clamp(0.9rem,2vmin,1.1rem);
    color:#aaa;
    margin-bottom:clamp(6px,1vmin,10px);
}
.mode-features{
    text-align:left;
    font-size:clamp(0.8rem,1.8vmin,1rem);
    color:#888;
    list-style:none;
    padding:0;
    margin:0;
}
.mode-features li{
    margin:clamp(2px,0.5vmin,5px) 0;
    padding-left:1em;
    position:relative;
}
.mode-features li::before{
    content:'•';
    position:absolute;
    left:0;
    color:#666;
}

.mode-btn{
    width:clamp(40px,7vmin,55px);
    height:clamp(40px,7vmin,55px);
    border-radius:50%;
    border:2px solid #666;
    background:rgba(0,0,0,0.3);
    color:#aaa;
    font-size:clamp(1.1rem,2.5vmin,1.5rem);
    font-weight:bold;
    cursor:pointer;
    transition:all .2s;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
}
.mode-btn.info{
    font-style:italic;
    font-family:Georgia,serif;
}
.mode-btn:hover{
    background:rgba(255,255,255,0.1);
    border-color:#aaa;
    color:#fff;
    transform:scale(1.1);
}
.mode-card.classic .mode-btn.play{
    border-color:var(--accent);
    color:var(--accent);
}
.mode-card.classic .mode-btn.play:hover{
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    color:#fff;
    border-color:transparent;
}
.mode-card.crazy .mode-btn.play{border-color:#FF9800;color:#FF9800}
.mode-card.crazy .mode-btn.play:hover{background:#FF9800;color:#fff}
.mode-card.wip .mode-btn.play{border-color:#9E9E9E;color:#9E9E9E}
.mode-card.wip .mode-btn.play:hover{background:#9E9E9E;color:#fff}
.mode-btn.disabled{
    opacity:0.4;
    cursor:not-allowed;
}
.mode-btn.disabled:hover{
    transform:none;
    background:rgba(0,0,0,0.3);
}

/* Rules overlay */
/* ANCHOR: RULES_UI */
.rules-container{
    background:#2a2a2a;
    border-radius:clamp(15px,2vmin,25px);
    padding:clamp(20px,4vmin,40px);
    max-width:min(600px,90vw);
    width:90%;
    max-height:85vh;
    text-align:left;
    display:flex;
    flex-direction:column;
}
.rules-title{
    font-size:clamp(1.5rem,4vmin,2.5rem);
    margin-bottom:clamp(15px,3vmin,25px);
    text-align:center;
    background:linear-gradient(135deg,#e74c3c,#3498db);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
}
.rules-content{
    font-size:clamp(0.9rem,2.2vmin,1.1rem);
    color:#ccc;
    line-height:1.6;
    overflow-y:auto;
    max-height:60vh;
    padding-right:8px;
}
.rules-content h3{
    color:#fff;
    font-size:clamp(1.1rem,2.5vmin,1.4rem);
    margin:clamp(15px,2.5vmin,25px) 0 clamp(8px,1.5vmin,12px);
}
.rules-content h3:first-child{margin-top:0}
.rules-content p{margin:clamp(8px,1.5vmin,12px) 0}
.rules-content ul{
    margin:clamp(8px,1.5vmin,12px) 0;
    padding-left:clamp(20px,3vmin,30px);
}
.rules-content li{margin:clamp(4px,0.8vmin,8px) 0}
.rules-content .highlight{
    color:var(--accent);
    font-weight:bold;
}
.rules-content .danger{
    color:#e74c3c;
    font-weight:bold;
}
.rules-content .info{
    color:#3498db;
}
.rules-container button{
    display:block;
    margin:clamp(20px,3vmin,30px) auto 0;
}

/* SETTINGS */
/* ANCHOR: SETTINGS_UI */
/* ANCHOR: SCROLL_SURFACE (wspólne scroll bary w kolorze gry) */
.scroll-surface{-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:var(--accent) #1a1a1a}
.scroll-surface::-webkit-scrollbar{width:8px}
.scroll-surface::-webkit-scrollbar-track{background:#1a1a1a;border-radius:4px}
.scroll-surface::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--accent),var(--accent2));border-radius:4px}
.scroll-surface::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,var(--accent2),var(--accent))}

.settings-container{background:#2a2a2a;border-radius:clamp(15px,2vmin,25px);padding:clamp(15px,3vmin,40px);max-width:min(800px,95vw);width:95%;max-height:90vh;overflow-y:auto;overflow-x:hidden}
.settings-title{font-size:clamp(1.5rem,4vmin,2.5rem);margin-bottom:2vh;background:linear-gradient(135deg,#e74c3c,#3498db);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

/* ANCHOR: MODE_SETTINGS_CARDS (rozwijane sekcje accordion) */
.settings-accordion{display:flex;flex-direction:column;gap:clamp(10px,2vmin,18px)}
.setting-card{background:linear-gradient(135deg,#1f1f1f,#121212);border:2px solid #333;border-radius:clamp(12px,2vmin,20px);overflow:hidden;transition:border-color .18s, box-shadow .18s}
.setting-card.open{border-color:rgba(231,76,60,.55);box-shadow:0 10px 22px rgba(0,0,0,.45) inset, 0 12px 26px rgba(0,0,0,.35)}
.setting-head{display:flex;align-items:center;gap:10px;padding:clamp(12px,2.2vmin,18px) clamp(14px,2.6vmin,20px);cursor:pointer;position:relative}
.setting-title{font-weight:900;color:#fff;text-align:left}
.setting-sub{flex:1;text-align:right;color:#888;font-size:.95rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:26px}
.setting-arrow{position:absolute;right:clamp(14px,2.6vmin,20px);color:#666;transition:transform .2s}
.setting-card.open .setting-arrow{transform:rotate(180deg)}
.setting-body{max-height:0;overflow:hidden;transition:max-height .35s cubic-bezier(0.4,0,0.2,1);border-top:1px solid transparent}
.setting-card.open .setting-body{max-height:1200px;border-top-color:#222}
.setting-body-inner{padding:clamp(12px,2vmin,16px);background:rgba(0,0,0,0.12)}
.setting-actions{margin-top:12px}
.setting-actions .btn-new{width:100%}

/* ANCHOR: CARD_OPTIONS (opcje wewnątrz kart accordion) */
.deck-picker-content{display:flex;flex-direction:column;gap:clamp(8px,1.5vmin,12px)}
.deck-option{
    background:#2a2a2a;
    border:2px solid #444;
    border-radius:clamp(8px,1.2vmin,12px);
    padding:clamp(10px,1.8vmin,15px);
    cursor:pointer;
    transition:all .2s;
}
.deck-option:hover{background:#333;border-color:#666}
.deck-option.selected{border-color:var(--accent);background:linear-gradient(135deg,#2a1f1f,#1a1212)}
.deck-info{display:flex;flex-direction:column;gap:4px}
.deck-title{color:#fff;font-weight:bold;font-size:clamp(1rem,2.2vmin,1.3rem)}
.deck-desc{color:#888;font-size:clamp(0.85rem,1.8vmin,1rem);line-height:1.3}
.deck-counter{color:#4CAF50;font-size:clamp(0.8rem,1.7vmin,0.95rem);font-weight:bold;margin-top:4px;display:inline-block}

.deck-actions{display:flex;gap:clamp(8px,1.5vmin,12px);margin-top:clamp(6px,1vmin,8px);margin-bottom:clamp(8px,1.5vmin,12px);justify-content:center}
.btn-deck-action{
    flex:1;
    max-width:200px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    padding:clamp(10px,2vmin,14px);
    background:#2a2a2a;
    border:2px solid #444;
    border-radius:clamp(8px,1.2vmin,12px);
    color:#ccc;
    font-weight:bold;
    font-size:clamp(0.8rem,1.8vmin,0.95rem);
    cursor:pointer;
    transition:all .2s;
}
.btn-deck-action:hover{background:#333;border-color:#666}
.btn-deck-action:active{transform:scale(0.98)}
.deck-action-icon{font-size:clamp(1rem,2.2vmin,1.3rem);line-height:1}
.deck-action-text{line-height:1}

.rounds-picker-content,.picker-panel-content{display:flex;flex-direction:column;gap:10px}
.rounds-options,.picker-options{display:flex;gap:clamp(6px,1.2vmin,10px);flex-wrap:wrap;justify-content:center}
.rounds-option,.picker-option{
    min-width:clamp(40px,8vmin,60px);
    height:clamp(40px,8vmin,60px);
    display:flex;
    align-items:center;
    justify-content:center;
    background:#2a2a2a;
    border:2px solid #444;
    border-radius:clamp(8px,1.2vmin,12px);
    cursor:pointer;
    transition:all .2s;
    font-size:clamp(1.1rem,2.6vmin,1.5rem);
    font-weight:bold;
    color:#ccc;
}
.rounds-option:hover,.picker-option:hover{background:#333;border-color:#666}
.rounds-option.selected,.picker-option.selected{border-color:var(--accent);background:linear-gradient(135deg,#2a1f1f,#1a1212);color:#fff}
.rounds-option.custom{font-size:clamp(1.5rem,3.5vmin,2rem);color:#888}
.rounds-custom{margin-top:8px;padding:12px;background:#222;border-radius:8px;display:none}
.rounds-custom label{display:block;margin-bottom:6px;color:#ccc}
.custom-input-group{display:flex;gap:8px;align-items:center;justify-content:center}
.custom-btn{
    min-width:clamp(40px,8vmin,60px);
    height:clamp(40px,8vmin,60px);
    display:flex;
    align-items:center;
    justify-content:center;
    background:#2a2a2a;
    border:2px solid #444;
    border-radius:clamp(8px,1.2vmin,12px);
    color:#fff;
    font-size:clamp(1.5rem,3.5vmin,2rem);
    font-weight:bold;
    cursor:pointer;
    transition:all .2s;
    flex-shrink:0;
}
.custom-btn:hover{background:#333;border-color:#666}
.custom-btn:active{transform:scale(0.95)}
.rounds-custom input{
    width:clamp(80px,16vmin,120px);
    min-width:clamp(40px,8vmin,60px);
    height:clamp(40px,8vmin,60px);
    padding:10px;
    background:#2a2a2a;
    border:2px solid #444;
    border-radius:clamp(8px,1.2vmin,12px);
    color:#fff;
    font-size:clamp(1.1rem,2.6vmin,1.5rem);
    font-weight:bold;
    text-align:center;
}
.rounds-custom input::-webkit-outer-spin-button,
.rounds-custom input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
.rounds-custom input[type=number]{-moz-appearance:textfield}
.picker-options.starter-options .picker-option{min-width:auto;padding:0 clamp(12px,2vmin,18px)}

.style-option{
    background:#2a2a2a;
    border:2px solid #444;
    border-radius:clamp(8px,1.2vmin,12px);
    padding:clamp(10px,1.8vmin,15px);
    cursor:pointer;
    transition:all .2s;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
}
.style-option:hover{background:#333;border-color:#666}
.style-option.selected{border-color:var(--accent);background:linear-gradient(135deg,#2a1f1f,#1a1212)}
.style-preview{display:flex;gap:6px;justify-content:center;padding:8px}
.preview-card{
    width:clamp(36px,7vmin,55px);
    height:clamp(50px,10vmin,75px);
    border-radius:clamp(4px,0.8vmin,8px);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:clamp(0.5rem,1.2vmin,0.75rem);
    font-weight:bold;
    border:2px solid;
}
.deck-white .preview-card{background:#f5f5f5;color:#222;border-color:#ddd}
.deck-white .preview-card.revealed.is-red{background:#e74c3c;color:#fff;border-color:#c0392b}
.deck-white .preview-card.revealed.is-blue{background:#3498db;color:#fff;border-color:#2980b9}
.deck-classic .preview-card{background:#2a2a2a;color:#f0f0f0;border-color:#3a3a3a}
.deck-classic .preview-card.revealed.is-red{background:#e74c3c;color:#fff;border-color:#c0392b}
.deck-classic .preview-card.revealed.is-blue{background:#3498db;color:#fff;border-color:#2980b9}
.deck-night .preview-card{background:linear-gradient(145deg,#1a1a2e,#0d0d18);color:#d0d0f0;border-color:#2a2a4e}
.deck-night .preview-card.revealed.is-red{background:#e74c3c;color:#fff;border-color:#c0392b}
.deck-night .preview-card.revealed.is-blue{background:#3498db;color:#fff;border-color:#2980b9}
.style-name{color:#fff;font-size:clamp(0.9rem,2vmin,1.1rem);font-weight:bold}

/* ANCHOR: BUTTON_GROUP */
.button-group{display:flex;gap:clamp(10px,2vmin,20px);margin-top:2vh;flex-wrap:wrap;justify-content:center}

/* ANCHOR: SETTINGS_WRAPPER (container dla scroll + przyciski na dole) */
.team-setup{display:grid;grid-template-columns:1fr;gap:clamp(10px,2vmin,20px);margin-bottom:2vh}
@media(min-width:600px){.team-setup{grid-template-columns:1fr 1fr}}
.team-card{background:#1a1a1a;border-radius:clamp(8px,1.2vmin,15px);padding:clamp(12px,2vmin,25px);border:2px solid}
.team-card.red{border-color:#e74c3c}.team-card.blue{border-color:#3498db}
.team-card h3{margin:0 0 clamp(8px,1.5vmin,15px);font-size:clamp(1rem,2.5vmin,1.6rem)}
.team-card.red h3{color:#e74c3c}.team-card.blue h3{color:#3498db}
.avatar-picker{display:grid;grid-template-columns:repeat(4,1fr);gap:clamp(4px,1vmin,10px);margin-bottom:clamp(8px,1.5vmin,15px)}
.avatar-option{
    font-size:clamp(1.2rem,3.5vmin,2.5rem);
    aspect-ratio:1;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#333;
    border-radius:clamp(6px,1vmin,12px);
    cursor:pointer;
    transition:all .2s;
    border:2px solid transparent;
    padding:0;
}
.avatar-option:hover{background:#444}
.avatar-option.selected{
    border-color:var(--accent);
    background:linear-gradient(135deg,var(--accentA15),var(--accent2A15));
}
.team-card.red .avatar-option.selected{
    border-color:#e74c3c;
    background:linear-gradient(135deg,rgba(231,76,60,0.15),rgba(192,57,43,0.15));
}
.team-card.blue .avatar-option.selected{
    border-color:#3498db;
    background:linear-gradient(135deg,rgba(52,152,219,0.15),rgba(41,128,185,0.15));
}
.avatar-option.avatar-plus{
    font-size:clamp(1.5rem,4vmin,2.8rem);
    color:#888;
    font-weight:300;
}
.avatar-option.avatar-plus:hover{color:#fff;background:#555}

/* Emoji picker grid */
/* ANCHOR: EMOJI_PICKER_LAYOUT (scroll tylko na siatce avatarów) */
/* ANCHOR: EMOJI_PICKER_FIXED_HEIGHT (stała wysokość kontenera — bez skakania tła przy zmianie kategorii) */
#emojiPickerOverlay .settings-container{display:flex;flex-direction:column;height:min(90vh,720px);max-height:90vh;overflow:hidden}
#emojiPickerOverlay .emoji-picker-avatars{flex:1 1 auto;min-height:0;display:flex;flex-direction:column}

/* ANCHOR: EMOJI_TABS */
.emoji-tabs{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:12px;width:100%}
.emoji-tab{
    padding:10px 6px;
    border-radius:10px;
    border:2px solid #333;
    background:#1a1a1a;
    color:#ddd;
    font-weight:1000;
    font-size:clamp(0.75rem,2vw,1rem);
    cursor:pointer;
    transition:all .15s;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}
.emoji-tab:hover{border-color:#666;background:#222}
.emoji-tab.selected{border-color:var(--accent);background:var(--accentA15);color:#fff}

/* ANCHOR: EMOJI_GRID_SCROLLFIX (bez pojawiającego się poziomego scrolla przy hover) */
.emoji-grid{
    display:grid;
    grid-template-columns:repeat(6,minmax(0,1fr));
    gap:clamp(6px,1.2vmin,10px);
    margin-top:12px;
    flex:1 1 auto;
    min-height:0;
    overflow-y:auto;
    overflow-x:hidden;
    padding:2px 4px 2px 2px;
    background:#1a1a1a;
    border-radius:clamp(8px,1vmin,12px);
}
.emoji-grid::-webkit-scrollbar{
    width:8px;
}
.emoji-grid::-webkit-scrollbar-track{
    background:#2a2a2a;
    border-radius:4px;
}
.emoji-grid::-webkit-scrollbar-thumb{
    background:linear-gradient(180deg,var(--accent),var(--accent2));
    border-radius:4px;
}
.emoji-grid::-webkit-scrollbar-thumb:hover{
    background:linear-gradient(180deg,var(--accent2),var(--accent));
}
.emoji-option{
    font-size:clamp(1.5rem,4vmin,2.2rem);
    aspect-ratio:1;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#333;
    border-radius:clamp(6px,0.8vmin,10px);
    cursor:pointer;
    transition:all .15s;
    border:2px solid transparent;
}
.emoji-option:hover{background:#444;transform:scale(1.1)}
.emoji-option.selected{
    border-color:var(--accent);
    background:linear-gradient(135deg,var(--accentA15),var(--accent2A15));
}

/* ANCHOR: RESPONSIVE */
@media(max-width:500px){
    .emoji-grid{grid-template-columns:repeat(6,1fr)}
}

.team-card input{
    width:100%;
    padding:clamp(8px,1.2vmin,12px);
    font-size:clamp(0.9rem,2vmin,1.2rem);
    border-radius:clamp(6px,1vmin,10px);
    border:2px solid #333;
    text-align:center;
    background:#333;
    color:#fff;
    -webkit-appearance:none;
    appearance:none;
    transition:border-color .2s;
}
.team-card input:focus{
    outline:none;
    border-color:var(--accent);
}
.team-card.red input:focus{
    border-color:var(--accent);
}
.team-card.blue input:focus{
    border-color:var(--accent2);
}
.game-settings{background:#1a1a1a;border-radius:clamp(8px,1.2vmin,15px);padding:clamp(12px,2vmin,25px);margin-bottom:2vh;overflow:hidden}
.game-settings h3{color:#FF9800;margin-bottom:clamp(10px,1.5vmin,15px);font-size:clamp(1rem,2.2vmin,1.4rem)}
.setting-row{display:flex;justify-content:space-between;align-items:center;margin:6px 0;padding:clamp(8px,1.2vmin,12px);background:#2a2a2a;border-radius:clamp(6px,1vmin,10px);flex-wrap:wrap;gap:8px;box-sizing:border-box;max-width:100%}
.setting-row label{font-size:clamp(0.85rem,2vmin,1.2rem);color:#ccc}
.setting-row input,.setting-row select{
    padding:clamp(6px,1vmin,10px);
    font-size:clamp(0.85rem,1.8vmin,1.1rem);
    border-radius:clamp(4px,0.6vmin,8px);
    border:2px solid #333;
    background:#333;
    color:#fff;
    min-width:80px;
    max-width:120px;
    text-align:center;
    -webkit-appearance:none;
    appearance:none;
    transition:border-color .2s;
}
.setting-row input:focus,.setting-row select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 1px var(--accent2);
}

/* Toggle switch */

/* Keymode toggle (custom colors) */
.keymode-toggle{
    display:flex;
    align-items:center;
    gap:clamp(8px,1.5vmin,12px);
}
.keymode-label{
    font-size:clamp(1.2rem,3vmin,1.8rem);
    opacity:0.5;
    transition:opacity .3s;
}
.keymode-label.left.active,
.keymode-label.right.active{
    opacity:1;
}
.keymode-switch .slider{
    background:#2a4d6e;
    border-color:#3498db;
}
.keymode-switch input:checked + .slider{
    background:rgba(255,152,0,.15);
    border-color:#FF9800;
}
.keymode-switch input:checked + .slider:before{
    background:#FF9800;
}

.card-reveal-switch .slider{
    background:#2d5016;
    border-color:#4CAF50;
}
.card-reveal-switch input:checked + .slider{
    background:rgba(156,39,176,.15);
    border-color:#9C27B0;
}
.card-reveal-switch input:checked + .slider:before{
    background:#9C27B0;
}
.card-reveal-label{
    font-size:clamp(1rem,2.5vmin,1.5rem)!important;
}


/* Style picker */

/* ANCHOR: TOGGLE_SWITCH (slider on/off) */
.switch{position:relative;display:inline-block;width:56px;height:30px;flex:0 0 auto}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;inset:0;cursor:pointer;background:#3a3a3a;transition:.2s;border-radius:999px;border:2px solid #555}
.slider:before{content:"";position:absolute;height:22px;width:22px;left:4px;top:50%;transform:translateY(-50%);background:#fff;transition:.2s;border-radius:50%}
.switch input:checked + .slider{background:var(--accentA15);border-color:var(--accent)}
.switch input:checked + .slider:before{transform:translate(26px,-50%);background:var(--accent)}

button{padding:clamp(10px,2vh,20px) clamp(20px,3vw,40px);font-size:clamp(1rem,2.5vmin,1.5rem);border:none;border-radius:clamp(8px,1vmin,15px);font-weight:bold;cursor:pointer;transition:transform .14s, box-shadow .14s}
button:active{transform:scale(.995)}

/* ANCHOR: BUTTONS_POLISH (subtelna głębia — bez połysku) */
:where(.btn-new,.btn-primary,.btn-reset,.btn-ghost,.btn-back){border:1px solid var(--btnLine);box-shadow:var(--btnInset),var(--btnShadow)}
:where(.btn-new,.btn-primary,.btn-reset,.btn-ghost,.btn-back):hover{box-shadow:var(--btnInset),var(--btnShadowHover);transform:translateY(-.5px)}
:where(.btn-new,.btn-primary,.btn-reset,.btn-ghost,.btn-back):active{transform:translateY(0) scale(.99)}

.btn-new,.btn-primary{background:var(--accent);color:#fff;transition:transform .14s, box-shadow .14s, filter .14s}
.btn-new:hover,.btn-primary:hover{filter:brightness(1.1)}

/* ANCHOR: BTN_BACK (powrót — nie jest akcją destrukcyjną) */
.btn-back{background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.06));color:#fff;border-color:rgba(52,152,219,.75)}
.btn-back:hover{background:linear-gradient(180deg,rgba(52,152,219,.92),rgba(52,152,219,.78));color:#fff}

.btn-reset{background:var(--danger);color:#fff;border-color:rgba(255,255,255,.08)}
.btn-reset:hover{background:var(--dangerHover)}

.btn-key{background:#FF9800;color:#fff;border-color:rgba(255,255,255,.08)}
.btn-key:hover{background:#F57C00}

.btn-ghost{background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.06));color:#fff;border-color:rgba(255,255,255,.16)}
.btn-ghost:hover{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.22)}

.btn-lg{font-size:clamp(1.1rem,2.6vmin,1.35rem)}

/* ANCHOR: UTIL_LAYOUT (bez inline styles) */
.settings-container--sm{max-width:500px;width:min(500px,92vw)}
.game-settings--flush{margin-bottom:0}
.setting-row--compact{margin:0 0 10px}
.setting-row--last{margin:0}

/* PIN OVERLAY */
.pin-display{
    font-size:clamp(2.5rem,8vmin,4rem);
    font-weight:bold;
    letter-spacing:clamp(8px,2vmin,15px);
    color:#4CAF50;
    padding:clamp(10px,2vmin,15px) clamp(15px,3vmin,25px);
    text-align:center;
    font-family:'Courier New',monospace;
    display:inline-block;
    padding-right:calc(clamp(15px,3vmin,25px) - clamp(8px,2vmin,15px));
}
.pin-input-section{
    background:#1a1a1a;
    padding:clamp(15px,2.5vmin,25px);
    border-radius:clamp(10px,1.5vmin,20px);
    margin-top:clamp(10px,2vmin,20px);
}
.pin-input-container{
    display:flex;
    flex-direction:column;
    align-items:center;
}
#pinInput{
    font-size:clamp(2rem,6vmin,3rem);
    font-weight:bold;
    letter-spacing:clamp(8px,2vmin,15px);
    text-align:center;
    width:clamp(150px,40vmin,200px);
    padding:clamp(10px,2vmin,15px);
    border:3px solid #555;
    border-radius:clamp(8px,1vmin,12px);
    background:#2a2a2a;
    color:#fff;
    font-family:'Courier New',monospace;
    transition:border-color .2s;
}
#pinInput:focus{
    outline:none;
    border-color:#FF9800;
}
#pinInput.error{
    border-color:#e74c3c;
    animation:shake 0.3s;
}
#pinInput.success{
    border-color:#4CAF50;
}

#captainPinInput{
    font-size:clamp(2rem,7vmin,3.5rem);
    font-weight:bold;
    letter-spacing:clamp(5px,1.5vmin,12px);
    text-align:center;
    width:clamp(180px,50vmin,250px);
    padding:clamp(12px,2.5vmin,20px) clamp(15px,3vmin,30px);
    border:3px solid #4CAF50;
    border-radius:clamp(10px,1.5vmin,20px);
    background:#1a1a1a;
    color:#4CAF50;
    font-family:'Courier New',monospace;
    transition:border-color .2s, color .2s;
}
#captainPinInput::placeholder{
    color:#2d5a2d;
}
#captainPinInput:focus{
    outline:none;
    border-color:#5ddb5d;
    color:#5ddb5d;
}
#captainPinInput.error{
    border-color:#e74c3c;
    color:#e74c3c;
    animation:shake 0.3s;
}
#captainPinInput.success{
    border-color:#4CAF50;
    color:#4CAF50;
}
.pin-error{
    color:#e74c3c;
    font-size:clamp(0.85rem,2vmin,1rem);
    margin-top:10px;
    display:none;
}
.pin-error.visible{
    display:block;
}
@keyframes shake{
    0%,100%{transform:translateX(0)}
    25%{transform:translateX(-10px)}
    75%{transform:translateX(10px)}
}

/* ASSASSIN OVERLAY */
.assassin-container{
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:clamp(20px,4vmin,40px);
    max-width:min(500px,90vw);
}
.assassin-skull{
    font-size:clamp(4rem,15vmin,10rem);
    animation:assassinPulse 1s ease-in-out infinite, assassinFloat 3s ease-in-out infinite;
    filter:drop-shadow(0 0 20px rgba(255,0,0,0.5));
}
.assassin-title{
    font-size:clamp(2.5rem,8vmin,5rem);
    color:#e74c3c;
    text-shadow:0 0 20px rgba(231,76,60,0.8), 0 0 40px rgba(231,76,60,0.5);
    margin:clamp(10px,2vmin,20px) 0;
    letter-spacing:0.1em;
    animation:assassinGlow 1.5s ease-in-out infinite alternate;
}
.assassin-subtitle{
    font-size:clamp(1rem,3vmin,1.5rem);
    color:#aaa;
    margin-bottom:clamp(15px,3vmin,30px);
    text-align:center;
}
.assassin-question{
    font-size:clamp(1.1rem,3vmin,1.6rem);
    color:#fff;
    margin-bottom:clamp(20px,4vmin,35px);
    text-align:center;
}
.assassin-buttons{
    display:flex;
    gap:clamp(15px,3vmin,30px);
    flex-wrap:wrap;
    justify-content:center;
}
.assassin-btn{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:clamp(8px,1.5vmin,15px);
    padding:clamp(15px,3vmin,30px) clamp(25px,5vmin,50px);
    border-radius:clamp(12px,2vmin,20px);
    border:3px solid;
    cursor:pointer;
    transition:all .2s;
    min-width:clamp(120px,25vmin,180px);
}
.assassin-btn.red{
    background:linear-gradient(145deg,rgba(231,76,60,0.2),rgba(231,76,60,0.1));
    border-color:#e74c3c;
}
.assassin-btn.blue{
    background:linear-gradient(145deg,rgba(52,152,219,0.2),rgba(52,152,219,0.1));
    border-color:#3498db;
}
.assassin-btn:hover{
    transform:scale(1.05);
}
.assassin-btn.red:hover{
    background:linear-gradient(145deg,rgba(231,76,60,0.4),rgba(231,76,60,0.2));
    box-shadow:0 0 30px rgba(231,76,60,0.5);
}
.assassin-btn.blue:hover{
    background:linear-gradient(145deg,rgba(52,152,219,0.4),rgba(52,152,219,0.2));
    box-shadow:0 0 30px rgba(52,152,219,0.5);
}
.assassin-btn-emoji{
    font-size:clamp(2rem,6vmin,4rem);
}
.assassin-btn-text{
    font-size:clamp(1rem,2.5vmin,1.5rem);
    font-weight:bold;
    color:#fff;
}

@keyframes assassinPulse{
    0%,100%{transform:scale(1)}
    50%{transform:scale(1.1)}
}
@keyframes assassinFloat{
    0%,100%{transform:translateY(0) scale(1)}
    25%{transform:translateY(-10px) scale(1.05)}
    75%{transform:translateY(5px) scale(0.98)}
}
@keyframes assassinGlow{
    0%{text-shadow:0 0 20px rgba(231,76,60,0.8), 0 0 40px rgba(231,76,60,0.5)}
    100%{text-shadow:0 0 30px rgba(231,76,60,1), 0 0 60px rgba(231,76,60,0.8), 0 0 80px rgba(231,76,60,0.5)}
}

/* CAPTAIN KEY */
.home-bottom-buttons{
    display:flex;
    gap:clamp(10px,2vmin,20px);
    margin-top:clamp(20px,4vmin,40px);
    flex-wrap:wrap;
    justify-content:center;
}
.home-btn{
    background:transparent;
    border:2px solid;
    padding:clamp(10px,1.8vmin,16px) clamp(18px,3vmin,30px);
    font-size:clamp(0.85rem,2.2vmin,1.1rem);
    border-radius:clamp(8px,1.2vmin,12px);
    cursor:pointer;
    transition:all .2s;
    font-weight:500;
}
.home-btn:hover{
    transform:scale(1.05);
}
.home-btn.hub-btn{
    border-color:#888;
    color:#888;
}
.home-btn.hub-btn:hover{
    background:#888;
    color:#fff;
}
.home-btn.captain-btn{
    border-color:#FF9800;
    color:#FF9800;
}
.home-btn.captain-btn:hover{
    background:#FF9800;
    color:#fff;
}
.home-btn.settings-btn{
    border-color:#3498db;
    color:#3498db;
}
.home-btn.settings-btn:hover{
    background:#3498db;
    color:#fff;
}
.captain-board-container{
    max-width:min(500px,95vw)!important;
    width:95vw!important;
    padding:clamp(10px,2vmin,25px)!important;
    max-height:95vh;
    overflow-y:auto;
}
.captain-starter{
    margin-bottom:clamp(8px,1.5vmin,15px);
}
.starter-info{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:clamp(8px,1.5vmin,15px);
    padding:clamp(8px,1.5vmin,12px) clamp(12px,2vmin,20px);
    background:rgba(0,0,0,0.3);
    border-radius:clamp(8px,1vmin,12px);
    border:2px solid;
    flex-wrap:wrap;
}
.starter-label{
    font-size:clamp(0.85rem,2vmin,1rem);
    color:#aaa;
}
.starter-team{
    font-size:clamp(1rem,2.5vmin,1.3rem);
    font-weight:bold;
}
.starter-counts{
    display:flex;
    align-items:center;
    gap:clamp(5px,1vmin,10px);
    font-size:clamp(0.9rem,2.2vmin,1.1rem);
    font-weight:bold;
    padding-left:clamp(8px,1.5vmin,15px);
    border-left:1px solid #444;
}
.captain-board{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:clamp(3px,1vmin,8px);
    margin:clamp(8px,1.5vmin,15px) 0;
    width:100%;
}
.captain-card{
    aspect-ratio:1;
    border-radius:clamp(4px,0.8vmin,10px);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:clamp(0.5rem,2.5vmin,0.9rem);
    font-weight:bold;
    text-transform:uppercase;
    padding:clamp(2px,0.5vmin,6px);
    text-align:center;
    word-break:break-word;
    line-height:1.1;
    color:#fff;
    text-shadow:1px 1px 2px rgba(0,0,0,0.5);
    overflow:hidden;
}
.captain-card.is-red{background:#e74c3c}
.captain-card.is-blue{background:#3498db}
.captain-card.is-neutral{background:#7f8c8d}
.captain-card.is-assassin{background:#1a1a1a;color:#e74c3c}
.captain-legend{
    display:flex;
    justify-content:center;
    gap:clamp(10px,2vmin,20px);
    flex-wrap:wrap;
    margin-top:clamp(10px,2vmin,15px);
}
.legend-item{
    display:flex;
    align-items:center;
    gap:5px;
    font-size:clamp(0.75rem,1.8vmin,0.95rem);
    color:#aaa;
}
.legend-color{
    width:clamp(12px,2vmin,18px);
    height:clamp(12px,2vmin,18px);
    border-radius:4px;
}
.legend-color.red{background:#e74c3c}
.legend-color.blue{background:#3498db}
.legend-color.neutral{background:#7f8c8d}
.legend-color.assassin{background:#1a1a1a;border:1px solid #e74c3c}

#endText{font-size:clamp(2rem,6vmin,5rem);margin-bottom:3vh}
.confetti{position:fixed;top:-20px;pointer-events:none;z-index:9999}

/* END OVERLAY */
.end-container{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:clamp(15px,3vmin,30px);
    padding:clamp(20px,4vmin,50px);
    max-width:min(600px,90vw);
}
.end-result{
    font-size:clamp(1.2rem,4vmin,2.5rem);
    font-weight:bold;
    text-align:center;
    padding:clamp(10px,2vmin,20px) clamp(20px,4vmin,40px);
    border-radius:clamp(10px,1.5vmin,20px);
    background:rgba(255,255,255,0.1);
}
.end-result.win-red{color:#e74c3c;border:2px solid #e74c3c}
.end-result.win-blue{color:#3498db;border:2px solid #3498db}
.end-result.assassin{color:#aaa;border:2px solid #1a1a1a;background:rgba(0,0,0,0.3)}
.end-result.match-won{
    font-size:clamp(1.5rem,5vmin,3rem);
    background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,215,0,0.05));
    border:2px solid gold;
    color:gold;
}
.end-scores{
    display:flex;
    align-items:center;
    gap:clamp(15px,3vmin,40px);
    margin:clamp(10px,2vmin,20px) 0;
}
.end-team{
    display:flex;
    align-items:center;
    gap:clamp(8px,1.5vmin,15px);
    padding:clamp(10px,2vmin,20px) clamp(15px,3vmin,30px);
    border-radius:clamp(10px,1.5vmin,20px);
    background:rgba(0,0,0,0.3);
}
.end-team.red{border:2px solid #e74c3c}
.end-team.blue{border:2px solid #3498db}
.end-emoji{font-size:clamp(1.5rem,4vmin,3rem)}
.end-name{font-size:clamp(0.9rem,2vmin,1.3rem);font-weight:bold}
.end-team.red .end-name{color:#e74c3c}
.end-team.blue .end-name{color:#3498db}
.end-score{
    font-size:clamp(2rem,6vmin,4rem);
    font-weight:bold;
    min-width:clamp(50px,8vmin,80px);
    text-align:center;
    padding:clamp(5px,1vmin,10px) clamp(10px,2vmin,20px);
    border-radius:clamp(8px,1vmin,15px);
}
.end-team.red .end-score{background:#e74c3c}
.end-team.blue .end-score{background:#3498db}
.end-vs{
    font-size:clamp(1.2rem,3vmin,2rem);
    font-weight:bold;
    color:#666;
}
.end-target{
    font-size:clamp(0.9rem,2vmin,1.2rem);
    color:#888;
}
.btn-next{
    font-size:clamp(1.1rem,3vmin,1.8rem)!important;
    padding:clamp(12px,2.5vmin,25px) clamp(30px,6vmin,60px)!important;
    margin-top:clamp(10px,2vmin,20px);
}
.btn-menu{
    margin-top:clamp(5px,1vmin,10px);
}

@media(max-width:500px){
.end-scores{flex-direction:column;gap:10px}
.end-team{width:100%;justify-content:space-between}
.end-vs{display:none}
.settings-container{padding:12px;max-height:95vh;width:98%}
.settings-title{font-size:1.3rem;margin-bottom:10px}
.team-card{padding:10px}
.team-card h3{font-size:0.95rem;margin-bottom:8px}
.avatar-picker{gap:4px}
.avatar-option{font-size:1.1rem;border-radius:6px}
.team-card input{padding:8px;font-size:0.9rem}
.game-settings{padding:10px}
.game-settings h3{font-size:0.95rem;margin-bottom:8px}
.setting-row{padding:8px;margin:5px 0}
.setting-row label{font-size:0.85rem}
.picker-option{min-width:36px;height:36px;font-size:0.9rem}
.rounds-option{width:36px;height:36px;font-size:1rem}
.style-option{padding:8px}
.preview-card{width:30px;height:40px;font-size:0.4rem}
.style-name{font-size:0.8rem}
.deck-option{padding:10px}
.deck-title{font-size:0.9rem}
.deck-desc{font-size:0.75rem}
.button-group{gap:8px;margin-top:10px}
.button-group button{padding:12px 15px}
}

/* MAŁE EKRANY (telefony) */
@media(max-width:600px){
.top-bar{flex-wrap:wrap;padding:5px 10px;gap:5px}
.team-bar{max-width:100%;flex:1 1 45%;padding:8px 10px;gap:5px}
.team-bar .team-name{display:none}
.top-controls{order:-1;width:100%;justify-content:center;margin-bottom:5px}
.icon-btn{width:45px;height:45px}
.bottom-bar{flex-wrap:wrap;padding:5px;gap:5px}
.remaining-cards{max-width:42%}
.remaining-card{width:24px;height:32px}
.remaining-card .card-emoji{font-size:0.7rem}
.remaining-card .card-num{font-size:0.6rem}
#status{font-size:0.8rem;order:-1;width:100%;text-align:center;padding:3px 0}
.settings-container{padding:10px;border-radius:12px}
.team-setup{gap:10px}
.avatar-option{border-width:2px}
.style-picker{gap:8px;padding:8px}
.picker-panel{padding:10px}
.rounds-picker{padding:10px}
.deck-picker{padding:10px}
}

/* TABLETY (iPad) */
@media(min-width:601px) and (max-width:1024px){
.remaining-card{width:clamp(26px,3.5vmin,45px);height:clamp(34px,4.5vmin,58px)}
.remaining-card .card-emoji{font-size:clamp(0.75rem,1.8vmin,1.3rem)}
.remaining-card .card-num{font-size:clamp(0.6rem,1.3vmin,1rem)}
.remaining-cards{gap:clamp(2px,0.3vmin,5px)}
}

/* BARDZO MAŁE EKRANY */
@media(max-height:500px){
.top-bar{padding:3px 10px}
.team-bar{padding:5px 8px}
.bottom-bar{padding:3px 10px}
.remaining-card{width:22px;height:30px}
.remaining-card .card-emoji{font-size:0.65rem}
.remaining-card .card-num{font-size:0.55rem}
#status{font-size:0.75rem}
.board-container{padding:3px}
}

/* DUŻE EKRANY (TV) */
@media(min-width:1400px) and (min-height:900px){
.card{font-size:clamp(24px,4.5vmin,60px)}
.icon-btn{width:clamp(60px,7vmin,90px);height:clamp(60px,7vmin,90px);font-size:clamp(2rem,4vmin,3.5rem)}
}

/* ANCHOR: CAPTAIN_KEY_UI */
/* SYSTEM POKOI / LOBBY */
.room-container{
    background:#2a2a2a;
    border-radius:clamp(15px,2vmin,25px);
    padding:clamp(20px,4vmin,40px);
    max-width:min(500px,90vw);
    width:90%;
}
.room-title{
    font-size:clamp(1.5rem,4vmin,2.5rem);
    margin-bottom:clamp(15px,3vmin,25px);
    background:linear-gradient(135deg,#e74c3c,#3498db);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
}
.room-code-display{
    font-size:clamp(2.5rem,8vmin,4rem);
    font-weight:bold;
    letter-spacing:0.3em;
    padding:clamp(15px,3vmin,25px);
    background:#1a1a1a;
    border-radius:clamp(10px,1.5vmin,15px);
    margin:clamp(15px,3vmin,25px) 0;
    font-family:'Courier New',monospace;
    color:#4CAF50;
    border:2px solid #4CAF50;
}
.room-input{
    width:100%;
    padding:clamp(12px,2vmin,18px);
    font-size:clamp(1.2rem,3vmin,1.8rem);
    border-radius:clamp(8px,1vmin,12px);
    border:2px solid #444;
    background:#1a1a1a;
    color:#fff;
    text-align:center;
    letter-spacing:0.2em;
    font-family:'Courier New',monospace;
    margin-bottom:clamp(10px,2vmin,15px);
    text-transform:uppercase;
}
.room-input:focus{
    outline:none;
    border-color:#4CAF50;
}
.room-input::placeholder{
    color:#666;
    letter-spacing:normal;
}
.pin-input{
    width:100%;
    padding:clamp(12px,2vmin,18px);
    font-size:clamp(1.5rem,4vmin,2rem);
    border-radius:clamp(8px,1vmin,12px);
    border:2px solid #444;
    background:#1a1a1a;
    color:#fff;
    text-align:center;
    letter-spacing:0.5em;
    font-family:'Courier New',monospace;
    margin-bottom:clamp(10px,2vmin,15px);
}
.pin-input:focus{
    outline:none;
    border-color:#FF9800;
}
.room-buttons{
    display:flex;
    flex-direction:column;
    gap:clamp(10px,2vmin,15px);
    margin-top:clamp(15px,3vmin,20px);
}
.room-btn{
    padding:clamp(12px,2vmin,18px) clamp(20px,4vmin,30px);
    font-size:clamp(1rem,2.5vmin,1.3rem);
    font-weight:bold;
    border:none;
    border-radius:clamp(8px,1vmin,12px);
    cursor:pointer;
    transition:all .2s;
}
.room-btn:hover{transform:scale(1.02)}
.room-btn.primary{background:#4CAF50;color:#fff}
.room-btn.secondary{background:#333;color:#aaa}
.room-btn.secondary:hover{background:#444;color:#fff}
.room-btn.danger{background:#e74c3c;color:#fff}
.room-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.room-status{
    font-size:clamp(0.9rem,2vmin,1.1rem);
    color:#888;
    margin:clamp(10px,2vmin,15px) 0;
}
.room-status.error{color:#e74c3c}
.room-status.success{color:#4CAF50}
.room-divider{
    display:flex;
    align-items:center;
    margin:clamp(15px,3vmin,25px) 0;
    color:#666;
    font-size:clamp(0.9rem,2vmin,1.1rem);
}
.room-divider::before,.room-divider::after{
    content:'';
    flex:1;
    height:1px;
    background:#444;
}
.room-divider span{
    padding:0 clamp(10px,2vmin,15px);
}
.room-players{
    background:#1a1a1a;
    border-radius:clamp(8px,1vmin,12px);
    padding:clamp(10px,2vmin,15px);
    margin:clamp(10px,2vmin,15px) 0;
    text-align:left;
}
.room-player{
    display:flex;
    align-items:center;
    gap:clamp(8px,1.5vmin,12px);
    padding:clamp(6px,1vmin,10px) 0;
    border-bottom:1px solid #333;
}
.room-player:last-child{border-bottom:none}
.room-player-icon{font-size:clamp(1.2rem,3vmin,1.8rem)}
.room-player-name{flex:1;color:#ccc}
.room-player-role{
    font-size:clamp(0.75rem,1.8vmin,0.9rem);
    padding:clamp(3px,0.5vmin,5px) clamp(8px,1vmin,12px);
    border-radius:clamp(4px,0.6vmin,6px);
    font-weight:bold;
}
.room-player-role.captain{background:#FF9800;color:#fff}
.room-player-role.player{background:#333;color:#888}
.copy-btn{
    background:none;
    border:none;
    font-size:clamp(1.2rem,3vmin,1.5rem);
    cursor:pointer;
    padding:clamp(5px,1vmin,10px);
    opacity:0.7;
    transition:opacity .2s;
}
.copy-btn:hover{opacity:1}
</style>
</head>
<body>

<div class="overlay" id="homeScreen" style="display:flex">
<div class="home-container">
<h1 class="home-title">TAJNIACY</h1>
<div class="mode-selection">
<div class="mode-card classic">
<div class="mode-header" onclick="toggleModeCard(this.parentElement)">
<div class="mode-icon">🎲</div>
<div class="mode-title-wrapper">
<div class="mode-title">KLASYCZNA</div>
</div>
<div class="mode-arrow">▼</div>
</div>
<div class="mode-content">
<div class="mode-content-inner">
<div class="mode-details">
<div class="mode-description">Szybki start z tradycyjnymi zasadami</div>
<ul class="mode-features"><li>Standardowa plansza 5x5</li><li>1 zabójca, 7 neutralnych</li><li>8/9 agentów</li></ul>
</div>
<div class="mode-buttons">
<button class="mode-btn info" onclick="event.stopPropagation();showRules('classic')">i</button>
<button class="mode-btn play" onclick="event.stopPropagation();selectMode('classic')">▶</button>
</div>
</div>
</div>
</div>
<div class="mode-card crazy">
<div class="mode-header" onclick="toggleModeCard(this.parentElement)">
<div class="mode-icon">🎪</div>
<div class="mode-title-wrapper">
<div class="mode-title">SZALONA</div>
</div>
<div class="mode-arrow">▼</div>
</div>
<div class="mode-content">
<div class="mode-content-inner">
<div class="mode-details">
<div class="mode-description">Więcej zabójców, więcej emocji!</div>
<ul class="mode-features"><li>Od 1 do 7 zabójców</li><li>Mniej neutralnych kart</li><li>Wybierz kto zaczyna</li></ul>
</div>
<div class="mode-buttons">
<button class="mode-btn info" onclick="event.stopPropagation();showRules('crazy')">i</button>
<button class="mode-btn play" onclick="event.stopPropagation();selectMode('crazy')">▶</button>
</div>
</div>
</div>
</div>
<div class="mode-card wip">
<div class="mode-header" onclick="toggleModeCard(this.parentElement)">
<div class="mode-icon">⚡</div>
<div class="mode-title-wrapper">
<div class="mode-title">RUSH</div>
<div class="mode-wip-badge">WIP</div>
</div>
<div class="mode-arrow">▼</div>
</div>
<div class="mode-content">
<div class="mode-content-inner">
<div class="mode-details">
<div class="mode-description">Wyścig z czasem!</div>
<ul class="mode-features"><li>Limit czasu na turę</li><li>Bonusy za szybkie odpowiedzi</li><li>Tryb błyskawiczny</li></ul>
</div>
<div class="mode-buttons">
<button class="mode-btn info" onclick="event.stopPropagation()">i</button>
<button class="mode-btn play disabled" onclick="event.stopPropagation()">▶</button>
</div>
</div>
</div>
</div>
</div>
<div class="home-bottom-buttons">
<button class="home-btn hub-btn" onclick="goToHub()">← PartyHUB</button>
<button class="home-btn captain-btn" onclick="showCaptainKeyOverlay()">🔑 Klucz kapitana</button>
<button class="home-btn settings-btn" onclick="showGlobalSettings()">⚙️ Ustawienia</button>
</div>
<div class="home-version">Wersja: beta 1.0</div>
</div>
</div>

<div class="overlay" id="rulesOverlay">
<div class="rules-container">
<h2 class="rules-title" id="rulesTitle">Zasady gry</h2>
<div class="rules-content scroll-surface" id="rulesContent"></div>
<button class="btn-new" onclick="hideO('rulesOverlay')">Rozumiem</button>
</div>
</div>

<div class="overlay" id="globalSettingsOverlay">
<div class="settings-container settings-container--sm scroll-surface">
<h2 class="settings-title">⚙️ Ustawienia</h2>
<div class="game-settings game-settings--flush">
<div class="setting-row setting-row--compact">
<label>Dźwięki:</label>
<label class="switch">
<input type="checkbox" id="globalSoundToggle" onchange="updateSound(this.checked)">
<span class="slider"></span>
</label>
</div>
<div class="setting-row setting-row--compact">
<label>Odkrywanie kart:</label>
<div class="keymode-toggle">
<span class="keymode-label left card-reveal-label" title="Kliknięcie">👆</span>
<label class="switch keymode-switch card-reveal-switch">
<input type="checkbox" id="globalCardRevealToggle" onchange="updateCardRevealMode(this.checked)">
<span class="slider"></span>
</label>
<span class="keymode-label right card-reveal-label" title="Przytrzymanie">👇</span>
</div>
</div>

<div class="settings-accordion">
<!-- ANCHOR: STYLE_CARD -->
<div class="setting-card" id="cardGlobalStyle">
<div class="setting-head" onclick="toggleSettingCard('cardGlobalStyle')">
<div class="setting-title">Styl kart</div>
<div class="setting-sub" id="globalStyleSummary">Białe</div>
<div class="setting-arrow">▼</div>
</div>
<div class="setting-body">
<div class="setting-body-inner">
<div class="deck-picker-content">
<div class="style-option selected" data-style="white" onclick="selectStyle('global', 'white')">
<div class="style-preview deck-white">
<div class="preview-card">Agent</div>
<div class="preview-card revealed is-red">Red</div>
<div class="preview-card revealed is-blue">Blue</div>
</div>
<span class="style-name">Białe</span>
</div>
<div class="style-option" data-style="classic" onclick="selectStyle('global', 'classic')">
<div class="style-preview deck-classic">
<div class="preview-card">Agent</div>
<div class="preview-card revealed is-red">Red</div>
<div class="preview-card revealed is-blue">Blue</div>
</div>
<span class="style-name">Ciemne</span>
</div>
<div class="style-option" data-style="night" onclick="selectStyle('global', 'night')">
<div class="style-preview deck-night">
<div class="preview-card">Agent</div>
<div class="preview-card revealed is-red">Red</div>
<div class="preview-card revealed is-blue">Blue</div>
</div>
<span class="style-name">Noc</span>
</div>
</div>
<input type="hidden" id="globalStyle" value="white">
</div>
</div>
</div>

</div>

<div class="setting-row setting-row--last" style="margin-top:15px">
<label>Wersja:</label>
<span style="color:#888;font-size:0.9rem">1.0.0</span>
</div>
</div>
<button class="btn-new" onclick="hideO('globalSettingsOverlay')" style="margin-top:20px;width:100%">Zamknij</button>
</div>
</div>

<div class="overlay" id="classicSettings">
<div class="settings-container scroll-surface">
<h2 class="settings-title">Tryb Klasyczny</h2>

<!-- ANCHOR: TEAMS (zawsze widoczne) -->
<div class="team-setup">
<div class="team-card red">
<h3>Drużyna Czerwona</h3>
<div class="avatar-picker" id="classicRedPicker"></div>
<input id="classicRedName" value="Czerwoni" placeholder="Nazwa drużyny">
</div>
<div class="team-card blue">
<h3>Drużyna Niebieska</h3>
<div class="avatar-picker" id="classicBluePicker"></div>
<input id="classicBlueName" value="Niebiescy" placeholder="Nazwa drużyny">
</div>
</div>

<div class="settings-accordion">
<!-- ANCHOR: CARD_DECK -->
<div class="setting-card" id="cardClassicDeck">
<div class="setting-head" onclick="toggleSettingCard('cardClassicDeck')">
<div class="setting-title">Talia kart</div>
<div class="setting-sub" id="classicDeckSummary">Standardowa</div>
<div class="setting-arrow">▼</div>
</div>
<div class="setting-body">
<div class="setting-body-inner">
<div class="deck-picker-content">
<div class="deck-option selected" data-deck="standard" onclick="selectDeck('classic', 'standard')">
<div class="deck-info">
<span class="deck-title">Standardowa</span>
<span class="deck-desc">Klasyczne hasła odpowiednie dla wszystkich. Bezpieczne i rodzinne.<br><span class="deck-counter" id="classicStandardCounter">Pozostało unikalnych haseł: 124/124</span></span>
</div>
</div>
<div class="deck-option" data-deck="adult" onclick="selectDeck('classic', 'adult')">
<div class="deck-info">
<span class="deck-title">Bez cenzury (+18)</span>
<span class="deck-desc">Hasła pikantne i kontrowersyjne – tylko dla dorosłych.<br><span class="deck-counter" id="classicAdultCounter">Pozostało unikalnych haseł: 51/51</span></span>
</div>
</div>
</div>
</div>
<div class="deck-actions">
<button class="btn-deck-action" onclick="setMixedDeck('classic')" title="Mieszanka 13 kart Bez cenzury + 12 Standardowych">
<span class="deck-action-icon">🎲</span>
<span class="deck-action-text">50/50 Mix</span>
</button>
<button class="btn-deck-action" onclick="resetWordPool('classic')" title="Przywróć wszystkie hasła do puli">
<span class="deck-action-icon">🔄</span>
<span class="deck-action-text">Reset puli</span>
</button>
</div>
<input type="hidden" id="classicDeck" value="standard">
</div>
</div>
</div>
<!-- ANCHOR: CARD_GAME_SETTINGS -->
<div class="setting-card" id="cardClassicGame">
<div class="setting-head" onclick="toggleSettingCard('cardClassicGame')">
<div class="setting-title">Ustawienia gry</div>
<div class="setting-sub" id="classicGameSummary">3 rundy, Podgląd</div>
<div class="setting-arrow">▼</div>
</div>
<div class="setting-body">
<div class="setting-body-inner">
<div class="rounds-picker-content">
<label style="display:block;margin-bottom:8px;color:#ccc">Rundy do wygranej:</label>
<div class="rounds-options">
<div class="rounds-option" data-rounds="1" onclick="selectRounds('classic', '1')">1</div>
<div class="rounds-option" data-rounds="2" onclick="selectRounds('classic', '2')">2</div>
<div class="rounds-option selected" data-rounds="3" onclick="selectRounds('classic', '3')">3</div>
<div class="rounds-option" data-rounds="4" onclick="selectRounds('classic', '4')">4</div>
<div class="rounds-option" data-rounds="5" onclick="selectRounds('classic', '5')">5</div>
<div class="rounds-option custom" data-rounds="custom" onclick="selectRounds('classic', 'custom')">...</div>
</div>
<div class="rounds-custom" id="classicRoundsCustom" style="display:none">
<label>Własna liczba:</label>
<div class="custom-input-group">
<button class="custom-btn" onclick="adjustCustomRounds('classic', -1)">−</button>
<input type="number" id="classicRoundsInput" min="6" max="99" value="6" onchange="updateCustomRounds('classic')">
<button class="custom-btn" onclick="adjustCustomRounds('classic', 1)">+</button>
</div>
</div>
</div>
<input type="hidden" id="classicWinTarget" value="3">
<div class="setting-row" style="margin-top:15px">
<label>Tryb klucza:</label>
<div class="keymode-toggle">
<span class="keymode-label left">👁️</span>
<label class="switch keymode-switch">
<input type="checkbox" id="classicKeyModeToggle" onchange="updateKeyMode('classic', this.checked)">
<span class="slider"></span>
</label>
<span class="keymode-label right">🔑</span>
</div>
<input type="hidden" id="classicKeyMode" value="preview">
</div>
</div>
</div>
</div>

<div class="button-group">
<button class="btn-back" onclick="backToHome()" style="flex:1">← Powrót</button>
<button class="btn-new btn-lg" onclick="startClassic()" style="flex:2">Start</button>
</div>
</div>
</div>

<div class="overlay" id="crazySettings">
<div class="settings-container scroll-surface">
<h2 class="settings-title">Tryb Szalony</h2>

<!-- ANCHOR: TEAMS (zawsze widoczne) -->
<div class="team-setup">
<div class="team-card red">
<h3>Drużyna Czerwona</h3>
<div class="avatar-picker" id="crazyRedPicker"></div>
<input id="crazyRedName" value="Czerwoni" placeholder="Nazwa drużyny">
</div>
<div class="team-card blue">
<h3>Drużyna Niebieska</h3>
<div class="avatar-picker" id="crazyBluePicker"></div>
<input id="crazyBlueName" value="Niebiescy" placeholder="Nazwa drużyny">
</div>
</div>

<div class="settings-accordion">

<!-- ANCHOR: CARD_DECK -->
<div class="setting-card" id="cardCrazyDeck">
<div class="setting-head" onclick="toggleSettingCard('cardCrazyDeck')">
<div class="setting-title">Talia kart</div>
<div class="setting-sub" id="crazyDeckSummary">Standardowa</div>
<div class="setting-arrow">▼</div>
</div>
<div class="setting-body">
<div class="setting-body-inner">
<div class="deck-picker-content">
<div class="deck-option selected" data-deck="standard" onclick="selectDeck('crazy', 'standard')">
<div class="deck-info">
<span class="deck-title">Standardowa</span>
<span class="deck-desc">Klasyczne hasła odpowiednie dla wszystkich. Bezpieczne i rodzinne.<br><span class="deck-counter" id="crazyStandardCounter">Pozostało unikalnych haseł: 124/124</span></span>
</div>
</div>
<div class="deck-option" data-deck="adult" onclick="selectDeck('crazy', 'adult')">
<div class="deck-info">
<span class="deck-title">Bez cenzury (+18)</span>
<span class="deck-desc">Hasła pikantne i kontrowersyjne – tylko dla dorosłych.<br><span class="deck-counter" id="crazyAdultCounter">Pozostało unikalnych haseł: 51/51</span></span>
</div>
</div>
</div>
</div>
<div class="deck-actions">
<button class="btn-deck-action" onclick="setMixedDeck('crazy')" title="Mieszanka 13 kart Bez cenzury + 12 Standardowych">
<span class="deck-action-icon">🎲</span>
<span class="deck-action-text">50/50 Mix</span>
</button>
<button class="btn-deck-action" onclick="resetWordPool('crazy')" title="Przywróć wszystkie hasła do puli">
<span class="deck-action-icon">🔄</span>
<span class="deck-action-text">Reset puli</span>
</button>
</div>
<input type="hidden" id="crazyDeck" value="standard">
</div>
</div>
</div>

<!-- ANCHOR: CARD_ADVANCED -->
<div class="setting-card" id="cardCrazyAdvanced">
<div class="setting-head" onclick="toggleSettingCard('cardCrazyAdvanced')">
<div class="setting-title">Ustawienia zaawansowane</div>
<div class="setting-sub" id="crazyAdvancedSummary">Zabójcy: 1, 3 rundy</div>
<div class="setting-arrow">▼</div>
</div>
<div class="setting-body">
<div class="setting-body-inner">
<div class="picker-panel-content" style="margin-bottom:15px">
<label style="display:block;margin-bottom:8px;color:#ccc">Zabójcy:</label>
<div class="picker-options">
<div class="picker-option selected" data-value="1" onclick="selectAssassins('crazy', '1')">1</div>
<div class="picker-option" data-value="2" onclick="selectAssassins('crazy', '2')">2</div>
<div class="picker-option" data-value="3" onclick="selectAssassins('crazy', '3')">3</div>
<div class="picker-option" data-value="4" onclick="selectAssassins('crazy', '4')">4</div>
<div class="picker-option" data-value="5" onclick="selectAssassins('crazy', '5')">5</div>
<div class="picker-option" data-value="6" onclick="selectAssassins('crazy', '6')">6</div>
<div class="picker-option" data-value="7" onclick="selectAssassins('crazy', '7')">7</div>
</div>
<div class="picker-info">Neutralne: <span id="crazyNeutralDisplay">7</span></div>
</div>
<input type="hidden" id="crazyAssassins" value="1">
<input type="hidden" id="crazyNeutral" value="7">

<div class="picker-panel-content" style="margin-bottom:15px">
<label style="display:block;margin-bottom:8px;color:#ccc">Zaczyna:</label>
<div class="picker-options starter-options">
<div class="picker-option selected" data-value="random" onclick="selectStarter('crazy', 'random')">🎲 Losowo</div>
<div class="picker-option" data-value="red" onclick="selectStarter('crazy', 'red')">🔴 Czerwoni</div>
<div class="picker-option" data-value="blue" onclick="selectStarter('crazy', 'blue')">🔵 Niebiescy</div>
</div>
</div>
<input type="hidden" id="crazyStarter" value="random">

<div class="rounds-picker-content" style="margin-bottom:15px">
<label style="display:block;margin-bottom:8px;color:#ccc">Rundy do wygranej:</label>
<div class="rounds-options">
<div class="rounds-option" data-rounds="1" onclick="selectRounds('crazy', '1')">1</div>
<div class="rounds-option" data-rounds="2" onclick="selectRounds('crazy', '2')">2</div>
<div class="rounds-option selected" data-rounds="3" onclick="selectRounds('crazy', '3')">3</div>
<div class="rounds-option" data-rounds="4" onclick="selectRounds('crazy', '4')">4</div>
<div class="rounds-option" data-rounds="5" onclick="selectRounds('crazy', '5')">5</div>
<div class="rounds-option custom" data-rounds="custom" onclick="selectRounds('crazy', 'custom')">...</div>
</div>
<div class="rounds-custom" id="crazyRoundsCustom" style="display:none">
<label>Własna liczba:</label>
<div class="custom-input-group">
<button class="custom-btn" onclick="adjustCustomRounds('crazy', -1)">−</button>
<input type="number" id="crazyRoundsInput" min="6" max="99" value="6" onchange="updateCustomRounds('crazy')">
<button class="custom-btn" onclick="adjustCustomRounds('crazy', 1)">+</button>
</div>
</div>
</div>
<input type="hidden" id="crazyWinTarget" value="3">

<div class="setting-row">
<label>Tryb klucza:</label>
<div class="keymode-toggle">
<span class="keymode-label left">👁️</span>
<label class="switch keymode-switch">
<input type="checkbox" id="crazyKeyModeToggle" onchange="updateKeyMode('crazy', this.checked)">
<span class="slider"></span>
</label>
<span class="keymode-label right">🔑</span>
</div>
<input type="hidden" id="crazyKeyMode" value="preview">
</div>
</div>
</div>
</div>

<div class="button-group">
<button class="btn-back" onclick="backToHome()" style="flex:1">← Powrót</button>
<button class="btn-new btn-lg" onclick="startCrazy()" style="flex:2">Start</button>
</div>
</div>
</div>

<div id="gameScreen">
<div class="top-bar">
<div class="team-bar red">
<span class="team-emoji" id="scoreRedEmoji">🐉</span>
<span class="team-name" id="scoreRedName">Czerwoni</span>
<span class="team-score" id="scoreRedPoints">0</span>
</div>
<div class="top-controls">
<button class="icon-btn" id="newRoundBtn" title="Nowa runda (przytrzymaj)"><svg class="hold-progress" viewBox="0 0 100 100"><path d="M50 2 L85 2 Q98 2 98 15 L98 85 Q98 98 85 98 L15 98 Q2 98 2 85 L2 15 Q2 2 15 2 Z"/></svg><span>🔄</span></button>
<button class="icon-btn" id="keyBtn" title="Pokaż klucz (przytrzymaj)"><svg class="hold-progress" viewBox="0 0 100 100"><path d="M50 2 L85 2 Q98 2 98 15 L98 85 Q98 98 85 98 L15 98 Q2 98 2 85 L2 15 Q2 2 15 2 Z"/></svg><span>👁️</span></button>
<button class="icon-btn settings-btn" onclick="showO('gameSettings')" title="Ustawienia"><span>⚙️</span></button>
</div>
<div class="team-bar blue">
<span class="team-score" id="scoreBluePoints">0</span>
<span class="team-name" id="scoreBlueName">Niebiescy</span>
<span class="team-emoji" id="scoreBlueEmoji">🦈</span>
</div>
</div>
<div class="board-container">
<div class="grid-container" id="board"></div>
</div>
<div class="bottom-bar">
<div class="remaining-cards red" id="redPanel"></div>
<div id="status">Zaczynają: ...</div>
<div class="remaining-cards blue" id="bluePanel"></div>
</div>
</div>

<div class="overlay" id="gameSettings">
<div class="settings-container scroll-surface" style="max-width:400px">
<h2 class="overlay-title">Ustawienia</h2>
<div style="display:flex;flex-direction:column;gap:15px">
<div class="setting-row">
<label>Dźwięki:</label>
<label class="switch">
<input type="checkbox" id="gameSoundToggle" onchange="updateSound(this.checked)">
<span class="slider"></span>
</label>
</div>
<button class="btn-new" onclick="hideO('gameSettings')" style="width:100%">Kontynuuj grę</button>
<button class="btn-back" onclick="hideO('gameSettings');confirmBack()" style="width:100%;padding:15px">Powrót do menu</button>
</div>
</div>
</div>

<div class="overlay" id="endOverlay">
<div class="end-container">
<div class="end-result" id="endResult"></div>
<div class="end-scores">
<div class="end-team red">
<span class="end-emoji" id="endRedEmoji">🐉</span>
<span class="end-name" id="endRedName">Czerwoni</span>
<span class="end-score" id="endRedScore">0</span>
</div>
<div class="end-vs">VS</div>
<div class="end-team blue">
<span class="end-score" id="endBlueScore">0</span>
<span class="end-name" id="endBlueName">Niebiescy</span>
<span class="end-emoji" id="endBlueEmoji">🦈</span>
</div>
</div>
<div class="end-target" id="endTarget">Pierwszy do 3 wygranych</div>
<button class="btn-new btn-next" id="nextRoundBtn" onclick="hideO('endOverlay');initRound()">Kolejna runda →</button>
<button class="btn-back btn-menu" id="matchWonBtn" onclick="resetMatch()" style="display:none">Powrót do menu</button>
</div>
</div>

<div class="overlay" id="assassinOverlay">
<div class="assassin-container">
<div class="assassin-skull">☠️</div>
<h2 class="assassin-title">ZABÓJCA!</h2>
<div class="assassin-subtitle">Ktoś natknął się na zabójcę...</div>
<div class="assassin-question">Która drużyna przegrała rundę?</div>
<div class="assassin-buttons">
<button class="assassin-btn red" onclick="assassinHit('red')">
<span class="assassin-btn-emoji" id="assRedEmoji">🐉</span>
<span class="assassin-btn-text" id="assRedText">Czerwoni</span>
</button>
<button class="assassin-btn blue" onclick="assassinHit('blue')">
<span class="assassin-btn-emoji" id="assBlueEmoji">🦈</span>
<span class="assassin-btn-text" id="assBlueText">Niebiescy</span>
</button>
</div>
</div>
</div>

<div class="overlay" id="keyWarning">
<div class="settings-container scroll-surface" style="max-width:500px">
<h2 class="overlay-title">Pokaż klucz?</h2>
<p class="confirm-msg">Uwaga! To ujawni wszystkie karty.</p>
<p class="overlay-text">Upewnij się, że tylko szpiedzy widzą ekran!</p>
<div style="display:flex;gap:15px;justify-content:center">
<button class="btn-back" onclick="hideO('keyWarning')">Anuluj</button>
<button class="btn-key" onclick="showKey()">Pokaż</button>
</div>
</div>
</div>

<div class="overlay" id="pinOverlay">
<div class="settings-container" style="max-width:350px">
<h2 style="font-size:1.4rem;margin-bottom:12px">🔑 Dane do klucza</h2>
<div style="background:#1a1a1a;border-radius:10px;padding:10px 15px;margin-bottom:10px;text-align:center">
<p style="font-size:0.8rem;color:#888;margin:0 0 5px 0">Kod gry</p>
<div id="sessionCodeDisplay" style="font-size:1.8rem;font-weight:bold;color:#4CAF50;letter-spacing:0.25em;font-family:monospace;padding-right:0.25em">----</div>
</div>
<div style="background:#1a1a1a;border-radius:10px;padding:10px 15px;text-align:center">
<p style="font-size:0.8rem;color:#888;margin:0 0 5px 0">PIN</p>
<div class="pin-display" id="pinDisplay">1234</div>
</div>
<p style="font-size:0.85rem;color:#aaa;margin:12px 0;text-align:center">Podaj te dane kapitanom drużyn.<br>Mogą je wpisać w menu głównym → Klucz kapitana</p>
<div style="display:flex;justify-content:center;margin-top:15px">
<button class="btn-reset" onclick="hideO('pinOverlay')">Zamknij</button>
</div>
</div>
</div>

<div class="overlay" id="captainKeyOverlay">
<div class="settings-container captain-board-container">
<h2 class="overlay-title">🔑 Klucz kapitana</h2>
<p class="overlay-text">Wpisz kod gry i PIN z ekranu z planszą</p>
<div class="pin-input-section" style="background:transparent;padding:0">
<div style="margin-bottom:15px;display:flex;flex-direction:column;align-items:center">
<label style="display:block;font-size:0.85rem;color:#888;margin-bottom:8px;width:100%;text-align:center">Kod gry (4 znaki)</label>
<input type="text" id="sessionCodeInput" maxlength="4" placeholder="XXXX" autocomplete="off" style="width:100%;max-width:200px;padding:12px;font-size:1.5rem;text-align:center;letter-spacing:0.3em;text-transform:uppercase;border-radius:8px;border:2px solid #444;background:#1a1a1a;color:#4CAF50;font-family:monospace">
</div>
<div style="display:flex;flex-direction:column;align-items:center">
<label style="display:block;font-size:0.85rem;color:#888;margin-bottom:8px;width:100%;text-align:center">PIN (4 cyfry)</label>
<input type="text" id="captainPinInput" maxlength="4" placeholder="●●●●" autocomplete="off" inputmode="numeric">
</div>
<p class="pin-error" id="captainPinError">Nieprawidłowy PIN</p>
</div>
<div style="display:flex;gap:10px;justify-content:center;margin-top:15px;flex-wrap:wrap">
<button class="btn-back" onclick="hideCaptainKeyOverlay()">Anuluj</button>
<button class="btn-key" onclick="verifyCaptainPin()">Pokaż klucz</button>
</div>
</div>
</div>

<div class="overlay" id="captainBoardOverlay">
<div class="settings-container captain-board-container">
<h2 style="font-size:1.3rem;margin-bottom:10px">🔑 Klucz planszy</h2>
<div class="captain-starter" id="captainStarter"></div>
<div class="captain-board" id="captainBoard"></div>
<div class="captain-legend">
<span class="legend-item"><span class="legend-color red"></span>Czerwoni</span>
<span class="legend-item"><span class="legend-color blue"></span>Niebiescy</span>
<span class="legend-item"><span class="legend-color neutral"></span>Neutralni</span>
<span class="legend-item"><span class="legend-color assassin"></span>Zabójca</span>
</div>
<button class="btn-reset" onclick="confirmCloseCaptainBoard()" style="margin-top:15px">Zamknij</button>
</div>
</div>

<div class="overlay" id="closeCaptainConfirm">
<div class="settings-container" style="max-width:400px">
<h2 style="font-size:1.5rem;margin-bottom:15px">Zamknąć klucz?</h2>
<p style="font-size:1rem;color:#f39c12;margin-bottom:20px">Aby ponownie zobaczyć klucz, będziesz musiał wpisać kod gry i PIN.</p>
<div style="display:flex;gap:15px;justify-content:center">
<button class="btn-new" onclick="hideO('closeCaptainConfirm')">Zostań</button>
<button class="btn-reset" onclick="closeCaptainBoardAndReturn()">Zamknij</button>
</div>
</div>
</div>

<div class="overlay" id="newRoundConfirm">
<div class="settings-container" style="max-width:500px">
<h2 class="overlay-title">Nowa runda?</h2>
<p class="confirm-msg">Obecna rozgrywka zostanie zresetowana.</p>
<div style="display:flex;gap:15px;justify-content:center">
<button class="btn-back" onclick="hideO('newRoundConfirm')">Anuluj</button>
<button class="btn-new" onclick="hideO('newRoundConfirm');initRound()">Nowa runda</button>
</div>
</div>
</div>

<div class="overlay" id="resetPoolConfirm">
<div class="settings-container" style="max-width:500px">
<h2 class="overlay-title">Reset puli haseł?</h2>
<p class="confirm-msg" id="resetPoolMessage"></p>
<div style="display:flex;gap:15px;justify-content:center">
<button class="btn-back" onclick="hideO('resetPoolConfirm')">Anuluj</button>
<button class="btn-new" id="resetPoolConfirmBtn">Resetuj pulę</button>
</div>
</div>
</div>

<div class="overlay" id="backConfirm">
<div class="settings-container" style="max-width:500px">
<h2 class="overlay-title">Czy chcesz powrócić do menu?</h2>
<p class="confirm-msg">Cały postęp meczu zostanie utracony!</p>
<div style="display:flex;gap:15px;justify-content:center">
<button class="btn-ghost" onclick="hideO('backConfirm')">Nie</button>
<button class="btn-reset" onclick="resetMatch()">Tak, wyjdź</button>
</div>
</div>
</div>

<div class="overlay" id="emojiPickerOverlay">
<div class="settings-container" style="max-width:500px">
<h2 class="overlay-title">Wybierz emoji</h2>
<div class="emoji-tabs">
<button class="emoji-tab selected" data-emoji-cat="animals" onclick="filterEmojiCategory('animals')">Zwierzęta</button>
<button class="emoji-tab" data-emoji-cat="objects" onclick="filterEmojiCategory('objects')">Obiekty</button>
<button class="emoji-tab" data-emoji-cat="nature" onclick="filterEmojiCategory('nature')">Natura</button>
<button class="emoji-tab" data-emoji-cat="magic" onclick="filterEmojiCategory('magic')">Magia</button>
</div>
<div class="emoji-grid scroll-surface" id="emojiGrid"></div>
<div style="display:flex;gap:15px;justify-content:center;margin-top:20px">
<button class="btn-back" onclick="hideO('emojiPickerOverlay')">Anuluj</button>
<button class="btn-new" onclick="confirmEmojiSelection()">Wybierz</button>
</div>
</div>
</div>

<script>
// ANCHOR: CONSTANTS
const WORDS=["stand 1","stand 2","stand 3","stand 4","stand 5","stand 6","stand 7","stand 8","stand 9","stand 10","stand 11","stand 12","stand 13","stand 14","stand 15","stand 16","stand 17","stand 18","stand 19","stand 20","stand 21","stand 22","stand 23","stand 24","stand 25","stand 26","stand 27","stand 28","stand 29","stand 30","stand 31","stand 32","stand 33","stand 34","stand 35","stand 36","stand 37","stand 38","stand 39","stand 40","stand 41","stand 42","stand 43","stand 44","stand 45","stand 46","stand 47","stand 48","stand 49","stand 50","stand 51","stand 52","stand 53","stand 54","stand 55","stand 56","stand 57","stand 58","stand 59","stand 60","stand 61","stand 62","stand 63","stand 64","stand 65","stand 66","stand 67","stand 68","stand 69","stand 70","stand 71","stand 72","stand 73","stand 74","stand 75"];
const ADULT=["cenz 1","cenz 2","cenz 3","cenz 4","cenz 5","cenz 6","cenz 7","cenz 8","cenz 9","cenz 10","cenz 11","cenz 12","cenz 13","cenz 14","cenz 15","cenz 16","cenz 17","cenz 18","cenz 19","cenz 20","cenz 21","cenz 22","cenz 23","cenz 24","cenz 25","cenz 26","cenz 27","cenz 28","cenz 29","cenz 30","cenz 31","cenz 32","cenz 33","cenz 34","cenz 35","cenz 36","cenz 37","cenz 38","cenz 39","cenz 40","cenz 41","cenz 42","cenz 43","cenz 44","cenz 45","cenz 46","cenz 47","cenz 48","cenz 49","cenz 50","cenz 51","cenz 52","cenz 53","cenz 54","cenz 55","cenz 56","cenz 57","cenz 58","cenz 59","cenz 60","cenz 61","cenz 62","cenz 63","cenz 64","cenz 65","cenz 66","cenz 67","cenz 68","cenz 69","cenz 70","cenz 71","cenz 72","cenz 73","cenz 74","cenz 75"];
const EMOJIS_RED=["🐉","🦁","🔥","🌶️","🦅","🚀","⚡"];
const EMOJIS_BLUE=["🦈","🐺","❄️","🌊","🦋","🛸","⭐"];
const EMOJIS_ANIMALS=["🐉","🦁","🦅","🦈","🐺","🦋","🦄","🐲","🦊","🐼","🐨","🦉","🦚","🦜","🐙","🦑","🦞","🦀","🐢","🦎","🐍","🦂","🕷️","🦇","🐝"];
const EMOJIS_OBJECTS=["🔥","🌶️","🚀","⚡","❄️","🌊","⭐","💎","🔮","🎯","🎪","🎭","🎨","🎸","🎹","🏆","🥇","👑","💀","🤖","👽","🛸","🔱","⚔️","🛡️","🏴‍☠️","🎃"];
const EMOJIS_NATURE=["🌸","🌺","🌻","🌹","🍀","🌴","🌵","🍄","🌙","☀️","🌈","💫","✨"];
const EMOJIS_MAGIC=["👻","🧙","🧛","🧜","🧚"];
const EMOJIS_ALL=[...new Set([...EMOJIS_ANIMALS,...EMOJIS_OBJECTS,...EMOJIS_NATURE,...EMOJIS_MAGIC])];

// ANCHOR: STATE_MACHINE
let wordList=WORDS,gameMode='classic',gameOver=false,isSpymaster=false,sideCards={red:[],blue:[]},isMixedDeck=false;
const team={red:{name:"Czerwoni",emoji:"🐉",score:0},blue:{name:"Niebiescy",emoji:"🦈",score:0}};
const cfg={winTarget:3,sound:true,assassins:1,starter:'random',startAgents:9,otherAgents:8,neutral:7,width:5,height:5,deckStyle:'white',keyMode:'preview',cardRevealHold:false};
let remaining={red:0,blue:0};
let currentPin='';
let currentBoardData=null;
let currentEmojiPicker=null;
let currentEmojiCategory='all';
let usedWords=[];
let availableWords=[];
let deckStates={
    standard: {available: WORDS.length, used: 0},
    adult: {available: ADULT.length, used: 0}
};
let mixPool={standard: 0, adult: 0}; // Ile słów z każdej talii jest w mixie

// ANCHOR: CRYPTO_UTILS
async function hashPin(pin) {
    const encoder = new TextEncoder();
    const data = encoder.encode(pin + 'tajniacy_salt_2024');
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// ANCHOR: DOM_REFS
const $=id=>document.getElementById(id);
let showO=id=>$(id).style.display='flex';
let hideO=id=>$(id).style.display='none';
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};

function updateCustomRounds(mode){
    const input=$(mode+'RoundsInput');
    const value=Math.max(6,Math.min(99,parseInt(input.value)||6));
    input.value=value;
    $(mode+'WinTarget').value=value;
    
    // Aktualizuj selected class
    const cardId = mode === 'classic' ? 'Game' : 'Advanced';
    document.querySelectorAll(`#card${mode.charAt(0).toUpperCase()+mode.slice(1)}${cardId} .rounds-option`).forEach(opt=>{
        opt.classList.remove('selected');
    });
    const customBtn = document.querySelector(`#card${mode.charAt(0).toUpperCase()+mode.slice(1)}${cardId} .rounds-option.custom`);
    if(customBtn) customBtn.classList.add('selected');
    
    // Aktualizuj summary
    if(mode === 'classic') updateGameSummary(mode);
    if(mode === 'crazy') updateAdvancedSummary(mode);
}

function adjustCustomRounds(mode, delta){
    const input=$(mode+'RoundsInput');
    const currentValue=parseInt(input.value)||6;
    const newValue=Math.max(6,Math.min(99,currentValue+delta));
    input.value=newValue;
    updateCustomRounds(mode);
}

function updateWordCounters(){
    const standardTotal = WORDS.length;
    const adultTotal = ADULT.length;
    
    // Aktualizuj wszystkie liczniki
    const counters = [
        {id: 'classicStandardCounter', available: deckStates.standard.available, total: standardTotal},
        {id: 'classicAdultCounter', available: deckStates.adult.available, total: adultTotal},
        {id: 'crazyStandardCounter', available: deckStates.standard.available, total: standardTotal},
        {id: 'crazyAdultCounter', available: deckStates.adult.available, total: adultTotal}
    ];
    
    counters.forEach(c => {
        const el = $(c.id);
        if(el) {
            let text = `Pozostało unikalnych haseł: ${c.available}/${c.total}`;
            if(c.available === 0) {
                text += '<br><span style="color:#ff6b6b;font-weight:bold">⚠️ Hasła mogą się powtarzać</span>';
            }
            el.innerHTML = text;
        }
    });
}

function setMixedDeck(mode){
    // To jest WYBÓR OPCJI mixa, nie pobieranie kart!
    // Tylko ustawia że chcemy grać mixem, karty pobierze startClassic/startCrazy
    
    document.getElementById(`${mode}Deck`).value = 'mixed';
    const summary = document.getElementById(`${mode}DeckSummary`);
    if(summary) summary.textContent = '50/50 Mix';
    
    // Zaznacz OBIE opcje talii
    document.querySelectorAll(`#card${mode.charAt(0).toUpperCase()+mode.slice(1)}Deck .deck-option`).forEach(opt=>{
        opt.classList.add('selected');
    });
    
    playSound('click');
}

function resetWordPool(mode){
    // Policz ile rund dla każdej talii osobno
    const standardRounds = Math.floor(deckStates.standard.available / 25);
    const adultRounds = Math.floor(deckStates.adult.available / 25);
    
    // Ustaw wiadomość w overlay
    const message = `<div style="text-align:center;line-height:1.8">` +
                    `<strong style="font-size:1.05em">Obecna pula talii standardowej:</strong><br>` +
                    `<span style="color:#4CAF50;font-size:1.2em">${deckStates.standard.available}/${WORDS.length}</span> ` +
                    `<span style="color:#888">(~${standardRounds} ${standardRounds === 1 ? 'unikalna runda' : standardRounds < 5 ? 'unikalne rundy' : 'unikalnych rund'})</span><br><br>` +
                    `<strong style="font-size:1.05em">Obecna pula talii bez cenzury:</strong><br>` +
                    `<span style="color:#4CAF50;font-size:1.2em">${deckStates.adult.available}/${ADULT.length}</span> ` +
                    `<span style="color:#888">(~${adultRounds} ${adultRounds === 1 ? 'unikalna runda' : adultRounds < 5 ? 'unikalne rundy' : 'unikalnych rund'})</span><br><br>` +
                    `<div style="border-top:1px solid #444;margin:15px 0;padding-top:15px">` +
                    `<span style="color:#f39c12;font-size:1em">Po resecie wszystkie zużyte hasła wrócą do puli haseł!</span>` +
                    `</div>` +
                    `</div>`;
    
    $('resetPoolMessage').innerHTML = message;
    
    // Ustaw akcję dla przycisku potwierdzenia
    const confirmBtn = $('resetPoolConfirmBtn');
    confirmBtn.onclick = () => {
        hideO('resetPoolConfirm');
        executeResetPool(mode);
    };
    
    // Pokaż overlay
    showO('resetPoolConfirm');
    playSound('click');
}

function executeResetPool(mode){
    // PEŁNY RESET - wszystko wraca do pełnej puli
    usedWords = [];
    deckStates.standard.available = WORDS.length;  // 124
    deckStates.standard.used = 0;
    deckStates.adult.available = ADULT.length;     // 51
    deckStates.adult.used = 0;
    
    // Ustaw wordList i availableWords dla aktualnie wybranej talii
    const currentDeck = document.getElementById(`${mode}Deck`).value;
    
    if(currentDeck === 'adult'){
        wordList = ADULT;
        availableWords = [...ADULT];
    } else if(currentDeck === 'mixed'){
        // Dla mixa: utwórz NOWY mix z pełnych talii
        const mixedWords = [
            ...shuffle([...ADULT]).slice(0, 13),
            ...shuffle([...WORDS]).slice(0, 12)
        ];
        wordList = shuffle(mixedWords);
        availableWords = [...wordList];
        // NIE zmieniaj deckStates - liczniki pokazują że pula jest pełna (175)
    } else {
        wordList = WORDS;
        availableWords = [...WORDS];
    }
    
    updateWordCounters();
    playSound('success');
}

// ANCHOR: EMOJI_CATEGORY_FILTER
function filterEmojiCategory(category){
    currentEmojiCategory=category;
    
    // Aktualizuj selected class na tabsach
    document.querySelectorAll('.emoji-tab').forEach(tab=>{
        tab.classList.toggle('selected',tab.dataset.emojiCat===category);
    });
    
    // Pobierz odpowiednią listę emoji
    let emojiList;
    switch(category){
        case 'animals': emojiList=EMOJIS_ANIMALS; break;
        case 'objects': emojiList=EMOJIS_OBJECTS; break;
        case 'nature': emojiList=EMOJIS_NATURE; break;
        case 'magic': emojiList=EMOJIS_MAGIC; break;
        default: emojiList=EMOJIS_ANIMALS; // Domyślnie zwierzęta
    }
    
    // Przebuduj grid
    const grid=$('emojiGrid');
    grid.innerHTML='';
    emojiList.forEach(emoji=>{
        const div=document.createElement('div');
        div.className='emoji-option';
        div.textContent=emoji;
        div.onclick=()=>{
            grid.querySelectorAll('.emoji-option').forEach(e=>e.classList.remove('selected'));
            div.classList.add('selected');
        };
        grid.appendChild(div);
    });
}

// ANCHOR: EMOJI_PICKER
function buildPickers(){
    ['classic','crazy'].forEach(mode=>{
        [['Red',EMOJIS_RED,'red'],['Blue',EMOJIS_BLUE,'blue']].forEach(([suffix,emojis,t])=>{
            const picker=$(mode+suffix+'Picker');
            if(!picker)return;
            picker.innerHTML='';
            emojis.forEach((e,i)=>{
                const div=document.createElement('div');
                div.className='avatar-option'+(i===0?' selected':'');
                div.dataset.emoji=e;
                div.textContent=e;
                div.onclick=()=>selectEmoji(picker,div,e,t);
                picker.appendChild(div);
            });
            // Przycisk "+" do rozszerzonego wyboru
            const plusBtn=document.createElement('div');
            plusBtn.className='avatar-option avatar-plus';
            plusBtn.textContent='+';
            plusBtn.onclick=()=>openEmojiPicker(mode,t,picker);
            picker.appendChild(plusBtn);
        });
        
        // Deck picker
        const deckPicker=$(mode+'DeckPicker');
        const deckNameEl=$(mode+'DeckName');
        if(deckPicker){
            deckPicker.querySelectorAll('.deck-option').forEach(opt=>{
                opt.onclick=()=>{
                    deckPicker.querySelectorAll('.deck-option').forEach(o=>o.classList.remove('selected'));
                    opt.classList.add('selected');
                    $(mode+'Deck').value=opt.dataset.deck;
                    deckNameEl.textContent=opt.querySelector('.deck-title').textContent;
                };
            });
        }
        
        // Rounds picker
        const roundsPicker=$(mode+'RoundsPicker');
        const roundsNameEl=$(mode+'RoundsName');
        const customEl=$(mode+'RoundsCustom');
        if(roundsPicker){
            roundsPicker.querySelectorAll('.rounds-option').forEach(opt=>{
                opt.onclick=()=>{
                    roundsPicker.querySelectorAll('.rounds-option').forEach(o=>o.classList.remove('selected'));
                    opt.classList.add('selected');
                    
                    if(opt.dataset.rounds==='custom'){
                        customEl.style.display='flex';
                        updateCustomRounds(mode);
                    }else{
                        customEl.style.display='none';
                        $(mode+'WinTarget').value=opt.dataset.rounds;
                        roundsNameEl.textContent=opt.dataset.rounds;
                    }
                };
            });
        }
    });
    
    // Assassins picker (tylko crazy)
    const assassinsPanel=$('crazyAssassinsPanel');
    if(assassinsPanel){
        assassinsPanel.querySelectorAll('.picker-option').forEach(opt=>{
            opt.onclick=()=>{
                assassinsPanel.querySelectorAll('.picker-option').forEach(o=>o.classList.remove('selected'));
                opt.classList.add('selected');
                const val=parseInt(opt.dataset.value);
                $('crazyAssassins').value=val;
                $('crazyAssassinsName').textContent=val;
                const neutral=8-val;
                $('crazyNeutral').value=neutral;
                $('crazyNeutralDisplay').textContent=neutral;
            };
        });
    }
    
    // Starter picker (tylko crazy)
    const starterPanel=$('crazyStarterPanel');
    if(starterPanel){
        starterPanel.querySelectorAll('.picker-option').forEach(opt=>{
            opt.onclick=()=>{
                starterPanel.querySelectorAll('.picker-option').forEach(o=>o.classList.remove('selected'));
                opt.classList.add('selected');
                $('crazyStarter').value=opt.dataset.value;
                $('crazyStarterName').textContent=opt.textContent.trim();
            };
        });
    }
    
    // Inicjalizacja keymode toggles - ustaw domyślnie podgląd jako aktywny
    ['classic','crazy'].forEach(mode=>{
        const toggle = $(mode+'KeyModeToggle');
        if(toggle){
            const container = toggle.closest('.keymode-toggle');
            if(container){
                container.querySelector('.keymode-label.left').classList.add('active');
            }
        }
    });
    
    // Global style picker
    const globalStylePicker=$('globalStylePicker');
    const globalStyleNameEl=$('globalStyleName');
    if(globalStylePicker){
        // Załaduj zapisany styl
        const savedStyle = localStorage.getItem('tajniacy_style') || 'white';
        $('globalStyle').value = savedStyle;
        
        globalStylePicker.querySelectorAll('.style-option').forEach(opt=>{
            if(opt.dataset.style === savedStyle){
                globalStylePicker.querySelectorAll('.style-option').forEach(o=>o.classList.remove('selected'));
                opt.classList.add('selected');
                globalStyleNameEl.textContent = opt.querySelector('.style-name').textContent;
            }
            opt.onclick=()=>{
                globalStylePicker.querySelectorAll('.style-option').forEach(o=>o.classList.remove('selected'));
                opt.classList.add('selected');
                $('globalStyle').value=opt.dataset.style;
                globalStyleNameEl.textContent=opt.querySelector('.style-name').textContent;
                $('globalStyleSelector').closest('.style-row').classList.remove('open');
                localStorage.setItem('tajniacy_style', opt.dataset.style);
            };
        });
    }
}

function selectEmoji(picker,div,emoji,teamColor){
    picker.querySelectorAll('.avatar-option').forEach(o=>o.classList.remove('selected'));
    div.classList.add('selected');
    team[teamColor].emoji=emoji;
}

function openEmojiPicker(mode,teamColor,picker){
    currentEmojiPicker={mode,team:teamColor,picker};
    
    // Ustaw kategorię na "Zwierzęta" i zbuduj grid
    filterEmojiCategory('animals');
    
    // Zaznacz obecne emoji jeśli istnieje
    const currentEmoji=team[teamColor].emoji;
    const grid=$('emojiGrid');
    grid.querySelectorAll('.emoji-option').forEach(opt=>{
        if(opt.textContent===currentEmoji) opt.classList.add('selected');
    });
    
    showO('emojiPickerOverlay');
}

function confirmEmojiSelection(){
    const selected=$('emojiGrid').querySelector('.emoji-option.selected');
    if(selected && currentEmojiPicker){
        const emoji=selected.textContent;
        const {team:teamColor,picker}=currentEmojiPicker;
        
        // Zaznacz w głównym pickerze lub dodaj jako custom
        let found=false;
        picker.querySelectorAll('.avatar-option:not(.avatar-plus)').forEach(opt=>{
            opt.classList.remove('selected');
            if(opt.dataset.emoji===emoji){
                opt.classList.add('selected');
                found=true;
            }
        });
        
        // Jeśli nie znaleziono, podmień ostatni przed +
        if(!found){
            const options=picker.querySelectorAll('.avatar-option:not(.avatar-plus)');
            const lastOpt=options[options.length-1];
            lastOpt.dataset.emoji=emoji;
            lastOpt.textContent=emoji;
            lastOpt.classList.add('selected');
        }
        
        team[teamColor].emoji=emoji;
    }
    hideO('emojiPickerOverlay');
    currentEmojiPicker=null;
}

function toggleModeCard(card){
    // Jeśli kliknięto w przycisk, nie przełączaj
    if(event.target.closest('.mode-buttons')) return;
    
    const wasOpen = card.classList.contains('open');
    
    // Zamknij wszystkie karty
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('open'));
    
    // Otwórz klikniętą kartę (jeśli była zamknięta)
    if(!wasOpen){
        card.classList.add('open');
    }
}

function selectMode(mode){
    gameMode=mode;
    hideO('homeScreen');
    // Zamknij karty przy wyjściu
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('open'));
    showO(mode==='classic'?'classicSettings':'crazySettings');
}

function showRules(mode){
    const rules = {
        classic: `
            <h3>🎯 Cel gry</h3>
            <p>Dwie drużyny rywalizują, aby jako pierwsze odnaleźć wszystkich swoich <span class="highlight">agentów</span> ukrytych pod kartami ze słowami.</p>
            
            <h3>👥 Drużyny</h3>
            <p>Gracze dzielą się na dwie drużyny: <span class="danger">Czerwonych</span> i <span class="info">Niebieskich</span>. Każda drużyna wybiera <span class="highlight">Szpiega</span> (kapitana), który zna położenie wszystkich kart.</p>
            
            <h3>🎮 Rozgrywka</h3>
            <ul>
                <li><span class="highlight">Szpieg</span> podaje swojej drużynie jednowyrazową wskazówkę i liczbę kart, które pasują do tej wskazówki</li>
                <li>Drużyna próbuje odgadnąć karty swoich agentów</li>
                <li>Trafienie karty przeciwnika lub neutralnej kończy turę</li>
                <li>Drużyna zaczynająca ma <span class="highlight">9 agentów</span>, druga ma <span class="highlight">8</span></li>
            </ul>
            
            <h3>☠️ Zabójca</h3>
            <p>Na planszy jest <span class="danger">1 zabójca</span>. Drużyna, która trafi na zabójcę, <span class="danger">natychmiast przegrywa</span> rundę!</p>
            
            <h3>🏆 Zwycięstwo</h3>
            <p>Rundę wygrywa drużyna, która pierwsza odkryje wszystkich swoich agentów. Mecz wygrywa drużyna, która pierwsza wygra ustaloną liczbę rund.</p>
        `,
        crazy: `
            <h3>🎯 Cel gry</h3>
            <p>Takie same zasady jak w trybie klasycznym, ale z <span class="danger">większym ryzykiem</span>!</p>
            
            <h3>☠️ Wielu zabójców</h3>
            <p>Możesz ustawić od <span class="danger">1 do 7 zabójców</span> na planszy! Im więcej zabójców, tym mniej neutralnych kart i większe emocje.</p>
            <ul>
                <li>1 zabójca = 7 neutralnych</li>
                <li>3 zabójców = 5 neutralnych</li>
                <li>7 zabójców = 1 neutralna</li>
            </ul>
            
            <h3>🎲 Wybór startu</h3>
            <p>W trybie szalonym możesz wybrać, która drużyna zaczyna grę, zamiast losowania.</p>
            
            <h3>⚡ Strategia</h3>
            <p>Więcej zabójców oznacza:</p>
            <ul>
                <li>Większe ryzyko przy zgadywaniu</li>
                <li>Krótsze, bardziej intensywne rundy</li>
                <li>Ostrożniejsze wskazówki od Szpiega</li>
            </ul>
            
            <h3>🏆 Zwycięstwo</h3>
            <p>Zasady wygranej pozostają takie same - odkryj wszystkich swoich agentów lub poczekaj, aż przeciwnik trafi na zabójcę!</p>
        `
    };
    
    $('rulesTitle').textContent = mode === 'classic' ? 'Tryb Klasyczny' : 'Tryb Szalony';
    $('rulesContent').innerHTML = rules[mode];
    showO('rulesOverlay');
}

function backToHome(){
    // Reset stanu gry - kolejne kliknięcie Start da nowe hasła
    usedWords = [];
    availableWords = [];
    wordList = WORDS;
    isMixedDeck = false;
    
    // Reset liczników do pełnej puli
    deckStates.standard.available = WORDS.length;
    deckStates.standard.used = 0;
    deckStates.adult.available = ADULT.length;
    deckStates.adult.used = 0;
    
    hideO('classicSettings');
    hideO('crazySettings');
    showO('homeScreen');
}

function startClassic(){
    team.red.name=$('classicRedName').value||'Czerwoni';
    team.blue.name=$('classicBlueName').value||'Niebiescy';
    cfg.winTarget=Math.max(1,+$('classicWinTarget').value||3);
    cfg.deckStyle=$('globalStyle').value;
    
    const deckValue = $('classicDeck').value;
    
    // RESET stanów talii na start nowej gry
    usedWords = [];
    deckStates.standard.available = WORDS.length;
    deckStates.standard.used = 0;
    deckStates.adult.available = ADULT.length;
    deckStates.adult.used = 0;
    
    if(deckValue === 'mixed'){
        // Mix = proporcje 13 adult + 12 standard przy KAŻDEJ rundzie
        // NIE tworzymy zamkniętej puli, tylko ustawiamy tryb mixa
        wordList = [...ADULT, ...WORDS]; // Cała dostępna lista
        availableWords = [...wordList];
        isMixedDeck = true;
        mixPool.adult = 0;
        mixPool.standard = 0;
    } else if(deckValue === 'adult'){
        wordList = ADULT;
        availableWords = [...ADULT];
        isMixedDeck = false;
        mixPool.adult = 0;
        mixPool.standard = 0;
    } else {
        wordList = WORDS;
        availableWords = [...WORDS];
        isMixedDeck = false;
        mixPool.adult = 0;
        mixPool.standard = 0;
    }
    
    cfg.assassins=1;cfg.starter='random';cfg.startAgents=9;cfg.otherAgents=8;cfg.neutral=7;cfg.width=5;cfg.height=5;
    cfg.keyMode=$('classicKeyMode').value;
    team.red.score=team.blue.score=0;
    
    // Nowa gra = nowy kod sesji
    localStorage.removeItem('tajniacy_session_id');
    
    hideO('classicSettings');
    $('gameScreen').style.display='flex';
    $('board').className='grid-container deck-'+cfg.deckStyle;
    document.body.classList.add('game-active');
    updateKeyButtonIcon();
    updateScore();
    initRound();
}

function startCrazy(){
    team.red.name=$('crazyRedName').value||'Czerwoni';
    team.blue.name=$('crazyBlueName').value||'Niebiescy';
    
    const deckValue = $('crazyDeck').value;
    
    // RESET stanów talii na start nowej gry
    usedWords = [];
    deckStates.standard.available = WORDS.length;
    deckStates.standard.used = 0;
    deckStates.adult.available = ADULT.length;
    deckStates.adult.used = 0;
    
    if(deckValue === 'mixed'){
        // Mix = proporcje 13 adult + 12 standard przy KAŻDEJ rundzie
        // NIE tworzymy zamkniętej puli, tylko ustawiamy tryb mixa
        wordList = [...ADULT, ...WORDS]; // Cała dostępna lista
        availableWords = [...wordList];
        isMixedDeck = true;
        mixPool.adult = 0;
        mixPool.standard = 0;
    } else if(deckValue === 'adult'){
        wordList = ADULT;
        availableWords = [...ADULT];
        isMixedDeck = false;
        mixPool.adult = 0;
        mixPool.standard = 0;
    } else {
        wordList = WORDS;
        availableWords = [...WORDS];
        isMixedDeck = false;
        mixPool.adult = 0;
        mixPool.standard = 0;
    }
    
    cfg.deckStyle=$('globalStyle').value;
    cfg.assassins=Math.max(1,Math.min(7,+$('crazyAssassins').value||1));
    cfg.starter=$('crazyStarter').value;
    cfg.startAgents=9;
    cfg.otherAgents=8;
    cfg.neutral=8-cfg.assassins;
    cfg.width=5;
    cfg.height=5;
    cfg.winTarget=Math.max(1,+$('crazyWinTarget').value||3);
    cfg.keyMode=$('crazyKeyMode').value;
    team.red.score=team.blue.score=0;
    
    // Nowa gra = nowy kod sesji
    localStorage.removeItem('tajniacy_session_id');
    
    hideO('crazySettings');
    $('gameScreen').style.display='flex';
    $('board').className='grid-container deck-'+cfg.deckStyle;
    document.body.classList.add('game-active');
    updateKeyButtonIcon();
    updateScore();
    initRound();
}

// ANCHOR: ACCORDION_FUNCTIONS
function toggleSettingCard(cardId){
    const card=document.getElementById(cardId);
    if(!card)return;
    card.classList.toggle('open');
}

function selectDeck(mode,deck){
    document.getElementById(`${mode}Deck`).value=deck;
    const summary=document.getElementById(`${mode}DeckSummary`);
    if(summary)summary.textContent=deck==='standard'?'Standardowa':'Bez cenzury (+18)';
    document.querySelectorAll(`#card${mode.charAt(0).toUpperCase()+mode.slice(1)}Deck .deck-option`).forEach(opt=>{
        opt.classList.toggle('selected',opt.dataset.deck===deck);
    });
    // Aktualizuj liczniki po zmianie talii
    updateWordCounters();
}

function selectRounds(mode,rounds){
    if(rounds==='custom'){
        document.getElementById(`${mode}RoundsCustom`).style.display='block';
        document.getElementById(`${mode}RoundsInput`).focus();
        return;
    }
    document.getElementById(`${mode}WinTarget`).value=rounds;
    document.getElementById(`${mode}RoundsCustom`).style.display='none';
    
    // Aktualizuj summary
    if(mode === 'classic') updateGameSummary(mode);
    if(mode === 'crazy') updateAdvancedSummary(mode);
    
    // Aktualizuj selected class
    const cardId = mode === 'classic' ? 'Game' : 'Advanced';
    document.querySelectorAll(`#card${mode.charAt(0).toUpperCase()+mode.slice(1)}${cardId} .rounds-option`).forEach(opt=>{
        opt.classList.toggle('selected',opt.dataset.rounds===rounds);
    });
}

function selectAssassins(mode,count){
    document.getElementById(`${mode}Assassins`).value=count;
    const neutral=8-parseInt(count);
    document.getElementById(`${mode}Neutral`).value=neutral;
    document.getElementById(`${mode}NeutralDisplay`).textContent=neutral;
    updateAdvancedSummary(mode);
    document.querySelectorAll(`#card${mode.charAt(0).toUpperCase()+mode.slice(1)}Advanced .picker-option`).forEach(opt=>{
        if(opt.dataset.value)opt.classList.toggle('selected',opt.dataset.value===count);
    });
}

function selectStarter(mode,starter){
    document.getElementById(`${mode}Starter`).value=starter;
    updateAdvancedSummary(mode);
    document.querySelectorAll(`#card${mode.charAt(0).toUpperCase()+mode.slice(1)}Advanced .starter-options .picker-option`).forEach(opt=>{
        opt.classList.toggle('selected',opt.dataset.value===starter);
    });
}

function selectStyle(mode,style){
    document.getElementById(`${mode}Style`).value=style;
    const summary=document.getElementById(`${mode}StyleSummary`);
    const names={'white':'Białe','classic':'Ciemne','night':'Noc'};
    if(summary)summary.textContent=names[style]||style;
    document.querySelectorAll(`#card${mode.charAt(0).toUpperCase()+mode.slice(1)}Style .style-option`).forEach(opt=>{
        opt.classList.toggle('selected',opt.dataset.style===style);
    });
    
    // Live update - jeśli gra aktywna, zmień styl planszy
    const board=document.getElementById('board');
    if(board && document.body.classList.contains('game-active')){
        board.className='grid-container deck-'+style;
    }
}

function updateGameSummary(mode){
    const rounds=document.getElementById(`${mode}WinTarget`).value;
    const keyMode=document.getElementById(`${mode}KeyMode`).value;
    const summary=document.getElementById(`${mode}GameSummary`);
    if(summary)summary.textContent=`${rounds} ${rounds==='1'?'runda':'rundy'}, ${keyMode==='preview'?'Podgląd':'Klucz'}`;
}

function updateAdvancedSummary(mode){
    const assassins=document.getElementById(`${mode}Assassins`).value;
    const rounds=document.getElementById(`${mode}WinTarget`).value;
    const summary=document.getElementById(`${mode}AdvancedSummary`);
    if(summary)summary.textContent=`Zabójcy: ${assassins}, ${rounds} ${rounds==='1'?'runda':'rundy'}`;
}

// ANCHOR: GAME_LOGIC
function updateScore(){
    $('scoreRedEmoji').textContent=team.red.emoji;$('scoreRedName').textContent=team.red.name;$('scoreRedPoints').textContent=team.red.score;
    $('scoreBlueEmoji').textContent=team.blue.emoji;$('scoreBlueName').textContent=team.blue.name;$('scoreBluePoints').textContent=team.blue.score;
}

function updateKeyButtonIcon(){
    const icon = cfg.keyMode === 'pin' ? '🔑' : '👁️';
    $('keyBtn').querySelector('span').textContent = icon;
}

function createSideCards(){
    ['red','blue'].forEach(c=>{
        const panel=$(c+'Panel');
        panel.innerHTML='';
        sideCards[c]=[];
        for(let i=0;i<remaining[c];i++){
            const card=document.createElement('div');
            card.className='remaining-card';
            card.innerHTML=`<span class="card-emoji">${team[c].emoji}</span><span class="card-num">${i+1}</span>`;
            card.style.opacity='0';
            card.style.transform='scale(0)';
            panel.appendChild(card);
            sideCards[c].push(card);
        }
        // Animacja pojawiania się żetonów
        setTimeout(()=>animateTokensAppear(sideCards[c]),100);
    });
}

function updateSideCard(c){
    const unrevealed=sideCards[c].filter(e=>!e.classList.contains('revealed'));
    if(unrevealed.length){
        const token=unrevealed[unrevealed.length-1];
        token.classList.add('revealed');
        animateTokenReveal(token);
    }
}

// ANCHOR: BOARD_ALGORITHM (anti-clustering)
function genLayout(roles,w,h){
    let best = null;
    let bestScore = -Infinity;
    
    // Mała szansa na "dziki" układ bez ograniczeń (może mieć 5 w linii)
    if(Math.random() < 0.15){
        return shuffle([...roles]);
    }
    
    // Generuj układy i wybierz najlepszy
    for(let attempt = 0; attempt < 40; attempt++){
        const candidate = shuffle([...roles]);
        const score = evaluateDispersion(candidate, w, h);
        if(score > bestScore){
            bestScore = score;
            best = candidate;
        }
    }
    return best;
}

function evaluateDispersion(r, w, h){
    let score = 0;
    
    // Duża kara za kwadraty 2x2 tego samego typu (czerwone, niebieskie, neutralne)
    for(let row = 0; row < h - 1; row++){
        for(let col = 0; col < w - 1; col++){
            const i = row * w + col;
            const type = r[i];
            if((type === 'red' || type === 'blue' || type === 'neutral') && 
               type === r[i+1] && type === r[i+w] && type === r[i+w+1]){
                score -= 50;
            }
        }
    }
    
    // Kara za skupiska w obszarze 3x3 (tylko 6+ kart)
    for(let row = 0; row <= h - 3; row++){
        for(let col = 0; col <= w - 3; col++){
            let redCount = 0, blueCount = 0, neutralCount = 0;
            for(let dr = 0; dr < 3; dr++){
                for(let dc = 0; dc < 3; dc++){
                    const type = r[(row+dr)*w + col+dc];
                    if(type === 'red') redCount++;
                    if(type === 'blue') blueCount++;
                    if(type === 'neutral') neutralCount++;
                }
            }
            if(redCount >= 6) score -= 40;
            if(blueCount >= 6) score -= 40;
            if(neutralCount >= 5) score -= 30;
        }
    }
    
    return score;
}

function initRound(){
    const board=$('board'),status=$('status');
    board.innerHTML='';hideO('endOverlay');
    gameOver=false;isSpymaster=false;
    document.body.classList.remove('spymaster-mode');
    updateKeyButtonIcon();
    $('keyBtn').classList.remove('active');
    
    const redStarts=cfg.starter==='random'?Math.random()<.5:cfg.starter==='red';
    remaining={red:redStarts?cfg.startAgents:cfg.otherAgents,blue:redStarts?cfg.otherAgents:cfg.startAgents};
    createSideCards();
    
    status.innerHTML=`Zaczynają: <span class="team-${redStarts?'red':'blue'}">${team[redStarts?'red':'blue'].emoji} ${team[redStarts?'red':'blue'].name}</span>`;
    
    let roles=[...Array(cfg.assassins).fill('assassin'),...Array(cfg.neutral).fill('neutral'),...Array(remaining.red).fill('red'),...Array(remaining.blue).fill('blue')];
    roles=genLayout(roles,cfg.width,cfg.height);
    
    // SYSTEM NIEPOWTARZAJĄCYCH SIĘ SŁÓW
    const wordsNeeded = cfg.width * cfg.height;
    
    // Jeśli brak dostępnych słów lub za mało, zresetuj pulę
    if(availableWords.length < wordsNeeded){
        availableWords = [...wordList];
        usedWords = [];
        
        // Aktualizuj deckStates przy auto-resecie
        // Sprawdź jaka talia jest aktywna i zresetuj jej stan
        if(wordList === ADULT){
            deckStates.adult.available = ADULT.length;
            deckStates.adult.used = 0;
        } else if(wordList === WORDS){
            deckStates.standard.available = WORDS.length;
            deckStates.standard.used = 0;
        } else {
            // Mixed deck - zresetuj obie proporcjonalnie
            // Policz ile adult i ile standard jest w wordList
            const adultInMix = wordList.filter(w => ADULT.includes(w)).length;
            const standardInMix = wordList.filter(w => WORDS.includes(w)).length;
            deckStates.adult.available = adultInMix;
            deckStates.adult.used = ADULT.length - adultInMix;
            deckStates.standard.available = standardInMix;
            deckStates.standard.used = WORDS.length - standardInMix;
        }
    }
    
    // Losuj słowa - przy mixie bierz proporcje, przy czystej talii bierz wszystkie
    let words;
    if(isMixedDeck){
        // MIX: Weź 13 adult + 12 standard z dostępnych
        const adultPool = availableWords.filter(w => ADULT.includes(w));
        const standardPool = availableWords.filter(w => WORDS.includes(w));
        
        const adultCount = Math.min(13, adultPool.length);
        const standardCount = Math.min(12, standardPool.length);
        
        const adultWords = shuffle([...adultPool]).slice(0, adultCount);
        const standardWords = shuffle([...standardPool]).slice(0, standardCount);
        
        words = shuffle([...adultWords, ...standardWords]);
        
        // Jeśli brakuje do 25, uzupełnij powtórkami
        if(words.length < wordsNeeded){
            const needed = wordsNeeded - words.length;
            const allAdult = shuffle([...ADULT]);
            const allStandard = shuffle([...WORDS]);
            // Proporcjonalnie uzupełnij
            const additionalAdult = allAdult.slice(0, Math.ceil(needed * 13/25));
            const additionalStandard = allStandard.slice(0, Math.floor(needed * 12/25));
            words = words.concat(additionalAdult).concat(additionalStandard).slice(0, wordsNeeded);
        }
    } else {
        // CZYSTA TALIA: Bierz z availableWords
        const shuffledAvailable = shuffle([...availableWords]);
        words = shuffledAvailable.slice(0, wordsNeeded);
        
        // Jeśli brakuje słów, uzupełnij powtórkami
        if(words.length < wordsNeeded){
            const needed = wordsNeeded - words.length;
            const shuffledAll = shuffle([...wordList]);
            words = words.concat(shuffledAll.slice(0, needed));
        }
    }
    
    // Przenieś użyte słowa do listy użytych i usuń z dostępnych
    usedWords.push(...words);
    availableWords = availableWords.filter(w => !words.includes(w));
    
    // Aktualizuj deckStates - śledź zużycie dla każdej talii
    words.forEach(word => {
        if(ADULT.includes(word) && deckStates.adult.available > 0) {
            deckStates.adult.available--;
            deckStates.adult.used++;
        } else if(WORDS.includes(word) && deckStates.standard.available > 0) {
            deckStates.standard.available--;
            deckStates.standard.used++;
        }
    });
    
    // Zaktualizuj wyświetlane liczniki
    updateWordCounters();
    
    // Zapisz dane planszy dla kapitana (z info kto zaczyna)
    currentBoardData = {
        words: words, 
        roles: roles, 
        starter: redStarts ? 'red' : 'blue',
        redCount: remaining.red,
        blueCount: remaining.blue
    };
    
    // Generuj PIN i zapisz do localStorage (po utworzeniu danych planszy)
    generatePin();
    
    words.forEach((word,i)=>{
        if(i>=roles.length)return;
        const card=document.createElement('div');
        card.className=`card is-${roles[i]}`;
        card.innerHTML=`
            <div class="card-inner">
                <div class="card-back"></div>
                <div class="card-front">${word}</div>
            </div>
        `;
        card.dataset.index = i;
        
        // Funkcja odkrywająca kartę
        const revealCard = () => {
            if(gameOver||isSpymaster||card.classList.contains('revealed')||!card.classList.contains('flipped'))return;
            card.classList.add('revealed');
            playSound('click');
            
            if(roles[i]==='assassin'){
                // Animacja zabójcy - shake + flash
                animateAssassinReveal(card);
                gameOver=true;
                setTimeout(()=>{
                    $('assRedText').textContent=team.red.name;
                    $('assBlueText').textContent=team.blue.name;
                    $('assRedEmoji').textContent=team.red.emoji;
                    $('assBlueEmoji').textContent=team.blue.emoji;
                    showO('assassinOverlay');
                    playSound('assassin');
                },600);
                return;
            }
            
            // Zwykła karta - pulse
            animateCardReveal(card);
            
            if(roles[i]==='red'){
                remaining.red--;
                updateSideCard('red');
                if(!remaining.red){
                    gameOver=true; // Blokuj natychmiast
                    // Wygrana - burst
                    setTimeout(()=>animateWinBurst('red'),300);
                    setTimeout(()=>endRound(null,'red'),800);
                }
            }
            if(roles[i]==='blue'){
                remaining.blue--;
                updateSideCard('blue');
                if(!remaining.blue){
                    gameOver=true; // Blokuj natychmiast
                    // Wygrana - burst
                    setTimeout(()=>animateWinBurst('blue'),300);
                    setTimeout(()=>endRound(null,'blue'),800);
                }
            }
        };
        
        // Obsługa kliknięcia / przytrzymania
        let cardHoldTimer = null;
        const CARD_HOLD_TIME = 200;
        
        const startCardHold = (e) => {
            if(gameOver||isSpymaster||card.classList.contains('revealed')||!card.classList.contains('flipped'))return;
            
            if(cfg.cardRevealHold){
                e.preventDefault();
                card.classList.add('holding');
                cardHoldTimer = setTimeout(()=>{
                    card.classList.remove('holding');
                    revealCard();
                    cardHoldTimer = null;
                }, CARD_HOLD_TIME);
            }
        };
        
        const cancelCardHold = () => {
            if(cardHoldTimer){
                clearTimeout(cardHoldTimer);
                cardHoldTimer = null;
            }
            card.classList.remove('holding');
        };
        
        card.onclick = () => {
            if(!cfg.cardRevealHold){
                revealCard();
            }
        };
        
        card.addEventListener('mousedown', startCardHold);
        card.addEventListener('touchstart', startCardHold, {passive: false});
        card.addEventListener('mouseup', cancelCardHold);
        card.addEventListener('mouseleave', cancelCardHold);
        card.addEventListener('touchend', cancelCardHold);
        card.addEventListener('touchcancel', cancelCardHold);
        
        board.appendChild(card);
    });
    
    // Animacja flip kart - rewers na awers
    setTimeout(()=>animateCardsFlip(board.querySelectorAll('.card')),100);
    
    // Aktualizuj liczniki słów
    updateWordCounters();
}

function endRound(resultText,winner,isAssassin=false){
    gameOver=true;
    
    // Aktualizuj dane drużyn w overlay
    $('endRedEmoji').textContent=team.red.emoji;
    $('endRedName').textContent=team.red.name;
    $('endBlueEmoji').textContent=team.blue.emoji;
    $('endBlueName').textContent=team.blue.name;
    
    const resultEl=$('endResult');
    resultEl.className='end-result';
    
    if(winner){
        team[winner].score++;
        updateScore();
        
        // Animacja wyniku w górnym pasku
        animateScoreUpdate($('score'+winner.charAt(0).toUpperCase()+winner.slice(1)+'Points'));
        
        $('endRedScore').textContent=team.red.score;
        $('endBlueScore').textContent=team.blue.score;
        $('endTarget').textContent=`Do ${cfg.winTarget} wygranych rund`;
        
        if(team[winner].score>=cfg.winTarget){
            // Wygrana meczu
            showConfetti(winner==='red'?'#e74c3c':'#3498db');
            resultEl.textContent=`${team[winner].emoji} ${team[winner].name} WYGRYWAJĄ MECZ!`;
            resultEl.classList.add('match-won');
            $('nextRoundBtn').style.display='none';
            $('matchWonBtn').style.display='inline-block';
        }else{
            // Wygrana rundy
            playSound('win');
            if(isAssassin){
                resultEl.textContent=resultText;
                resultEl.classList.add('assassin');
            }else{
                resultEl.textContent=`${team[winner].emoji} ${team[winner].name} wygrywają rundę!`;
                resultEl.classList.add('win-'+winner);
            }
            $('nextRoundBtn').style.display='inline-block';
            $('matchWonBtn').style.display='none';
        }
        
        // Animacja wyników na ekranie wygranej
        setTimeout(() => {
            const winnerScoreEl = winner === 'red' ? $('endRedScore') : $('endBlueScore');
            if(winnerScoreEl){
                anime({
                    targets: winnerScoreEl,
                    scale: [1, 1.4, 1],
                    duration: 500,
                    easing: 'easeOutBack'
                });
            }
        }, 300);
    }
    
    showO('endOverlay');
}

function assassinHit(loser){
    hideO('assassinOverlay');
    const winner=loser==='red'?'blue':'red';
    endRound(`${team[loser].emoji} ${team[loser].name} trafili na zabójcę!`,winner,true);
}

function toggleKey(){
    if(gameOver)return;
    if(!isSpymaster){
        if(cfg.keyMode === 'pin'){
            showO('pinOverlay');
        } else {
            showO('keyWarning');
        }
    }
    else{isSpymaster=false;document.body.classList.remove('spymaster-mode');updateKeyButtonIcon();$('keyBtn').classList.remove('active')}
}

function showKey(){
    hideO('keyWarning');
    hideO('pinOverlay');
    isSpymaster=true;
    document.body.classList.add('spymaster-mode');
    updateKeyButtonIcon();
    $('keyBtn').classList.add('active');
}

async function generatePin(){
    currentPin = String(Math.floor(1000 + Math.random() * 9000));
    $('pinDisplay').textContent = currentPin;
    
    // Hashuj PIN przed zapisaniem
    const pinHash = await hashPin(currentPin);
    
    // Zapisz do localStorage (dla tej samej przeglądarki)
    localStorage.setItem('tajniacy_pin_hash', pinHash);
    localStorage.setItem('tajniacy_board', JSON.stringify(currentBoardData));
    
    // Zapisz do Firebase (dla innych urządzeń)
    if(db) {
        try {
            // Generuj unikalny ID sesji (lub użyj istniejącego)
            let sessionId = localStorage.getItem('tajniacy_session_id');
            if(!sessionId) {
                sessionId = generateSessionCode();
                localStorage.setItem('tajniacy_session_id', sessionId);
            }
            
            await db.ref('games/' + sessionId).set({
                pinHash: pinHash,
                board: currentBoardData,
                createdAt: Date.now()
            });
            
            // Pokaż kod sesji na ekranie z PIN-em
            if($('sessionCodeDisplay')) {
                $('sessionCodeDisplay').textContent = sessionId;
            }
            console.log('Gra zapisana w Firebase, kod:', sessionId);
        } catch(e) {
            console.log('Firebase niedostępny, działa tylko lokalnie');
        }
    }
}

// Generuj 4-znakowy kod sesji
function generateSessionCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for(let i = 0; i < 4; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

function showCaptainKeyOverlay(){
    // Wyczyść wszystkie pola
    $('captainPinInput').value = '';
    $('captainPinInput').classList.remove('error','success');
    if($('sessionCodeInput')) $('sessionCodeInput').value = '';
    
    // Resetuj komunikat błędu
    const error = $('captainPinError');
    error.textContent = '';
    error.classList.remove('visible');
    error.style.color = '#e74c3c';
    
    // Upewnij się że inne overlaye kapitana są zamknięte (bez animacji)
    $('captainBoardOverlay').style.display = 'none';
    $('captainBoardOverlay').style.opacity = '1';
    $('closeCaptainConfirm').style.display = 'none';
    $('closeCaptainConfirm').style.opacity = '1';
    
    showO('captainKeyOverlay');
    setTimeout(()=>{
        if($('sessionCodeInput')) $('sessionCodeInput').focus();
        else $('captainPinInput').focus();
    }, 300);
}

function goToHub(){
    window.location.href = '../../index.html';
}

function updateSound(enabled){
    cfg.sound = enabled;
    localStorage.setItem('tajniacy_sound', enabled);
    // Synchronizuj oba togglee
    if($('globalSoundToggle')) $('globalSoundToggle').checked = enabled;
    if($('gameSoundToggle')) $('gameSoundToggle').checked = enabled;
}

function updateKeyMode(mode, isPin){
    const value = isPin ? 'pin' : 'preview';
    $(mode + 'KeyMode').value = value;
    
    // Aktualizuj wizualne podświetlenie emoji
    const toggle = $(mode + 'KeyModeToggle').closest('.keymode-toggle');
    if(toggle){
        toggle.querySelector('.keymode-label.left').classList.toggle('active', !isPin);
        toggle.querySelector('.keymode-label.right').classList.toggle('active', isPin);
    }
}

function updateCardRevealMode(isHold){
    cfg.cardRevealHold = isHold;
    localStorage.setItem('tajniacy_cardRevealHold', isHold);
    
    // Aktualizuj wizualne podświetlenie emoji
    const toggle = $('globalCardRevealToggle').closest('.keymode-toggle');
    if(toggle){
        toggle.querySelector('.keymode-label.left').classList.toggle('active', !isHold);
        toggle.querySelector('.keymode-label.right').classList.toggle('active', isHold);
    }
}

function showGlobalSettings(){
    $('globalSoundToggle').checked = cfg.sound;
    $('globalCardRevealToggle').checked = cfg.cardRevealHold;
    
    // Aktualizuj wizualne podświetlenie emoji dla card reveal
    const toggle = $('globalCardRevealToggle').closest('.keymode-toggle');
    if(toggle){
        toggle.querySelector('.keymode-label.left').classList.toggle('active', !cfg.cardRevealHold);
        toggle.querySelector('.keymode-label.right').classList.toggle('active', cfg.cardRevealHold);
    }
    
    showO('globalSettingsOverlay');
}

function hideCaptainKeyOverlay(){
    hideO('captainKeyOverlay');
    $('captainPinInput').value = '';
    $('captainPinInput').classList.remove('error','success');
    $('captainPinError').classList.remove('visible');
}

async function verifyCaptainPin(){
    const input = $('captainPinInput');
    const error = $('captainPinError');
    const sessionInput = $('sessionCodeInput');
    
    // Pobierz kod sesji (jeśli wpisany)
    const sessionCode = sessionInput ? sessionInput.value.toUpperCase().trim() : '';
    
    let savedPinHash = null;
    let savedBoard = null;
    
    // Jeśli jest kod sesji, szukaj w Firebase
    if(sessionCode && sessionCode.length === 4 && db) {
        try {
            error.textContent = 'Szukam gry...';
            error.classList.add('visible');
            error.style.color = '#888';
            
            const snapshot = await db.ref('games/' + sessionCode).once('value');
            if(snapshot.exists()) {
                const data = snapshot.val();
                savedPinHash = data.pinHash;
                savedBoard = data.board;
                error.classList.remove('visible');
            } else {
                error.textContent = 'Nie znaleziono gry o kodzie ' + sessionCode;
                error.style.color = '#e74c3c';
                error.classList.add('visible');
                input.classList.add('error');
                setTimeout(()=>input.classList.remove('error'), 300);
                return;
            }
        } catch(e) {
            console.log('Błąd Firebase:', e);
            error.textContent = 'Błąd połączenia';
            error.style.color = '#e74c3c';
            error.classList.add('visible');
            return;
        }
    } else {
        // Brak kodu sesji - szukaj w localStorage
        savedPinHash = localStorage.getItem('tajniacy_pin_hash');
        const savedBoardStr = localStorage.getItem('tajniacy_board');
        if(savedBoardStr) {
            try {
                savedBoard = JSON.parse(savedBoardStr);
            } catch(e) {}
        }
    }
    
    if(!savedPinHash || !savedBoard){
        error.textContent = 'Wpisz kod gry lub uruchom grę na tym urządzeniu';
        error.style.color = '#e74c3c';
        error.classList.add('visible');
        input.classList.add('error');
        setTimeout(()=>input.classList.remove('error'), 300);
        return;
    }
    
    // Hashuj wpisany PIN i porównaj
    const inputHash = await hashPin(input.value);
    
    if(inputHash === savedPinHash){
        input.classList.remove('error');
        input.classList.add('success');
        error.classList.remove('visible');
        
        try {
            // Najpierw przygotuj planszę
            buildCaptainBoard(savedBoard);
            
            // Ukryj input overlay i pokaż planszę
            $('captainKeyOverlay').style.display = 'none';
            $('captainBoardOverlay').style.display = 'flex';
        } catch(e) {
            error.textContent = 'Błąd wczytywania planszy';
            error.style.color = '#e74c3c';
            error.classList.add('visible');
        }
    } else {
        error.textContent = 'Nieprawidłowy PIN';
        error.style.color = '#e74c3c';
        input.classList.add('error');
        error.classList.add('visible');
        setTimeout(()=>input.classList.remove('error'), 300);
    }
}

function buildCaptainBoard(boardData){
    const board = $('captainBoard');
    const starterEl = $('captainStarter');
    board.innerHTML = '';
    
    // Pokaż kto zaczyna
    if(boardData.starter){
        const isRed = boardData.starter === 'red';
        const color = isRed ? '#e74c3c' : '#3498db';
        const teamName = isRed ? 'Czerwoni' : 'Niebiescy';
        const count = isRed ? boardData.redCount : boardData.blueCount;
        const otherCount = isRed ? boardData.blueCount : boardData.redCount;
        
        starterEl.innerHTML = `
            <div class="starter-info" style="border-color:${color}">
                <span class="starter-label">Zaczyna:</span>
                <span class="starter-team" style="color:${color}">${teamName}</span>
                <span class="starter-counts">
                    <span style="color:#e74c3c">${boardData.redCount || '?'}</span>
                    <span style="color:#888">vs</span>
                    <span style="color:#3498db">${boardData.blueCount || '?'}</span>
                </span>
            </div>
        `;
    } else {
        starterEl.innerHTML = '';
    }
    
    boardData.words.forEach((word, i) => {
        const card = document.createElement('div');
        card.className = `captain-card is-${boardData.roles[i]}`;
        card.textContent = word;
        board.appendChild(card);
    });
}

function confirmCloseCaptainBoard(){
    showO('closeCaptainConfirm');
}

function closeCaptainBoardAndReturn(){
    // Ukryj overlaye i zresetuj opacity
    $('closeCaptainConfirm').style.display = 'none';
    $('closeCaptainConfirm').style.opacity = '1';
    $('captainBoardOverlay').style.display = 'none';
    $('captainBoardOverlay').style.opacity = '1';
    
    // Upewnij się że homeScreen jest widoczny
    showO('homeScreen');
}

function confirmNewRound(){
    hideO('gameSettings');
    if(!gameOver&&$('board').children.length)showO('newRoundConfirm');
    else initRound();
}

function confirmBack(){showO('backConfirm')}

function resetMatch(){
    hideO('backConfirm');hideO('endOverlay');hideO('gameSettings');
    $('gameScreen').style.display='none';
    showO('homeScreen');
    document.body.classList.remove('game-active','spymaster-mode');
    $('board').innerHTML='';
    $('redPanel').innerHTML='';
    $('bluePanel').innerHTML='';
    team.red.score=team.blue.score=0;
    gameOver=false;isSpymaster=false;
    
    // Reset stanu gry - nowy start da nowe hasła
    usedWords = [];
    availableWords = [];
    wordList = WORDS;
    isMixedDeck = false;
    
    // Reset liczników do pełnej puli
    deckStates.standard.available = WORDS.length;
    deckStates.standard.used = 0;
    deckStates.adult.available = ADULT.length;
    deckStates.adult.used = 0;
    
    // Zatrzymaj confetti
    stopConfetti();
}

let confettiInterval = null;

function stopConfetti(){
    if(confettiInterval){
        clearInterval(confettiInterval);
        confettiInterval = null;
    }
    document.querySelectorAll('.confetti').forEach(c => c.remove());
}

function showConfetti(color){
    // Zatrzymaj poprzednie confetti
    stopConfetti();
    
    const teamColors = color === '#e74c3c' 
        ? ['#e74c3c','#c0392b','#ff6b6b','#ee5a24'] 
        : ['#3498db','#2980b9','#74b9ff','#0984e3'];
    const goldColors = ['#FFD700','#FFC107','#FFEB3B','#FFA000'];
    const allColors = [...teamColors, ...goldColors];
    
    // Confetti przez 10 sekund
    const duration = 10000;
    const interval = 100; // co 100ms nowa porcja
    let elapsed = 0;
    
    const spawnConfetti = () => {
        for(let i = 0; i < 8; i++){
            const c = document.createElement('div');
            c.className = 'confetti';
            c.style.left = Math.random() * 100 + 'vw';
            c.style.background = allColors[Math.floor(Math.random() * allColors.length)];
            c.style.width = (8 + Math.random() * 12) + 'px';
            c.style.height = (8 + Math.random() * 12) + 'px';
            c.style.borderRadius = Math.random() > 0.5 ? '50%' : Math.random() > 0.5 ? '0' : '2px';
            document.body.appendChild(c);
            
            anime({
                targets: c,
                translateY: [0, window.innerHeight + 100],
                translateX: () => anime.random(-150, 150),
                rotate: () => anime.random(0, 1080),
                scale: [1, anime.random(0.3, 1.5)],
                opacity: [1, 0.8, 0],
                duration: anime.random(3000, 5000),
                easing: 'easeOutQuad',
                complete: () => c.remove()
            });
        }
    };
    
    // Początkowy wybuch
    for(let i = 0; i < 100; i++){
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + 'vw';
        c.style.background = allColors[Math.floor(Math.random() * allColors.length)];
        c.style.width = (10 + Math.random() * 15) + 'px';
        c.style.height = (10 + Math.random() * 15) + 'px';
        c.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        document.body.appendChild(c);
        
        anime({
            targets: c,
            translateY: [0, window.innerHeight + 100],
            translateX: () => anime.random(-200, 200),
            rotate: () => anime.random(0, 1440),
            scale: [1.5, anime.random(0.5, 1)],
            opacity: [1, 0],
            duration: anime.random(2500, 4500),
            easing: 'easeOutQuad',
            complete: () => c.remove()
        });
    }
    
    // Ciągłe confetti przez 10 sekund
    confettiInterval = setInterval(() => {
        elapsed += interval;
        if(elapsed >= duration){
            clearInterval(confettiInterval);
            confettiInterval = null;
            return;
        }
        spawnConfetti();
    }, interval);
    
    // Fanfary
    playFanfare();
}

function playFanfare(){
    if(!cfg.sound) return;
    try {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Fanfarowa melodia - C E G C(wysoki) G E C
        const notes = [
            {freq: 523, time: 0, dur: 0.15},      // C5
            {freq: 659, time: 0.15, dur: 0.15},   // E5
            {freq: 784, time: 0.3, dur: 0.15},    // G5
            {freq: 1047, time: 0.45, dur: 0.3},   // C6
            {freq: 784, time: 0.8, dur: 0.15},    // G5
            {freq: 659, time: 0.95, dur: 0.15},   // E5
            {freq: 523, time: 1.1, dur: 0.4},     // C5
            // Drugi akord
            {freq: 587, time: 1.6, dur: 0.15},    // D5
            {freq: 740, time: 1.75, dur: 0.15},   // F#5
            {freq: 880, time: 1.9, dur: 0.15},    // A5
            {freq: 1175, time: 2.05, dur: 0.5},   // D6
        ];
        
        notes.forEach(note => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.type = 'triangle';
            osc.frequency.value = note.freq;
            
            const startTime = audioCtx.currentTime + note.time;
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(0.25, startTime + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + note.dur);
            
            osc.start(startTime);
            osc.stop(startTime + note.dur + 0.1);
        });
    } catch(e) {
        console.log('Audio error:', e);
    }
}

// ANCHOR: ANIMATIONS
function animateCardReveal(card){
    // Pulse + scale
    anime({
        targets:card,
        scale:[1,1.15,1],
        boxShadow:['0 4px 12px rgba(0,0,0,0.3)','0 8px 30px rgba(0,0,0,0.5)','0 4px 12px rgba(0,0,0,0.3)'],
        duration:350,
        easing:'easeOutBack'
    });
}

function animateAssassinReveal(card){
    // Shake + flash
    anime({
        targets:card,
        translateX:[0,-8,8,-8,8,-4,4,0],
        duration:400,
        easing:'easeInOutQuad'
    });
    
    // Flash effect na card-front
    const cardFront = card.querySelector('.card-front');
    if(cardFront){
        anime({
            targets:cardFront,
            boxShadow:['inset 0 0 20px rgba(0,0,0,0.3)','0 0 40px rgba(255,0,0,0.8)','inset 0 0 20px rgba(0,0,0,0.3)'],
            duration:600,
            easing:'easeOutQuad'
        });
    }
    
    playSound('assassin');
}

function animateWinBurst(color){
    const boardRect=$('board').getBoundingClientRect();
    const centerX=boardRect.left+boardRect.width/2;
    const centerY=boardRect.top+boardRect.height/2;
    const burstColor=color==='red'?'#e74c3c':'#3498db';
    const burstColorLight=color==='red'?'#ff6b6b':'#74b9ff';
    
    // Duży burst z centrum planszy
    for(let i=0;i<50;i++){
        const particle=document.createElement('div');
        const size=10+Math.random()*15;
        particle.style.cssText=`
            position:fixed;
            left:${centerX}px;
            top:${centerY}px;
            width:${size}px;
            height:${size}px;
            background:${Math.random()>0.5?burstColor:burstColorLight};
            border-radius:50%;
            pointer-events:none;
            z-index:9999;
            transform:translate(-50%,-50%);
        `;
        document.body.appendChild(particle);
        
        const angle=Math.random()*Math.PI*2;
        const distance=150+Math.random()*200;
        
        anime({
            targets:particle,
            translateX:Math.cos(angle)*distance,
            translateY:Math.sin(angle)*distance,
            scale:[0,1.5,0],
            opacity:[1,1,0],
            duration:800+Math.random()*400,
            easing:'easeOutCubic',
            complete:()=>particle.remove()
        });
    }
}

function animateCardsFlip(cards){
    // Karty pojawiają się najpierw (rewersem)
    cards.forEach(card => {
        card.style.opacity = '1';
    });
    
    // Flip z opóźnieniem dla każdej karty
    cards.forEach((card, i) => {
        const row = Math.floor(i / 5);
        const col = i % 5;
        // Delay bazowany na odległości od lewego górnego rogu
        const delay = (row + col) * 120 + 300;
        
        setTimeout(() => {
            card.classList.add('flipped');
        }, delay);
    });
}

function animateTokenReveal(token){
    anime({
        targets:token,
        scale:[1,0.85],
        opacity:[1,0.2],
        duration:300,
        easing:'easeOutQuad'
    });
}

function animateTokensAppear(tokens){
    anime({
        targets:tokens,
        scale:[0,1],
        opacity:[0,1],
        delay:anime.stagger(50),
        duration:300,
        easing:'easeOutBack'
    });
}

function animateOverlayShow(overlay){
    const id = overlay.id;
    anime.set(overlay,{display:'flex'});
    anime({
        targets:overlay,
        opacity:[0,1],
        duration:250,
        easing:'easeOutQuad'
    });
    
    // Home screen - animacje tytułu i kart trybów
    if(id === 'homeScreen'){
        const title = overlay.querySelector('.home-title');
        const subtitle = overlay.querySelector('.home-subtitle');
        const modeCards = overlay.querySelectorAll('.mode-card');
        
        if(title){
            anime({
                targets:title,
                translateY:[-30,0],
                opacity:[0,1],
                duration:500,
                easing:'easeOutBack'
            });
        }
        if(subtitle){
            anime({
                targets:subtitle,
                translateY:[-20,0],
                opacity:[0,1],
                duration:400,
                delay:100,
                easing:'easeOutQuad'
            });
        }
        if(modeCards.length){
            anime({
                targets:modeCards,
                translateY:[40,0],
                opacity:[0,1],
                delay:anime.stagger(100,{start:200}),
                duration:500,
                easing:'easeOutBack'
            });
        }
        return;
    }
    
    // Settings screens - prosta animacja
    if(id === 'classicSettings' || id === 'crazySettings'){
        const container = overlay.querySelector('.settings-container');
        if(container){
            anime({
                targets:container,
                translateY:[20,0],
                opacity:[0,1],
                duration:300,
                easing:'easeOutQuad'
            });
        }
        return;
    }
    
    // End overlay - animacja wyniku
    if(id === 'endOverlay'){
        const container = overlay.querySelector('.end-container');
        const result = overlay.querySelector('.end-result');
        const scores = overlay.querySelector('.end-scores');
        const target = overlay.querySelector('.end-target');
        const btns = overlay.querySelectorAll('.end-container button');
        
        if(container) anime.set(container,{opacity:1});
        if(result){
            anime({
                targets:result,
                scale:[0.5,1],
                opacity:[0,1],
                duration:500,
                easing:'easeOutBack'
            });
        }
        if(scores){
            anime({
                targets:scores,
                translateY:[30,0],
                opacity:[0,1],
                delay:200,
                duration:400,
                easing:'easeOutQuad'
            });
        }
        if(target){
            anime({
                targets:target,
                opacity:[0,1],
                delay:350,
                duration:300,
                easing:'easeOutQuad'
            });
        }
        if(btns.length){
            anime({
                targets:btns,
                translateY:[20,0],
                opacity:[0,1],
                delay:anime.stagger(100,{start:450}),
                duration:350,
                easing:'easeOutBack'
            });
        }
        return;
    }
    
    // Domyślna animacja dla pozostałych overlay (confirmy, warnings)
    const container = overlay.querySelector('.settings-container');
    if(container){
        anime({
            targets:container,
            scale:[0.9,1],
            opacity:[0,1],
            duration:300,
            easing:'easeOutBack'
        });
    }
}

function animateOverlayHide(overlay,callback){
    anime({
        targets:overlay,
        opacity:[1,0],
        duration:200,
        easing:'easeInQuad',
        complete:()=>{
            overlay.style.display='none';
            if(callback)callback();
        }
    });
}

function animateScoreUpdate(el){
    anime({
        targets:el,
        scale:[1,1.3,1],
        duration:400,
        easing:'easeOutBack'
    });
}

function animateButtonHover(btn,enter){
    anime.remove(btn);
    anime({
        targets:btn,
        scale:enter?1.1:1,
        duration:200,
        easing:'easeOutQuad'
    });
}

function animateHoldProgress(btn,progress){
    const circle=btn.querySelector('.hold-progress');
    if(circle){
        circle.style.background=`conic-gradient(#4CAF50 ${progress*360}deg, transparent ${progress*360}deg)`;
    }
}

// ANCHOR: AUDIO
let audioCtx=null;
function playSound(type){
    if(!cfg.sound)return;
    try{
        if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
        const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
        osc.connect(gain);gain.connect(audioCtx.destination);
        if(type==='assassin'){osc.frequency.value=100;gain.gain.setValueAtTime(.3,audioCtx.currentTime);gain.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.5);osc.start();osc.stop(audioCtx.currentTime+.5)}
        else if(type==='win'){[523,659,784].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.value=f;g.gain.setValueAtTime(.2,audioCtx.currentTime+i*.15);g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+i*.15+.3);o.start(audioCtx.currentTime+i*.15);o.stop(audioCtx.currentTime+i*.15+.3)})}
        else{osc.frequency.value=800;gain.gain.setValueAtTime(.15,audioCtx.currentTime);gain.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.1);osc.start();osc.stop(audioCtx.currentTime+.1)}
    }catch(e){}
}

// ANCHOR: INIT
buildPickers();

// Załaduj ustawienia dźwięku z localStorage
const savedSound = localStorage.getItem('tajniacy_sound');
if(savedSound !== null){
    cfg.sound = savedSound === 'true';
}

// Załaduj ustawienia odkrywania kart z localStorage
const savedCardRevealHold = localStorage.getItem('tajniacy_cardRevealHold');
if(savedCardRevealHold !== null){
    cfg.cardRevealHold = savedCardRevealHold === 'true';
}

showO('homeScreen');

// Obsługa przytrzymania przycisków z animacją
let holdTimer=null;
let holdAnimation=null;
const HOLD_TIME=500;

function setupHoldButton(btnId,action,condition){
    const btn=$(btnId);
    if(!btn)return;
    
    const path=btn.querySelector('svg.hold-progress path');
    const perimeter=384; // przybliżony obwód ścieżki
    if(path){
        path.style.strokeDasharray=perimeter;
        path.style.strokeDashoffset=perimeter;
    }
    
    const startHold=(e)=>{
        // Sprawdź warunek - jeśli false, nie uruchamiaj animacji
        if(condition && !condition()){
            return;
        }
        
        e.preventDefault();
        btn.classList.add('holding');
        
        if(path){
            path.style.strokeDashoffset=perimeter;
            holdAnimation=anime({
                targets:path,
                strokeDashoffset:[perimeter,0],
                duration:HOLD_TIME,
                easing:'linear'
            });
        }
        
        holdTimer=setTimeout(()=>{
            btn.classList.remove('holding');
            // Flash effect po zakończeniu
            anime({
                targets:btn,
                scale:[1,1.15,1],
                duration:200,
                easing:'easeOutBack'
            });
            if(path){
                path.style.strokeDashoffset=perimeter;
            }
            action();
        },HOLD_TIME);
    };
    
    const cancelHold=()=>{
        if(holdTimer){
            clearTimeout(holdTimer);
            holdTimer=null;
        }
        if(holdAnimation){
            holdAnimation.pause();
        }
        btn.classList.remove('holding');
        if(path){
            anime({
                targets:path,
                strokeDashoffset:perimeter,
                duration:150,
                easing:'easeOutQuad'
            });
        }
    };
    
    btn.addEventListener('mousedown',startHold);
    btn.addEventListener('touchstart',startHold,{passive:false});
    btn.addEventListener('mouseup',cancelHold);
    btn.addEventListener('mouseleave',cancelHold);
    btn.addEventListener('touchend',cancelHold);
    btn.addEventListener('touchcancel',cancelHold);
}

setupHoldButton('newRoundBtn',()=>{
    if(!gameOver&&$('board').children.length)showO('newRoundConfirm');
    else initRound();
});

// keyBtn - hold tylko dla trybu preview, click dla PIN
setupHoldButton('keyBtn',()=>{
    if(gameOver)return;
    if(cfg.keyMode === 'preview' && !isSpymaster){
        showO('keyWarning');
    }
}, ()=> cfg.keyMode === 'preview' && !isSpymaster);

// Obsługa kliknięcia keyBtn
$('keyBtn').addEventListener('click',()=>{
    if(gameOver)return;
    if(isSpymaster){
        toggleKey();
    } else if(cfg.keyMode === 'pin'){
        showO('pinOverlay');
    }
});

// Obsługa Enter w polu PIN kapitana
$('captainPinInput').addEventListener('keyup',(e)=>{
    if(e.key === 'Enter') verifyCaptainPin();
});

// Animowane przejścia overlay
const origShowO=showO;
showO=id=>{
    const overlay=$(id);
    if(overlay){
        animateOverlayShow(overlay);
    }
    if(id==='gameSettings'){
        $('gameSoundToggle').checked=cfg.sound;
    }
};

const origHideO=hideO;
hideO=id=>{
    const overlay=$(id);
    if(overlay && overlay.style.display!=='none'){
        animateOverlayHide(overlay);
    }
};

// ANCHOR: KEYBOARD_GAMEPAD
let selectedCardIndex = -1;
let keyboardMode = false;

function getVisibleCards(){
    return Array.from($('board').querySelectorAll('.card:not(.revealed)'));
}

function getAllCards(){
    return Array.from($('board').querySelectorAll('.card'));
}

function updateCardSelection(newIndex){
    const allCards = getAllCards();
    if(allCards.length === 0) return;
    
    allCards.forEach(c => c.classList.remove('keyboard-selected'));
    
    // Ogranicz indeks
    if(newIndex < 0) newIndex = 0;
    if(newIndex >= allCards.length) newIndex = allCards.length - 1;
    
    selectedCardIndex = newIndex;
    allCards[selectedCardIndex].classList.add('keyboard-selected');
    
    // Przewiń do widoczności jeśli trzeba
    allCards[selectedCardIndex].scrollIntoView({behavior:'smooth', block:'nearest'});
}

function moveSelection(dx, dy){
    if(!keyboardMode || $('gameScreen').style.display === 'none') return;
    
    const cols = 5;
    const allCards = getAllCards();
    if(allCards.length === 0) return;
    
    if(selectedCardIndex < 0) {
        updateCardSelection(0);
        return;
    }
    
    let newIndex = selectedCardIndex;
    const row = Math.floor(selectedCardIndex / cols);
    const col = selectedCardIndex % cols;
    
    if(dx !== 0){
        const newCol = col + dx;
        if(newCol >= 0 && newCol < cols){
            newIndex = row * cols + newCol;
        }
    }
    if(dy !== 0){
        const newRow = row + dy;
        if(newRow >= 0 && newRow < Math.ceil(allCards.length / cols)){
            newIndex = newRow * cols + col;
            if(newIndex >= allCards.length) newIndex = allCards.length - 1;
        }
    }
    
    updateCardSelection(newIndex);
}

function activateSelectedCard(){
    if(selectedCardIndex < 0) return;
    const allCards = getAllCards();
    const card = allCards[selectedCardIndex];
    if(card && !card.classList.contains('revealed') && card.classList.contains('flipped')){
        // Dla klawiatury/gamepada - bezpośrednie odkrycie (pomijamy hold)
        // Symulujemy zdarzenie mousedown + mouseup z opóźnieniem lub bezpośredni click
        if(cfg.cardRevealHold){
            // Symuluj przytrzymanie
            const mousedown = new MouseEvent('mousedown', {bubbles: true});
            card.dispatchEvent(mousedown);
            setTimeout(() => {
                const mouseup = new MouseEvent('mouseup', {bubbles: true});
                card.dispatchEvent(mouseup);
            }, 250); // trochę dłużej niż CARD_HOLD_TIME
        } else {
            card.click();
        }
    }
}

function enableKeyboardMode(){
    if(!keyboardMode){
        keyboardMode = true;
        if(selectedCardIndex < 0 && $('gameScreen').style.display !== 'none'){
            updateCardSelection(0);
        }
    }
}

function disableKeyboardMode(){
    keyboardMode = false;
    const allCards = getAllCards();
    allCards.forEach(c => c.classList.remove('keyboard-selected'));
    selectedCardIndex = -1;
}

function getActiveOverlay(){
    const overlays = ['endOverlay','assassinOverlay','keyWarning','pinOverlay','captainKeyOverlay',
                      'captainBoardOverlay','closeCaptainConfirm','newRoundConfirm','backConfirm',
                      'gameSettings','globalSettingsOverlay','rulesOverlay','classicSettings','crazySettings'];
    for(const id of overlays){
        const el = $(id);
        if(el && el.style.display === 'flex') return id;
    }
    return null;
}

// Przytrzymanie klawiszy
let keyHoldTimers = {};

document.addEventListener('keydown', (e) => {
    const activeOverlay = getActiveOverlay();
    const onGameScreen = $('gameScreen').style.display !== 'none' && !activeOverlay;
    
    // Escape - zamknij overlay lub wyjdź z trybu klucza
    if(e.key === 'Escape'){
        if(activeOverlay){
            // Specjalna obsługa dla niektórych overlayów
            if(activeOverlay === 'assassinOverlay') return; // nie zamykaj
            if(activeOverlay === 'captainBoardOverlay'){
                confirmCloseCaptainBoard();
                return;
            }
            // Ustawienia trybu - wróć do menu głównego
            if(activeOverlay === 'classicSettings' || activeOverlay === 'crazySettings'){
                backToHome();
                return;
            }
            hideO(activeOverlay);
        } else if(isSpymaster){
            toggleKey();
        } else if(keyboardMode){
            disableKeyboardMode();
        }
        return;
    }
    
    // Na ekranie gry
    if(onGameScreen && !gameOver){
        // Nawigacja strzałkami / WASD
        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d','W','A','S','D'].includes(e.key)){
            e.preventDefault();
            enableKeyboardMode();
            
            switch(e.key.toLowerCase()){
                case 'arrowup': case 'w': moveSelection(0, -1); break;
                case 'arrowdown': case 's': moveSelection(0, 1); break;
                case 'arrowleft': case 'a': moveSelection(-1, 0); break;
                case 'arrowright': case 'd': moveSelection(1, 0); break;
            }
            return;
        }
        
        // Enter / Spacja - odkryj kartę
        if((e.key === 'Enter' || e.key === ' ') && keyboardMode && !isSpymaster){
            e.preventDefault();
            activateSelectedCard();
            return;
        }
        
        // K - klucz (przytrzymaj w trybie preview)
        if(e.key.toLowerCase() === 'k' && !e.repeat){
            e.preventDefault();
            if(cfg.keyMode === 'pin'){
                showO('pinOverlay');
            } else if(!isSpymaster){
                // Przytrzymanie dla trybu preview
                if(!keyHoldTimers['k']){
                    keyHoldTimers['k'] = setTimeout(()=>{
                        showO('keyWarning');
                        keyHoldTimers['k'] = null;
                    }, HOLD_TIME);
                }
            } else {
                toggleKey();
            }
            return;
        }
        
        // N - nowa runda (przytrzymaj)
        if(e.key.toLowerCase() === 'n' && !e.repeat){
            e.preventDefault();
            if(!keyHoldTimers['n']){
                keyHoldTimers['n'] = setTimeout(()=>{
                    if(!gameOver && $('board').children.length){
                        showO('newRoundConfirm');
                    } else {
                        initRound();
                    }
                    keyHoldTimers['n'] = null;
                }, HOLD_TIME);
            }
            return;
        }
        
        // P - ustawienia
        if(e.key.toLowerCase() === 'p'){
            e.preventDefault();
            showO('gameSettings');
            return;
        }
    }
    
    // Na overlayach - Enter potwierdza główną akcję
    if(activeOverlay && e.key === 'Enter'){
        e.preventDefault();
        switch(activeOverlay){
            case 'keyWarning':
                showKey();
                break;
            case 'newRoundConfirm':
                hideO('newRoundConfirm');
                initRound();
                break;
            case 'backConfirm':
                resetMatch();
                break;
            case 'captainKeyOverlay':
                verifyCaptainPin();
                break;
            case 'closeCaptainConfirm':
                hideO('closeCaptainConfirm');
                hideO('captainBoardOverlay');
                break;
            case 'gameSettings':
                hideO('gameSettings');
                break;
            case 'globalSettingsOverlay':
                hideO('globalSettingsOverlay');
                break;
            case 'rulesOverlay':
                hideO('rulesOverlay');
                break;
        }
    }
    
    // Na ekranie głównym
    if($('homeScreen').style.display === 'flex' && !activeOverlay){
        if(e.key === '1'){
            selectMode('classic');
        } else if(e.key === '2'){
            selectMode('crazy');
        }
    }
});

document.addEventListener('keyup', (e) => {
    // Anuluj hold timery
    if(e.key.toLowerCase() === 'k' && keyHoldTimers['k']){
        clearTimeout(keyHoldTimers['k']);
        keyHoldTimers['k'] = null;
    }
    if(e.key.toLowerCase() === 'n' && keyHoldTimers['n']){
        clearTimeout(keyHoldTimers['n']);
        keyHoldTimers['n'] = null;
    }
});

// Wyłącz tryb klawiatury przy kliknięciu myszą
document.addEventListener('mousedown', () => {
    if(keyboardMode) disableKeyboardMode();
});

// Reset zaznaczenia przy nowej rundzie
const origInitRound = initRound;
initRound = function(){
    disableKeyboardMode();
    origInitRound.apply(this, arguments);
};

// ==================== OBSŁUGA GAMEPADA ====================
let gamepadIndex = null;
let gamepadPrevState = {};
let gamepadHoldTimers = {};
let gamepadAxisCooldown = {x: 0, y: 0};
const AXIS_THRESHOLD = 0.5;
const AXIS_COOLDOWN = 150; // ms między ruchami

window.addEventListener('gamepadconnected', (e) => {
    console.log('Gamepad connected:', e.gamepad.id);
    gamepadIndex = e.gamepad.index;
    gamepadPrevState = {};
});

window.addEventListener('gamepaddisconnected', (e) => {
    console.log('Gamepad disconnected');
    if(gamepadIndex === e.gamepad.index){
        gamepadIndex = null;
        gamepadPrevState = {};
    }
});

function pollGamepad(){
    if(gamepadIndex === null){
        requestAnimationFrame(pollGamepad);
        return;
    }
    
    const gamepads = navigator.getGamepads();
    const gp = gamepads[gamepadIndex];
    
    if(!gp){
        requestAnimationFrame(pollGamepad);
        return;
    }
    
    const now = Date.now();
    const activeOverlay = getActiveOverlay();
    const onGameScreen = $('gameScreen').style.display !== 'none' && !activeOverlay;
    const onHomeScreen = $('homeScreen').style.display === 'flex' && !activeOverlay;
    
    // Mapowanie przycisków (Xbox / PlayStation):
    // 0 = A / X (potwierdź)
    // 1 = B / O (anuluj)
    // 2 = X / □ 
    // 3 = Y / △ (klucz)
    // 4 = LB / L1
    // 5 = RB / R1
    // 6 = LT / L2
    // 7 = RT / R2
    // 8 = Back/Select / Share
    // 9 = Start / Options (ustawienia)
    // 12 = D-pad Up
    // 13 = D-pad Down
    // 14 = D-pad Left
    // 15 = D-pad Right
    
    // Helper: sprawdź czy przycisk został właśnie wciśnięty
    const justPressed = (btnIndex) => {
        const pressed = gp.buttons[btnIndex]?.pressed;
        const wasPressed = gamepadPrevState[`btn${btnIndex}`];
        gamepadPrevState[`btn${btnIndex}`] = pressed;
        return pressed && !wasPressed;
    };
    
    // Helper: sprawdź czy przycisk jest trzymany
    const isHeld = (btnIndex) => gp.buttons[btnIndex]?.pressed;
    
    // D-pad / lewy analog - nawigacja
    let dx = 0, dy = 0;
    
    // D-pad
    if(justPressed(12)) dy = -1; // Up
    if(justPressed(13)) dy = 1;  // Down
    if(justPressed(14)) dx = -1; // Left
    if(justPressed(15)) dx = 1;  // Right
    
    // Lewy analog (z cooldown)
    const axisX = gp.axes[0] || 0;
    const axisY = gp.axes[1] || 0;
    
    if(Math.abs(axisX) > AXIS_THRESHOLD && now > gamepadAxisCooldown.x){
        dx = axisX > 0 ? 1 : -1;
        gamepadAxisCooldown.x = now + AXIS_COOLDOWN;
    }
    if(Math.abs(axisY) > AXIS_THRESHOLD && now > gamepadAxisCooldown.y){
        dy = axisY > 0 ? 1 : -1;
        gamepadAxisCooldown.y = now + AXIS_COOLDOWN;
    }
    
    // Reset cooldown gdy analog wraca do środka
    if(Math.abs(axisX) < 0.2) gamepadAxisCooldown.x = 0;
    if(Math.abs(axisY) < 0.2) gamepadAxisCooldown.y = 0;
    
    // Na planszy gry
    if(onGameScreen && !gameOver){
        // Nawigacja
        if(dx !== 0 || dy !== 0){
            enableKeyboardMode();
            moveSelection(dx, dy);
        }
        
        // A / X - odkryj kartę
        if(justPressed(0) && keyboardMode && !isSpymaster){
            activateSelectedCard();
        }
        
        // B / O - wyjdź z trybu klucza
        if(justPressed(1)){
            if(isSpymaster){
                toggleKey();
            } else if(keyboardMode){
                disableKeyboardMode();
            }
        }
        
        // Y / △ - klucz (przytrzymaj w trybie preview)
        if(justPressed(3)){
            if(cfg.keyMode === 'pin'){
                showO('pinOverlay');
            } else if(isSpymaster){
                toggleKey();
            } else {
                // Rozpocznij timer dla hold
                if(!gamepadHoldTimers['y']){
                    gamepadHoldTimers['y'] = setTimeout(()=>{
                        if(isHeld(3)){
                            showO('keyWarning');
                        }
                        gamepadHoldTimers['y'] = null;
                    }, HOLD_TIME);
                }
            }
        }
        if(!isHeld(3) && gamepadHoldTimers['y']){
            clearTimeout(gamepadHoldTimers['y']);
            gamepadHoldTimers['y'] = null;
        }
        
        // X / □ - nowa runda (przytrzymaj)
        if(justPressed(2)){
            if(!gamepadHoldTimers['x']){
                gamepadHoldTimers['x'] = setTimeout(()=>{
                    if(isHeld(2)){
                        if(!gameOver && $('board').children.length){
                            showO('newRoundConfirm');
                        } else {
                            initRound();
                        }
                    }
                    gamepadHoldTimers['x'] = null;
                }, HOLD_TIME);
            }
        }
        if(!isHeld(2) && gamepadHoldTimers['x']){
            clearTimeout(gamepadHoldTimers['x']);
            gamepadHoldTimers['x'] = null;
        }
        
        // Start - ustawienia
        if(justPressed(9)){
            showO('gameSettings');
        }
    }
    
    // Na overlayach
    if(activeOverlay){
        // A - potwierdź
        if(justPressed(0)){
            switch(activeOverlay){
                case 'keyWarning':
                    showKey();
                    break;
                case 'newRoundConfirm':
                    hideO('newRoundConfirm');
                    initRound();
                    break;
                case 'backConfirm':
                    resetMatch();
                    break;
                case 'closeCaptainConfirm':
                    hideO('closeCaptainConfirm');
                    hideO('captainBoardOverlay');
                    break;
                case 'gameSettings':
                    hideO('gameSettings');
                    break;
                case 'globalSettingsOverlay':
                    hideO('globalSettingsOverlay');
                    break;
                case 'rulesOverlay':
                    hideO('rulesOverlay');
                    break;
                case 'endOverlay':
                    if($('nextRoundBtn').style.display !== 'none'){
                        hideO('endOverlay');
                        initRound();
                    } else {
                        resetMatch();
                    }
                    break;
            }
        }
        
        // B - anuluj/zamknij
        if(justPressed(1)){
            if(activeOverlay === 'assassinOverlay') {
                // Nie zamykaj - trzeba wybrać drużynę
            } else if(activeOverlay === 'captainBoardOverlay'){
                confirmCloseCaptainBoard();
            } else if(activeOverlay === 'closeCaptainConfirm'){
                hideO('closeCaptainConfirm');
            } else if(activeOverlay === 'classicSettings' || activeOverlay === 'crazySettings'){
                backToHome();
            } else {
                hideO(activeOverlay);
            }
        }
        
        // Assassin overlay - LB/RB do wyboru drużyny
        if(activeOverlay === 'assassinOverlay'){
            if(justPressed(4)){ // LB - czerwoni
                assassinHit('red');
            }
            if(justPressed(5)){ // RB - niebiescy
                assassinHit('blue');
            }
        }
    }
    
    // Na ekranie głównym
    if(onHomeScreen){
        // A lub nawigacja w prawo - tryb klasyczny (lewy kafelek)
        // Nawigacja do wyboru trybu
        if(justPressed(0) || justPressed(14)){ // A lub D-pad Left
            selectMode('classic');
        }
        if(justPressed(15)){ // D-pad Right
            selectMode('crazy');
        }
        
        // Start - ustawienia
        if(justPressed(9)){
            showGlobalSettings();
        }
        
        // Y - klucz kapitana
        if(justPressed(3)){
            showCaptainKeyOverlay();
        }
    }
    
    requestAnimationFrame(pollGamepad);
}

// Rozpocznij nasłuchiwanie gamepada
requestAnimationFrame(pollGamepad);

// ANCHOR: FIREBASE_CONFIG
const firebaseConfig = {
    apiKey: "AIzaSyBYFHH9yP_0N0X14_2ooRyhZeXGhR36wIs",
    authDomain: "partyhub-6e16c.firebaseapp.com",
    databaseURL: "https://partyhub-6e16c-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "partyhub-6e16c",
    storageBucket: "partyhub-6e16c.firebasestorage.app",
    messagingSenderId: "58335201591",
    appId: "1:58335201591:web:7c8ab8298ff12beb3cb2b2"
};

// Inicjalizacja Firebase (gotowe do użycia w trybie online)
let db = null;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    console.log('Firebase gotowy');
} catch(e) {
    console.log('Firebase niedostępny - tryb offline');
}
</script>
</body>
</html>
