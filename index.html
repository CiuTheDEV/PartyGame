<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tajniacy</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:#1a1a1a;color:#fff;text-align:center;padding:0;display:flex;flex-direction:column}
body.game-active{height:100vh;height:100dvh;overflow:hidden}

/* GAME SCREEN - nowy layout */
#gameScreen{display:none;flex-direction:column;height:100%;overflow:hidden}

.top-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:clamp(5px,1vh,15px) clamp(10px,2vw,30px);
    background:linear-gradient(180deg,#252525,#1a1a1a);
    flex-shrink:0;
    gap:clamp(10px,2vw,30px);
}

.team-bar{
    display:flex;
    align-items:center;
    gap:clamp(8px,1.5vw,20px);
    padding:clamp(8px,1.5vh,20px) clamp(15px,2.5vw,35px);
    border-radius:clamp(8px,1vw,15px);
    flex:1;
    max-width:40%;
}
.team-bar.red{
    background:linear-gradient(135deg,rgba(231,76,60,0.3),rgba(231,76,60,0.1));
    border:2px solid #e74c3c;
    justify-content:flex-start;
}
.team-bar.blue{
    background:linear-gradient(135deg,rgba(52,152,219,0.1),rgba(52,152,219,0.3));
    border:2px solid #3498db;
    justify-content:flex-end;
}

.team-bar .team-emoji{font-size:clamp(1.5rem,4vmin,3.5rem)}
.team-bar .team-name{
    font-size:clamp(1rem,2.5vmin,2rem);
    font-weight:bold;
    flex:1;
    min-width:0;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
}
.team-bar.red .team-name{color:#e74c3c;text-align:left}
.team-bar.blue .team-name{color:#3498db;text-align:right}
.team-bar .team-score{
    font-size:clamp(1.5rem,4vmin,3.5rem);
    font-weight:bold;
    min-width:clamp(40px,5vmin,80px);
    text-align:center;
    padding:clamp(3px,0.5vmin,8px) clamp(10px,1.5vmin,20px);
    border-radius:clamp(6px,0.8vmin,12px);
    flex-shrink:0;
}
.team-bar.red .team-score{background:#e74c3c}
.team-bar.blue .team-score{background:#3498db}

.top-controls{
    display:flex;
    gap:clamp(5px,1vw,15px);
    flex-shrink:0;
}

.icon-btn{
    width:clamp(40px,6vmin,70px);
    height:clamp(40px,6vmin,70px);
    border-radius:clamp(8px,1vmin,15px);
    border:none;
    background:#333;
    color:#fff;
    font-size:clamp(1.2rem,3vmin,2.5rem);
    cursor:pointer;
    transition:background .2s;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    position:relative;
}
.icon-btn span{position:relative;z-index:2}
.icon-btn svg.hold-progress{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    z-index:1;
}
.icon-btn svg.hold-progress path{
    fill:none;
    stroke:#4CAF50;
    stroke-width:4;
    stroke-dasharray:1000;
    stroke-dashoffset:1000;
}
.icon-btn:hover{background:#444}
.icon-btn.active{background:#FF9800;box-shadow:0 0 15px rgba(255,152,0,0.5)}

.board-container{
    flex-grow:1;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:clamp(5px,1vmin,15px);
    min-height:0;
    overflow:hidden;
}

.grid-container{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    grid-template-rows:repeat(5,1fr);
    gap:clamp(4px,0.8vmin,12px);
    width:100%;
    height:100%;
}

.card{
    perspective:1000px;
    background:transparent;
    border-radius:clamp(8px,1.5vmin,20px);
    cursor:pointer;
    user-select:none;
    transition:transform .15s,box-shadow .15s;
}
.card:hover{transform:translateY(-3px) scale(1.02)}
.card.keyboard-selected{
    transform:translateY(-3px) scale(1.02);
    outline:3px solid #FFD700;
    outline-offset:2px;
    box-shadow:0 0 20px rgba(255,215,0,0.5);
}
.card.holding{
    transform:scale(0.95);
    transition:transform 0.1s;
}
.card.holding .card-inner{
    box-shadow:0 0 15px rgba(255,255,255,0.3);
}

.card-inner{
    position:relative;
    width:100%;
    height:100%;
    transform-style:preserve-3d;
    transition:transform 0.6s ease;
}
.card.flipped .card-inner{
    transform:rotateY(180deg);
}

.card-front,.card-back{
    position:absolute;
    inset:0;
    backface-visibility:hidden;
    -webkit-backface-visibility:hidden;
    border-radius:clamp(8px,1.5vmin,20px);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:clamp(14px,4vmin,52px);
    font-weight:bold;
    text-transform:uppercase;
    padding:clamp(5px,1vmin,15px);
    text-align:center;
    word-break:break-word;
    overflow:hidden;
    box-shadow:0 clamp(2px,0.4vmin,6px) clamp(4px,0.8vmin,12px) rgba(0,0,0,0.3);
    letter-spacing:0.5px;
}

.card-back{
    background:linear-gradient(135deg,#3a3a3a,#2a2a2a);
    border:2px solid #4a4a4a;
}
.card-back::before{
    content:'?';
    font-size:clamp(24px,6vmin,60px);
    color:#555;
    font-weight:bold;
}

.card-front{
    transform:rotateY(180deg);
    background:#f5f5f5;
    color:#222;
    border:2px solid transparent;
}

/* Style talii - awers */
.deck-white .card-front{background:#f5f5f5;color:#222}
.deck-classic .card-front{background:#2a2a2a;color:#f0f0f0;border:2px solid #3a3a3a}
.deck-night .card-front{background:linear-gradient(145deg,#1a1a2e,#0d0d18);color:#d0d0f0;border:2px solid #2a2a4e}

/* Obram√≥wka zab√≥jcy w bia≈Çej talii */
.deck-white .card.is-assassin .card-front{border:2px solid #ddd}

/* Style talii - rewers */
.deck-white .card-back{background:linear-gradient(135deg,#e8e8e8,#d0d0d0);border-color:#ccc}
.deck-white .card-back::before{color:#aaa}
.deck-classic .card-back{background:linear-gradient(135deg,#1a1a1a,#0a0a0a);border-color:#3a3a3a}
.deck-classic .card-back::before{color:#444}
.deck-night .card-back{background:linear-gradient(135deg,#0d0d18,#05050a);border-color:#2a2a4e}
.deck-night .card-back::before{color:#3a3a5e}

.is-red{--true:#e74c3c;--text:#fff;--soft:rgba(231,76,60,0.7)}
.is-blue{--true:#3498db;--text:#fff;--soft:rgba(52,152,219,0.7)}
.is-neutral{--true:#7f8c8d;--text:#fff;--soft:rgba(127,140,141,0.5)}
.is-assassin{--true:#1a1a1a;--text:#fff;--soft:rgba(20,20,20,0.9)}

.card.revealed .card-front{
    background:var(--true)!important;
    color:var(--text)!important;
    cursor:default;
    box-shadow:inset 0 0 clamp(15px,3vmin,40px) rgba(0,0,0,0.3);
    text-shadow:2px 2px 4px rgba(0,0,0,0.5);
    border-color:var(--true)!important;
}
.card.revealed:hover{transform:none}

/* Tryb klucza - pe≈Çne t≈Ço w stonowanych kolorach */
body.spymaster-mode .card .card-front{
    background:var(--soft)!important;
    color:#fff!important;
    text-shadow:1px 1px 3px rgba(0,0,0,0.5);
}
body.spymaster-mode .card:hover{
    transform:none;
}
body.spymaster-mode .card.is-assassin .card-front{
    color:#e74c3c!important;
    text-shadow:0 0 10px rgba(0,0,0,0.8);
    flex-direction:column;
    gap:clamp(2px,0.5vmin,8px);
}
body.spymaster-mode .card.is-assassin .card-front::after{
    content:'‚ò†';
    font-size:clamp(16px,3.5vmin,40px);
    opacity:0.9;
}
body.spymaster-mode .card.is-assassin.revealed .card-front::after{
    display:none;
}
body.spymaster-mode .card.revealed .card-front{
    background:var(--true)!important;
    box-shadow:inset 0 0 clamp(15px,3vmin,40px) rgba(0,0,0,0.3);
}

.bottom-bar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:clamp(5px,1vh,12px) clamp(10px,2vw,30px);
    background:linear-gradient(0deg,#252525,#1a1a1a);
    flex-shrink:0;
    gap:clamp(5px,1vw,20px);
    overflow:hidden;
}

.remaining-cards{
    display:flex;
    gap:clamp(2px,0.4vmin,8px);
    align-items:center;
    flex-shrink:1;
    min-width:0;
    flex-wrap:wrap;
    max-width:45%;
}
.remaining-cards.red{justify-content:flex-start}
.remaining-cards.blue{flex-direction:row-reverse;justify-content:flex-start}

.remaining-card{
    width:clamp(28px,4vmin,55px);
    height:clamp(36px,5.5vmin,70px);
    border-radius:clamp(4px,0.6vmin,10px);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    transition:all .3s;
    box-shadow:0 2px 5px rgba(0,0,0,0.3);
    gap:1px;
    flex-shrink:0;
}
.remaining-card .card-emoji{font-size:clamp(0.8rem,2vmin,1.6rem)}
.remaining-card .card-num{font-weight:bold;opacity:0.9;font-size:clamp(0.65rem,1.5vmin,1.2rem)}
.remaining-cards.red .remaining-card{background:#e74c3c}
.remaining-cards.blue .remaining-card{background:#3498db}
.remaining-card.revealed{opacity:0.2;transform:scale(0.85)}

#status{
    font-size:clamp(0.9rem,2.5vmin,1.8rem);
    font-weight:bold;
    white-space:nowrap;
    padding:0 clamp(10px,2vw,30px);
}
#status .team-red{color:#e74c3c}
#status .team-blue{color:#3498db}

/* OVERLAYS */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:999;padding:2vh 2vw;overflow-y:auto}
.home-container{max-width:min(900px,90vw);width:90%}
.home-title{font-size:clamp(2.5rem,8vmin,5rem);margin-bottom:2vh;background:linear-gradient(135deg,#e74c3c,#3498db);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.home-subtitle{font-size:clamp(1rem,3vmin,2rem);color:#aaa;margin-bottom:4vh}
.mode-selection{display:flex;flex-direction:column;gap:clamp(10px,2vmin,20px);margin-bottom:3vh}
.mode-card{
    background:linear-gradient(135deg,#2a2a2a,#1a1a1a);
    border-radius:clamp(12px,2vmin,20px);
    transition:all .3s;
    border:2px solid transparent;
    overflow:hidden;
}
.mode-card:hover{box-shadow:0 5px 20px rgba(0,0,0,.4)}
.mode-card.classic{border-color:#4CAF50}
.mode-card.crazy{border-color:#FF9800}
.mode-card.wip{border-color:#9E9E9E}

.mode-header{
    display:flex;
    align-items:center;
    padding:clamp(12px,2.5vmin,25px) clamp(15px,3vmin,30px);
    position:relative;
    cursor:pointer;
}
.mode-icon{
    font-size:clamp(2rem,5vmin,3.5rem);
    position:absolute;
    left:clamp(15px,3vmin,30px);
}
.mode-title-wrapper{
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:clamp(8px,1.5vmin,15px);
}
.mode-title{
    font-size:clamp(1.3rem,3.5vmin,2.2rem);
    font-weight:bold;
}
.mode-card.classic .mode-title{color:#4CAF50}
.mode-card.crazy .mode-title{color:#FF9800}
.mode-card.wip .mode-title{color:#9E9E9E}

.mode-arrow{
    position:absolute;
    right:clamp(15px,3vmin,30px);
    font-size:clamp(0.8rem,2vmin,1.2rem);
    color:#666;
    transition:transform .3s;
}
.mode-card.open .mode-arrow{transform:rotate(180deg)}

.mode-wip-badge{
    background:#9E9E9E;
    color:#1a1a1a;
    font-size:clamp(0.6rem,1.5vmin,0.8rem);
    font-weight:bold;
    padding:clamp(3px,0.5vmin,5px) clamp(8px,1.2vmin,12px);
    border-radius:clamp(4px,0.8vmin,8px);
    text-transform:uppercase;
    letter-spacing:1px;
}
.mode-arrow{
    position:absolute;
    right:clamp(15px,3vmin,30px);
    font-size:clamp(0.8rem,2vmin,1.2rem);
    color:#666;
    transition:transform .3s ease;
}
.mode-card.open .mode-arrow{transform:rotate(180deg)}

.mode-content{
    display:grid;
    grid-template-rows:0fr;
    transition:grid-template-rows .3s ease;
    border-top:1px solid transparent;
}
.mode-card.open .mode-content{
    grid-template-rows:1fr;
    border-top-color:#333;
}
.mode-content-inner{
    overflow:hidden;
    display:flex;
    flex-direction:row;
    align-items:flex-end;
    justify-content:space-between;
    gap:clamp(15px,3vmin,25px);
}
.mode-card.open .mode-content-inner{
    padding:clamp(12px,2vmin,20px) clamp(15px,3vmin,30px);
    background:rgba(0,0,0,0.2);
}
.mode-content-inner{
    padding:0 clamp(15px,3vmin,30px);
    transition:padding .3s ease, background .3s ease;
}

.mode-details{
    flex:1;
    min-width:0;
    opacity:0;
    transform:translateY(-10px);
    transition:opacity .3s ease .1s, transform .3s ease .1s;
}
.mode-card.open .mode-details{
    opacity:1;
    transform:translateY(0);
}

.mode-buttons{
    display:flex;
    gap:clamp(8px,1.5vmin,12px);
    flex-shrink:0;
    align-self:flex-end;
    opacity:0;
    transform:translateX(10px);
    transition:opacity .3s ease .15s, transform .3s ease .15s;
}
.mode-card.open .mode-buttons{
    opacity:1;
    transform:translateX(0);
}

.mode-description{
    font-size:clamp(0.9rem,2vmin,1.1rem);
    color:#aaa;
    margin-bottom:clamp(6px,1vmin,10px);
}
.mode-features{
    text-align:left;
    font-size:clamp(0.8rem,1.8vmin,1rem);
    color:#888;
    list-style:none;
    padding:0;
    margin:0;
}
.mode-features li{
    margin:clamp(2px,0.5vmin,5px) 0;
    padding-left:1em;
    position:relative;
}
.mode-features li::before{
    content:'‚Ä¢';
    position:absolute;
    left:0;
    color:#666;
}

.mode-btn{
    width:clamp(40px,7vmin,55px);
    height:clamp(40px,7vmin,55px);
    border-radius:50%;
    border:2px solid #666;
    background:rgba(0,0,0,0.3);
    color:#aaa;
    font-size:clamp(1.1rem,2.5vmin,1.5rem);
    font-weight:bold;
    cursor:pointer;
    transition:all .2s;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
}
.mode-btn.info{
    font-style:italic;
    font-family:Georgia,serif;
}
.mode-btn:hover{
    background:rgba(255,255,255,0.1);
    border-color:#aaa;
    color:#fff;
    transform:scale(1.1);
}
.mode-card.classic .mode-btn.play{border-color:#4CAF50;color:#4CAF50}
.mode-card.classic .mode-btn.play:hover{background:#4CAF50;color:#fff}
.mode-card.crazy .mode-btn.play{border-color:#FF9800;color:#FF9800}
.mode-card.crazy .mode-btn.play:hover{background:#FF9800;color:#fff}
.mode-card.wip .mode-btn.play{border-color:#9E9E9E;color:#9E9E9E}
.mode-card.wip .mode-btn.play:hover{background:#9E9E9E;color:#fff}
.mode-btn.disabled{
    opacity:0.4;
    cursor:not-allowed;
}
.mode-btn.disabled:hover{
    transform:none;
    background:rgba(0,0,0,0.3);
}

/* Rules overlay */
.rules-container{
    background:#2a2a2a;
    border-radius:clamp(15px,2vmin,25px);
    padding:clamp(20px,4vmin,40px);
    max-width:min(600px,90vw);
    width:90%;
    max-height:85vh;
    overflow-y:auto;
    text-align:left;
}
.rules-title{
    font-size:clamp(1.5rem,4vmin,2.5rem);
    margin-bottom:clamp(15px,3vmin,25px);
    text-align:center;
    background:linear-gradient(135deg,#e74c3c,#3498db);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
}
.rules-content{
    font-size:clamp(0.9rem,2.2vmin,1.1rem);
    color:#ccc;
    line-height:1.6;
}
.rules-content h3{
    color:#fff;
    font-size:clamp(1.1rem,2.5vmin,1.4rem);
    margin:clamp(15px,2.5vmin,25px) 0 clamp(8px,1.5vmin,12px);
}
.rules-content h3:first-child{margin-top:0}
.rules-content p{margin:clamp(8px,1.5vmin,12px) 0}
.rules-content ul{
    margin:clamp(8px,1.5vmin,12px) 0;
    padding-left:clamp(20px,3vmin,30px);
}
.rules-content li{margin:clamp(4px,0.8vmin,8px) 0}
.rules-content .highlight{
    color:#4CAF50;
    font-weight:bold;
}
.rules-content .danger{
    color:#e74c3c;
    font-weight:bold;
}
.rules-content .info{
    color:#3498db;
}
.rules-container button{
    display:block;
    margin:clamp(20px,3vmin,30px) auto 0;
}

/* SETTINGS */
.settings-container{background:#2a2a2a;border-radius:clamp(15px,2vmin,25px);padding:clamp(15px,3vmin,40px);max-width:min(800px,95vw);width:95%;max-height:90vh;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.settings-container::-webkit-scrollbar{width:6px}
.settings-container::-webkit-scrollbar-track{background:#1a1a1a;border-radius:3px}
.settings-container::-webkit-scrollbar-thumb{background:#555;border-radius:3px}
.settings-title{font-size:clamp(1.5rem,4vmin,2.5rem);margin-bottom:2vh;background:linear-gradient(135deg,#e74c3c,#3498db);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.team-setup{display:grid;grid-template-columns:1fr;gap:clamp(10px,2vmin,20px);margin-bottom:2vh}
@media(min-width:600px){.team-setup{grid-template-columns:1fr 1fr}}
.team-card{background:#1a1a1a;border-radius:clamp(8px,1.2vmin,15px);padding:clamp(12px,2vmin,25px);border:2px solid}
.team-card.red{border-color:#e74c3c}.team-card.blue{border-color:#3498db}
.team-card h3{margin:0 0 clamp(8px,1.5vmin,15px);font-size:clamp(1rem,2.5vmin,1.6rem)}
.team-card.red h3{color:#e74c3c}.team-card.blue h3{color:#3498db}
.avatar-picker{display:grid;grid-template-columns:repeat(4,1fr);gap:clamp(4px,1vmin,10px);margin-bottom:clamp(8px,1.5vmin,15px)}
.avatar-option{
    font-size:clamp(1.2rem,3.5vmin,2.5rem);
    aspect-ratio:1;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#333;
    border-radius:clamp(6px,1vmin,12px);
    cursor:pointer;
    transition:all .2s;
    border:2px solid transparent;
    padding:0;
}
.avatar-option:hover{background:#444}
.avatar-option.selected{border-color:#4CAF50;background:#2d5016}
.team-card input{
    width:100%;
    padding:clamp(8px,1.2vmin,12px);
    font-size:clamp(0.9rem,2vmin,1.2rem);
    border-radius:clamp(6px,1vmin,10px);
    border:none;
    text-align:center;
    background:#333;
    color:#fff;
    -webkit-appearance:none;
    appearance:none;
}
.game-settings{background:#1a1a1a;border-radius:clamp(8px,1.2vmin,15px);padding:clamp(12px,2vmin,25px);margin-bottom:2vh;overflow:hidden}
.game-settings h3{color:#FF9800;margin-bottom:clamp(10px,1.5vmin,15px);font-size:clamp(1rem,2.2vmin,1.4rem)}
.setting-row{display:flex;justify-content:space-between;align-items:center;margin:clamp(6px,1vmin,12px) 0;padding:clamp(8px,1.2vmin,12px);background:#2a2a2a;border-radius:clamp(6px,1vmin,10px);flex-wrap:wrap;gap:8px;box-sizing:border-box;max-width:100%}
.setting-row label{font-size:clamp(0.85rem,2vmin,1.2rem);color:#ccc}
.setting-row input,.setting-row select{
    padding:clamp(6px,1vmin,10px);
    font-size:clamp(0.85rem,1.8vmin,1.1rem);
    border-radius:clamp(4px,0.6vmin,8px);
    border:none;
    background:#333;
    color:#fff;
    min-width:80px;
    max-width:120px;
    text-align:center;
    -webkit-appearance:none;
    appearance:none;
}

/* Toggle switch */
.toggle-switch{
    position:relative;
    display:inline-block;
    width:clamp(50px,8vmin,60px);
    height:clamp(26px,4vmin,32px);
    flex-shrink:0;
}
.toggle-switch input{
    opacity:0;
    width:0;
    height:0;
    position:absolute;
}
.toggle-slider{
    position:absolute;
    cursor:pointer;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:#555;
    transition:.3s;
    border-radius:clamp(13px,2vmin,16px);
}
.toggle-slider:before{
    position:absolute;
    content:"";
    height:clamp(20px,3vmin,26px);
    width:clamp(20px,3vmin,26px);
    left:3px;
    bottom:3px;
    background:#fff;
    transition:.3s;
    border-radius:50%;
}
.toggle-switch input:checked + .toggle-slider{
    background:#4CAF50;
}
.toggle-switch input:checked + .toggle-slider:before{
    transform:translateX(clamp(24px,4vmin,28px));
}

/* Keymode toggle */
.keymode-toggle{
    display:flex;
    align-items:center;
    gap:clamp(8px,1.5vmin,12px);
}
.keymode-label{
    font-size:clamp(1.2rem,3vmin,1.8rem);
    opacity:0.5;
    transition:opacity .3s;
}
.keymode-label.left.active,
.keymode-label.right.active{
    opacity:1;
}
.keymode-switch .toggle-slider{
    background:#3498db;
}
.keymode-switch input:checked + .toggle-slider{
    background:#FF9800;
}

.card-reveal-switch .toggle-slider{
    background:#4CAF50;
}
.card-reveal-switch input:checked + .toggle-slider{
    background:#9C27B0;
}
.card-reveal-label{
    font-size:clamp(1rem,2.5vmin,1.5rem)!important;
}

/* Style picker */
.style-row{flex-direction:column;align-items:stretch;padding:0;background:transparent;overflow:hidden;max-width:100%}
.style-selector{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:clamp(8px,1.5vmin,15px);
    background:#2a2a2a;
    border-radius:clamp(6px,1vmin,12px);
    cursor:pointer;
    transition:all .2s;
}
.style-selector:hover{background:#333}
.style-selector label{font-size:clamp(1rem,2.5vmin,1.4rem);color:#ccc;pointer-events:none}
.style-current{display:flex;align-items:center;gap:10px}
.style-current span:first-child{color:#fff;font-size:clamp(0.95rem,2.2vmin,1.3rem)}
.style-arrow{color:#888;font-size:0.8rem;transition:transform .3s}
.style-row.open .style-arrow{transform:rotate(180deg)}
.style-picker{
    display:none;
    gap:clamp(8px,1.5vmin,15px);
    background:#222;
    border-radius:clamp(6px,1vmin,12px);
    flex-wrap:wrap;
    justify-content:center;
    padding:clamp(10px,2vmin,15px);
    margin-top:clamp(8px,1.5vmin,12px);
}
.style-row.open .style-picker{display:flex}
.style-option{
    cursor:pointer;
    padding:clamp(10px,1.5vmin,15px);
    border-radius:clamp(8px,1vmin,12px);
    border:2px solid transparent;
    background:#1a1a1a;
    transition:all .2s;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:clamp(6px,1vmin,10px);
}
.style-option:hover{border-color:#666;background:#252525}
.style-option.selected{border-color:#4CAF50;background:#1a2a1a}
.style-preview{
    display:flex;
    gap:clamp(4px,0.8vmin,8px);
    padding:clamp(6px,1vmin,12px);
    border-radius:clamp(6px,0.8vmin,10px);
    background:#111;
}
.preview-card{
    width:clamp(35px,6vmin,55px);
    height:clamp(45px,8vmin,70px);
    border-radius:clamp(4px,0.6vmin,8px);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:clamp(0.5rem,1.2vmin,0.75rem);
    font-weight:bold;
    text-transform:uppercase;
    box-shadow:0 2px 4px rgba(0,0,0,0.3);
}
.deck-white .preview-card{background:#f5f5f5;color:#222}
.deck-classic .preview-card{background:#2a2a2a;color:#f0f0f0;border:1px solid #3a3a3a}
.deck-night .preview-card{background:linear-gradient(145deg,#1a1a2e,#0d0d18);color:#d0d0f0;border:1px solid #2a2a4e}
.preview-card.revealed.is-red{background:#e74c3c!important;color:#fff!important}
.preview-card.revealed.is-blue{background:#3498db!important;color:#fff!important}
.style-name{font-size:clamp(0.9rem,1.8vmin,1.1rem);color:#ccc}

/* Deck picker */
.deck-row{flex-direction:column;align-items:stretch;padding:0;background:transparent;overflow:hidden;max-width:100%}
.deck-selector{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:clamp(8px,1.5vmin,15px);
    background:#2a2a2a;
    border-radius:clamp(6px,1vmin,12px);
    cursor:pointer;
    transition:all .2s;
}
.deck-selector:hover{background:#333}
.deck-selector label{font-size:clamp(1rem,2.5vmin,1.4rem);color:#ccc;pointer-events:none}
.deck-current{display:flex;align-items:center;gap:10px}
.deck-current span:first-child{color:#fff;font-size:clamp(0.95rem,2.2vmin,1.3rem)}
.deck-arrow{color:#888;font-size:0.8rem;transition:transform .3s}
.deck-row.open .deck-arrow{transform:rotate(180deg)}
.deck-picker{
    display:none;
    flex-direction:column;
    gap:clamp(8px,1.5vmin,12px);
    background:#222;
    border-radius:clamp(6px,1vmin,12px);
    padding:clamp(10px,2vmin,15px);
    margin-top:clamp(8px,1.5vmin,12px);
}
.deck-row.open .deck-picker{display:flex}
.deck-option{
    cursor:pointer;
    padding:clamp(12px,2vmin,18px);
    border-radius:clamp(8px,1vmin,12px);
    border:2px solid transparent;
    background:#1a1a1a;
    transition:all .2s;
}
.deck-option:hover{border-color:#666;background:#252525}
.deck-option.selected{border-color:#4CAF50;background:#1a2a1a}
.deck-info{display:flex;flex-direction:column;gap:6px}
.deck-title{font-size:clamp(1rem,2vmin,1.3rem);color:#fff;font-weight:bold}
.deck-desc{font-size:clamp(0.8rem,1.6vmin,1rem);color:#888;line-height:1.4}

/* Rounds picker */
.rounds-row{flex-direction:column;align-items:stretch;padding:0;background:transparent;overflow:hidden;max-width:100%}
.rounds-selector{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:clamp(8px,1.5vmin,15px);
    background:#2a2a2a;
    border-radius:clamp(6px,1vmin,12px);
    cursor:pointer;
    transition:all .2s;
}
.rounds-selector:hover{background:#333}
.rounds-selector label{font-size:clamp(1rem,2.5vmin,1.4rem);color:#ccc;pointer-events:none}
.rounds-current{display:flex;align-items:center;gap:10px}
.rounds-current span:first-child{color:#fff;font-size:clamp(0.95rem,2.2vmin,1.3rem)}
.rounds-arrow{color:#888;font-size:0.8rem;transition:transform .3s}
.rounds-row.open .rounds-arrow{transform:rotate(180deg)}
.rounds-picker{
    display:none;
    flex-direction:column;
    gap:clamp(10px,1.5vmin,15px);
    background:#222;
    border-radius:clamp(6px,1vmin,12px);
    padding:clamp(10px,2vmin,15px);
    margin-top:clamp(8px,1.5vmin,12px);
}
.rounds-row.open .rounds-picker{display:flex}
.rounds-options{
    display:flex;
    gap:clamp(6px,1vmin,12px);
    flex-wrap:wrap;
    justify-content:center;
}
.rounds-option{
    width:clamp(40px,7vmin,60px);
    height:clamp(40px,7vmin,60px);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:clamp(1.1rem,2.5vmin,1.6rem);
    font-weight:bold;
    color:#fff;
    background:#1a1a1a;
    border:2px solid transparent;
    border-radius:clamp(8px,1vmin,12px);
    cursor:pointer;
    transition:all .2s;
}
.rounds-option:hover{border-color:#666;background:#252525}
.rounds-option.selected{border-color:#4CAF50;background:#1a2a1a}
.rounds-option.custom{font-size:clamp(1.5rem,3vmin,2rem);color:#888}
.rounds-custom{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:clamp(8px,1.5vmin,12px);
    padding-top:clamp(10px,1.5vmin,15px);
    border-top:1px solid #333;
}
.rounds-custom label{font-size:clamp(0.9rem,2vmin,1.1rem);color:#888}
.rounds-custom input{
    width:clamp(70px,12vmin,100px);
    padding:clamp(8px,1.5vmin,12px);
    font-size:clamp(1rem,2.2vmin,1.3rem);
    border-radius:clamp(5px,0.8vmin,10px);
    border:2px solid #4CAF50;
    background:#1a2a1a;
    color:#fff;
    text-align:center;
}

/* Generic picker */
.picker-row{flex-direction:column;align-items:stretch;padding:0;background:transparent;overflow:hidden;max-width:100%}
.picker-selector{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:clamp(8px,1.5vmin,15px);
    background:#2a2a2a;
    border-radius:clamp(6px,1vmin,12px);
    cursor:pointer;
    transition:all .2s;
}
.picker-selector:hover{background:#333}
.picker-selector label{font-size:clamp(1rem,2.5vmin,1.4rem);color:#ccc;pointer-events:none}
.picker-current{display:flex;align-items:center;gap:10px}
.picker-current span:first-child{color:#fff;font-size:clamp(0.95rem,2.2vmin,1.3rem)}
.picker-arrow{color:#888;font-size:0.8rem;transition:transform .3s}
.picker-row.open .picker-arrow{transform:rotate(180deg)}
.picker-panel{
    display:none;
    flex-direction:column;
    gap:clamp(10px,1.5vmin,15px);
    background:#222;
    border-radius:clamp(6px,1vmin,12px);
    padding:clamp(10px,2vmin,15px);
    margin-top:clamp(8px,1.5vmin,12px);
}
.picker-row.open .picker-panel{display:flex}
.picker-options{
    display:flex;
    gap:clamp(6px,1vmin,12px);
    flex-wrap:wrap;
    justify-content:center;
}
.picker-option{
    min-width:clamp(40px,7vmin,60px);
    height:clamp(40px,7vmin,60px);
    padding:0 clamp(10px,1.5vmin,15px);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:clamp(1rem,2.2vmin,1.4rem);
    font-weight:bold;
    color:#fff;
    background:#1a1a1a;
    border:2px solid transparent;
    border-radius:clamp(8px,1vmin,12px);
    cursor:pointer;
    transition:all .2s;
}
.picker-option:hover{border-color:#666;background:#252525}
.picker-option.selected{border-color:#4CAF50;background:#1a2a1a}
.picker-option.disabled{opacity:0.5;cursor:not-allowed;pointer-events:none}
.keymode-options .picker-option{min-width:auto;padding:0 clamp(12px,2vmin,20px)}
.starter-options .picker-option{min-width:auto;padding:0 clamp(15px,2vmin,25px)}
.picker-info{
    text-align:center;
    font-size:clamp(0.9rem,2vmin,1.1rem);
    color:#888;
    padding-top:clamp(8px,1.5vmin,12px);
    border-top:1px solid #333;
}
.picker-info span{color:#4CAF50;font-weight:bold}
.button-group{display:flex;gap:clamp(10px,2vmin,20px);margin-top:2vh;flex-wrap:wrap}

button{padding:clamp(10px,2vh,20px) clamp(20px,3vw,40px);font-size:clamp(1rem,2.5vmin,1.5rem);border:none;border-radius:clamp(8px,1vmin,15px);font-weight:bold;cursor:pointer;transition:transform .2s}
button:hover{transform:scale(1.05)}button:active{transform:scale(.95)}
.btn-new{background:#4CAF50;color:#fff}
.btn-key{background:#FF9800;color:#fff}
.btn-reset{background:#e74c3c;color:#fff}

/* PIN OVERLAY */
.pin-display{
    font-size:clamp(3rem,10vmin,5rem);
    font-weight:bold;
    letter-spacing:clamp(10px,3vmin,20px);
    color:#4CAF50;
    background:#1a1a1a;
    padding:clamp(15px,3vmin,30px) clamp(30px,5vmin,50px);
    border-radius:clamp(10px,1.5vmin,20px);
    border:3px solid #4CAF50;
    margin:clamp(15px,3vmin,25px) 0;
    text-align:center;
    font-family:'Courier New',monospace;
}
.pin-input-section{
    background:#1a1a1a;
    padding:clamp(15px,2.5vmin,25px);
    border-radius:clamp(10px,1.5vmin,20px);
    margin-top:clamp(10px,2vmin,20px);
}
.pin-input-container{
    display:flex;
    justify-content:center;
}
#pinInput{
    font-size:clamp(2rem,6vmin,3rem);
    font-weight:bold;
    letter-spacing:clamp(8px,2vmin,15px);
    text-align:center;
    width:clamp(150px,40vmin,200px);
    padding:clamp(10px,2vmin,15px);
    border:3px solid #555;
    border-radius:clamp(8px,1vmin,12px);
    background:#2a2a2a;
    color:#fff;
    font-family:'Courier New',monospace;
    transition:border-color .2s;
}
#pinInput:focus{
    outline:none;
    border-color:#FF9800;
}
#pinInput.error{
    border-color:#e74c3c;
    animation:shake 0.3s;
}
#pinInput.success{
    border-color:#4CAF50;
}

#captainPinInput{
    font-size:clamp(2rem,7vmin,3.5rem);
    font-weight:bold;
    letter-spacing:clamp(5px,1.5vmin,12px);
    text-align:center;
    width:clamp(180px,50vmin,250px);
    padding:clamp(12px,2.5vmin,20px) clamp(15px,3vmin,30px);
    border:3px solid #4CAF50;
    border-radius:clamp(10px,1.5vmin,20px);
    background:#1a1a1a;
    color:#4CAF50;
    font-family:'Courier New',monospace;
    transition:border-color .2s, color .2s;
}
#captainPinInput::placeholder{
    color:#2d5a2d;
}
#captainPinInput:focus{
    outline:none;
    border-color:#5ddb5d;
    color:#5ddb5d;
}
#captainPinInput.error{
    border-color:#e74c3c;
    color:#e74c3c;
    animation:shake 0.3s;
}
#captainPinInput.success{
    border-color:#4CAF50;
    color:#4CAF50;
}
.pin-error{
    color:#e74c3c;
    font-size:clamp(0.85rem,2vmin,1rem);
    margin-top:10px;
    display:none;
}
.pin-error.visible{
    display:block;
}
@keyframes shake{
    0%,100%{transform:translateX(0)}
    25%{transform:translateX(-10px)}
    75%{transform:translateX(10px)}
}

/* CAPTAIN KEY */
.home-bottom-buttons{
    display:flex;
    gap:clamp(10px,2vmin,20px);
    margin-top:clamp(20px,4vmin,40px);
    flex-wrap:wrap;
    justify-content:center;
}
.home-btn{
    background:transparent;
    border:2px solid;
    padding:clamp(10px,1.8vmin,16px) clamp(18px,3vmin,30px);
    font-size:clamp(0.85rem,2.2vmin,1.1rem);
    border-radius:clamp(8px,1.2vmin,12px);
    cursor:pointer;
    transition:all .2s;
    font-weight:500;
}
.home-btn:hover{
    transform:scale(1.05);
}
.home-btn.hub-btn{
    border-color:#888;
    color:#888;
}
.home-btn.hub-btn:hover{
    background:#888;
    color:#fff;
}
.home-btn.captain-btn{
    border-color:#FF9800;
    color:#FF9800;
}
.home-btn.captain-btn:hover{
    background:#FF9800;
    color:#fff;
}
.home-btn.settings-btn{
    border-color:#3498db;
    color:#3498db;
}
.home-btn.settings-btn:hover{
    background:#3498db;
    color:#fff;
}
.captain-board-container{
    max-width:min(500px,95vw)!important;
    width:95vw!important;
    padding:clamp(10px,2vmin,25px)!important;
    max-height:95vh;
    overflow-y:auto;
}
.captain-board{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:clamp(3px,1vmin,8px);
    margin:clamp(8px,1.5vmin,15px) 0;
    width:100%;
}
.captain-card{
    aspect-ratio:1;
    border-radius:clamp(4px,0.8vmin,10px);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:clamp(0.5rem,2.5vmin,0.9rem);
    font-weight:bold;
    text-transform:uppercase;
    padding:clamp(2px,0.5vmin,6px);
    text-align:center;
    word-break:break-word;
    line-height:1.1;
    color:#fff;
    text-shadow:1px 1px 2px rgba(0,0,0,0.5);
    overflow:hidden;
}
.captain-card.is-red{background:#e74c3c}
.captain-card.is-blue{background:#3498db}
.captain-card.is-neutral{background:#7f8c8d}
.captain-card.is-assassin{background:#1a1a1a;color:#e74c3c}
.captain-legend{
    display:flex;
    justify-content:center;
    gap:clamp(10px,2vmin,20px);
    flex-wrap:wrap;
    margin-top:clamp(10px,2vmin,15px);
}
.legend-item{
    display:flex;
    align-items:center;
    gap:5px;
    font-size:clamp(0.75rem,1.8vmin,0.95rem);
    color:#aaa;
}
.legend-color{
    width:clamp(12px,2vmin,18px);
    height:clamp(12px,2vmin,18px);
    border-radius:4px;
}
.legend-color.red{background:#e74c3c}
.legend-color.blue{background:#3498db}
.legend-color.neutral{background:#7f8c8d}
.legend-color.assassin{background:#1a1a1a;border:1px solid #e74c3c}

#endText{font-size:clamp(2rem,6vmin,5rem);margin-bottom:3vh}
.confetti{position:fixed;top:-20px;pointer-events:none;z-index:9999}

/* END OVERLAY */
.end-container{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:clamp(15px,3vmin,30px);
    padding:clamp(20px,4vmin,50px);
    max-width:min(600px,90vw);
}
.end-result{
    font-size:clamp(1.2rem,4vmin,2.5rem);
    font-weight:bold;
    text-align:center;
    padding:clamp(10px,2vmin,20px) clamp(20px,4vmin,40px);
    border-radius:clamp(10px,1.5vmin,20px);
    background:rgba(255,255,255,0.1);
}
.end-result.win-red{color:#e74c3c;border:2px solid #e74c3c}
.end-result.win-blue{color:#3498db;border:2px solid #3498db}
.end-result.assassin{color:#aaa;border:2px solid #1a1a1a;background:rgba(0,0,0,0.3)}
.end-result.match-won{
    font-size:clamp(1.5rem,5vmin,3rem);
    background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,215,0,0.05));
    border:2px solid gold;
    color:gold;
}
.end-scores{
    display:flex;
    align-items:center;
    gap:clamp(15px,3vmin,40px);
    margin:clamp(10px,2vmin,20px) 0;
}
.end-team{
    display:flex;
    align-items:center;
    gap:clamp(8px,1.5vmin,15px);
    padding:clamp(10px,2vmin,20px) clamp(15px,3vmin,30px);
    border-radius:clamp(10px,1.5vmin,20px);
    background:rgba(0,0,0,0.3);
}
.end-team.red{border:2px solid #e74c3c}
.end-team.blue{border:2px solid #3498db}
.end-emoji{font-size:clamp(1.5rem,4vmin,3rem)}
.end-name{font-size:clamp(0.9rem,2vmin,1.3rem);font-weight:bold}
.end-team.red .end-name{color:#e74c3c}
.end-team.blue .end-name{color:#3498db}
.end-score{
    font-size:clamp(2rem,6vmin,4rem);
    font-weight:bold;
    min-width:clamp(50px,8vmin,80px);
    text-align:center;
    padding:clamp(5px,1vmin,10px) clamp(10px,2vmin,20px);
    border-radius:clamp(8px,1vmin,15px);
}
.end-team.red .end-score{background:#e74c3c}
.end-team.blue .end-score{background:#3498db}
.end-vs{
    font-size:clamp(1.2rem,3vmin,2rem);
    font-weight:bold;
    color:#666;
}
.end-target{
    font-size:clamp(0.9rem,2vmin,1.2rem);
    color:#888;
}
.btn-next{
    font-size:clamp(1.1rem,3vmin,1.8rem)!important;
    padding:clamp(12px,2.5vmin,25px) clamp(30px,6vmin,60px)!important;
    margin-top:clamp(10px,2vmin,20px);
}
.btn-menu{
    margin-top:clamp(5px,1vmin,10px);
}

@media(max-width:500px){
.end-scores{flex-direction:column;gap:10px}
.end-team{width:100%;justify-content:space-between}
.end-vs{display:none}
.settings-container{padding:12px;max-height:95vh;width:98%}
.settings-title{font-size:1.3rem;margin-bottom:10px}
.team-card{padding:10px}
.team-card h3{font-size:0.95rem;margin-bottom:8px}
.avatar-picker{gap:4px}
.avatar-option{font-size:1.1rem;border-radius:6px}
.team-card input{padding:8px;font-size:0.9rem}
.game-settings{padding:10px}
.game-settings h3{font-size:0.95rem;margin-bottom:8px}
.setting-row{padding:8px;margin:5px 0}
.setting-row label{font-size:0.85rem}
.picker-option{min-width:36px;height:36px;font-size:0.9rem}
.rounds-option{width:36px;height:36px;font-size:1rem}
.style-option{padding:8px}
.preview-card{width:30px;height:40px;font-size:0.4rem}
.style-name{font-size:0.8rem}
.deck-option{padding:10px}
.deck-title{font-size:0.9rem}
.deck-desc{font-size:0.75rem}
.button-group{gap:8px;margin-top:10px}
.button-group button{padding:12px 15px;font-size:0.9rem}
}

/* MA≈ÅE EKRANY (telefony) */
@media(max-width:600px){
.top-bar{flex-wrap:wrap;padding:5px 10px;gap:5px}
.team-bar{max-width:100%;flex:1 1 45%;padding:8px 10px;gap:5px}
.team-bar .team-name{display:none}
.top-controls{order:-1;width:100%;justify-content:center;margin-bottom:5px}
.icon-btn{width:45px;height:45px}
.bottom-bar{flex-wrap:wrap;padding:5px;gap:5px}
.remaining-cards{max-width:42%}
.remaining-card{width:24px;height:32px}
.remaining-card .card-emoji{font-size:0.7rem}
.remaining-card .card-num{font-size:0.6rem}
#status{font-size:0.8rem;order:-1;width:100%;text-align:center;padding:3px 0}
.settings-container{padding:10px;border-radius:12px}
.team-setup{gap:10px}
.avatar-option{border-width:2px}
.style-picker{gap:8px;padding:8px}
.picker-panel{padding:10px}
.rounds-picker{padding:10px}
.deck-picker{padding:10px}
}

/* TABLETY (iPad) */
@media(min-width:601px) and (max-width:1024px){
.remaining-card{width:clamp(26px,3.5vmin,45px);height:clamp(34px,4.5vmin,58px)}
.remaining-card .card-emoji{font-size:clamp(0.75rem,1.8vmin,1.3rem)}
.remaining-card .card-num{font-size:clamp(0.6rem,1.3vmin,1rem)}
.remaining-cards{gap:clamp(2px,0.3vmin,5px)}
}

/* BARDZO MA≈ÅE EKRANY */
@media(max-height:500px){
.top-bar{padding:3px 10px}
.team-bar{padding:5px 8px}
.bottom-bar{padding:3px 10px}
.remaining-card{width:22px;height:30px}
.remaining-card .card-emoji{font-size:0.65rem}
.remaining-card .card-num{font-size:0.55rem}
#status{font-size:0.75rem}
.board-container{padding:3px}
}

/* DU≈ªE EKRANY (TV) */
@media(min-width:1400px) and (min-height:900px){
.card{font-size:clamp(24px,4.5vmin,60px)}
.icon-btn{width:clamp(60px,7vmin,90px);height:clamp(60px,7vmin,90px);font-size:clamp(2rem,4vmin,3.5rem)}
}

/* SYSTEM POKOI / LOBBY */
.room-container{
    background:#2a2a2a;
    border-radius:clamp(15px,2vmin,25px);
    padding:clamp(20px,4vmin,40px);
    max-width:min(500px,90vw);
    width:90%;
}
.room-title{
    font-size:clamp(1.5rem,4vmin,2.5rem);
    margin-bottom:clamp(15px,3vmin,25px);
    background:linear-gradient(135deg,#e74c3c,#3498db);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
}
.room-code-display{
    font-size:clamp(2.5rem,8vmin,4rem);
    font-weight:bold;
    letter-spacing:0.3em;
    padding:clamp(15px,3vmin,25px);
    background:#1a1a1a;
    border-radius:clamp(10px,1.5vmin,15px);
    margin:clamp(15px,3vmin,25px) 0;
    font-family:'Courier New',monospace;
    color:#4CAF50;
    border:2px solid #4CAF50;
}
.room-input{
    width:100%;
    padding:clamp(12px,2vmin,18px);
    font-size:clamp(1.2rem,3vmin,1.8rem);
    border-radius:clamp(8px,1vmin,12px);
    border:2px solid #444;
    background:#1a1a1a;
    color:#fff;
    text-align:center;
    letter-spacing:0.2em;
    font-family:'Courier New',monospace;
    margin-bottom:clamp(10px,2vmin,15px);
    text-transform:uppercase;
}
.room-input:focus{
    outline:none;
    border-color:#4CAF50;
}
.room-input::placeholder{
    color:#666;
    letter-spacing:normal;
}
.pin-input{
    width:100%;
    padding:clamp(12px,2vmin,18px);
    font-size:clamp(1.5rem,4vmin,2rem);
    border-radius:clamp(8px,1vmin,12px);
    border:2px solid #444;
    background:#1a1a1a;
    color:#fff;
    text-align:center;
    letter-spacing:0.5em;
    font-family:'Courier New',monospace;
    margin-bottom:clamp(10px,2vmin,15px);
}
.pin-input:focus{
    outline:none;
    border-color:#FF9800;
}
.room-buttons{
    display:flex;
    flex-direction:column;
    gap:clamp(10px,2vmin,15px);
    margin-top:clamp(15px,3vmin,20px);
}
.room-btn{
    padding:clamp(12px,2vmin,18px) clamp(20px,4vmin,30px);
    font-size:clamp(1rem,2.5vmin,1.3rem);
    font-weight:bold;
    border:none;
    border-radius:clamp(8px,1vmin,12px);
    cursor:pointer;
    transition:all .2s;
}
.room-btn:hover{transform:scale(1.02)}
.room-btn.primary{background:#4CAF50;color:#fff}
.room-btn.secondary{background:#333;color:#aaa}
.room-btn.secondary:hover{background:#444;color:#fff}
.room-btn.danger{background:#e74c3c;color:#fff}
.room-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.room-status{
    font-size:clamp(0.9rem,2vmin,1.1rem);
    color:#888;
    margin:clamp(10px,2vmin,15px) 0;
}
.room-status.error{color:#e74c3c}
.room-status.success{color:#4CAF50}
.room-divider{
    display:flex;
    align-items:center;
    margin:clamp(15px,3vmin,25px) 0;
    color:#666;
    font-size:clamp(0.9rem,2vmin,1.1rem);
}
.room-divider::before,.room-divider::after{
    content:'';
    flex:1;
    height:1px;
    background:#444;
}
.room-divider span{
    padding:0 clamp(10px,2vmin,15px);
}
.room-players{
    background:#1a1a1a;
    border-radius:clamp(8px,1vmin,12px);
    padding:clamp(10px,2vmin,15px);
    margin:clamp(10px,2vmin,15px) 0;
    text-align:left;
}
.room-player{
    display:flex;
    align-items:center;
    gap:clamp(8px,1.5vmin,12px);
    padding:clamp(6px,1vmin,10px) 0;
    border-bottom:1px solid #333;
}
.room-player:last-child{border-bottom:none}
.room-player-icon{font-size:clamp(1.2rem,3vmin,1.8rem)}
.room-player-name{flex:1;color:#ccc}
.room-player-role{
    font-size:clamp(0.75rem,1.8vmin,0.9rem);
    padding:clamp(3px,0.5vmin,5px) clamp(8px,1vmin,12px);
    border-radius:clamp(4px,0.6vmin,6px);
    font-weight:bold;
}
.room-player-role.captain{background:#FF9800;color:#fff}
.room-player-role.player{background:#333;color:#888}
.copy-btn{
    background:none;
    border:none;
    font-size:clamp(1.2rem,3vmin,1.5rem);
    cursor:pointer;
    padding:clamp(5px,1vmin,10px);
    opacity:0.7;
    transition:opacity .2s;
}
.copy-btn:hover{opacity:1}
</style>
</head>
<body>

<div class="overlay" id="homeScreen" style="display:flex">
<div class="home-container">
<h1 class="home-title">TAJNIACY</h1>
<p class="home-subtitle">Gra towarzyska</p>
<div class="mode-selection">
<div class="mode-card classic">
<div class="mode-header" onclick="toggleModeCard(this.parentElement)">
<div class="mode-icon">üé≤</div>
<div class="mode-title-wrapper">
<div class="mode-title">KLASYCZNA</div>
</div>
<div class="mode-arrow">‚ñº</div>
</div>
<div class="mode-content">
<div class="mode-content-inner">
<div class="mode-details">
<div class="mode-description">Szybki start z tradycyjnymi zasadami</div>
<ul class="mode-features"><li>Standardowa plansza 5x5</li><li>1 zab√≥jca, 7 neutralnych</li><li>8/9 agent√≥w</li></ul>
</div>
<div class="mode-buttons">
<button class="mode-btn info" onclick="event.stopPropagation();showRules('classic')">i</button>
<button class="mode-btn play" onclick="event.stopPropagation();selectMode('classic')">‚ñ∂</button>
</div>
</div>
</div>
</div>
<div class="mode-card crazy">
<div class="mode-header" onclick="toggleModeCard(this.parentElement)">
<div class="mode-icon">üé™</div>
<div class="mode-title-wrapper">
<div class="mode-title">SZALONA</div>
</div>
<div class="mode-arrow">‚ñº</div>
</div>
<div class="mode-content">
<div class="mode-content-inner">
<div class="mode-details">
<div class="mode-description">Wiƒôcej zab√≥jc√≥w, wiƒôcej emocji!</div>
<ul class="mode-features"><li>Od 1 do 7 zab√≥jc√≥w</li><li>Mniej neutralnych kart</li><li>Wybierz kto zaczyna</li></ul>
</div>
<div class="mode-buttons">
<button class="mode-btn info" onclick="event.stopPropagation();showRules('crazy')">i</button>
<button class="mode-btn play" onclick="event.stopPropagation();selectMode('crazy')">‚ñ∂</button>
</div>
</div>
</div>
</div>
<div class="mode-card wip">
<div class="mode-header" onclick="toggleModeCard(this.parentElement)">
<div class="mode-icon">‚ö°</div>
<div class="mode-title-wrapper">
<div class="mode-title">RUSH</div>
<div class="mode-wip-badge">WIP</div>
</div>
<div class="mode-arrow">‚ñº</div>
</div>
<div class="mode-content">
<div class="mode-content-inner">
<div class="mode-details">
<div class="mode-description">Wy≈õcig z czasem!</div>
<ul class="mode-features"><li>Limit czasu na turƒô</li><li>Bonusy za szybkie odpowiedzi</li><li>Tryb b≈Çyskawiczny</li></ul>
</div>
<div class="mode-buttons">
<button class="mode-btn info" onclick="event.stopPropagation()">i</button>
<button class="mode-btn play disabled" onclick="event.stopPropagation()">‚ñ∂</button>
</div>
</div>
</div>
</div>
</div>
<div class="home-bottom-buttons">
<button class="home-btn hub-btn" onclick="goToHub()">üè† Powr√≥t do HUBu</button>
<button class="home-btn captain-btn" onclick="showCaptainKeyOverlay()">üîë Klucz kapitana</button>
<button class="home-btn settings-btn" onclick="showGlobalSettings()">‚öôÔ∏è Ustawienia</button>
</div>
</div>
</div>

<div class="overlay" id="rulesOverlay">
<div class="rules-container">
<h2 class="rules-title" id="rulesTitle">Zasady gry</h2>
<div class="rules-content" id="rulesContent"></div>
<button class="btn-new" onclick="hideO('rulesOverlay')">Rozumiem</button>
</div>
</div>

<div class="overlay" id="globalSettingsOverlay">
<div class="settings-container" style="max-width:500px">
<h2 class="settings-title">‚öôÔ∏è Ustawienia</h2>
<div class="game-settings" style="margin-bottom:0">
<div class="setting-row" style="margin:0 0 15px 0">
<label>D≈∫wiƒôki:</label>
<label class="toggle-switch">
<input type="checkbox" id="globalSoundToggle" onchange="updateSound(this.checked)">
<span class="toggle-slider"></span>
</label>
</div>
<div class="setting-row" style="margin:0 0 15px 0">
<label>Odkrywanie kart:</label>
<div class="keymode-toggle">
<span class="keymode-label left card-reveal-label" title="Klikniƒôcie">üëÜ</span>
<label class="toggle-switch keymode-switch card-reveal-switch">
<input type="checkbox" id="globalCardRevealToggle" onchange="updateCardRevealMode(this.checked)">
<span class="toggle-slider"></span>
</label>
<span class="keymode-label right card-reveal-label" title="Przytrzymanie">üëá</span>
</div>
</div>
<div class="setting-row style-row" style="margin:0 0 15px 0">
<div class="style-selector" id="globalStyleSelector" onclick="toggleStylePicker('global')">
<label>Styl kart:</label>
<div class="style-current">
<span id="globalStyleName">Bia≈Çe</span>
<span class="style-arrow">‚ñº</span>
</div>
</div>
<div class="style-picker" id="globalStylePicker">
<div class="style-option selected" data-style="white">
<div class="style-preview deck-white">
<div class="preview-card">Agent</div>
<div class="preview-card revealed is-red">Red</div>
<div class="preview-card revealed is-blue">Blue</div>
</div>
<span class="style-name">Bia≈Çe</span>
</div>
<div class="style-option" data-style="classic">
<div class="style-preview deck-classic">
<div class="preview-card">Agent</div>
<div class="preview-card revealed is-red">Red</div>
<div class="preview-card revealed is-blue">Blue</div>
</div>
<span class="style-name">Ciemne</span>
</div>
<div class="style-option" data-style="night">
<div class="style-preview deck-night">
<div class="preview-card">Agent</div>
<div class="preview-card revealed is-red">Red</div>
<div class="preview-card revealed is-blue">Blue</div>
</div>
<span class="style-name">Noc</span>
</div>
</div>
<input type="hidden" id="globalStyle" value="white">
</div>
<div class="setting-row" style="margin:0">
<label>Wersja:</label>
<span style="color:#888;font-size:0.9rem">1.0.0</span>
</div>
</div>
<button class="btn-new" onclick="hideO('globalSettingsOverlay')" style="margin-top:20px;width:100%">Zamknij</button>
</div>
</div>

<div class="overlay" id="classicSettings">
<div class="settings-container">
<h2 class="settings-title">Tryb Klasyczny</h2>
<div class="team-setup">
<div class="team-card red">
<h3>Dru≈ºyna Czerwona</h3>
<div class="avatar-picker" id="classicRedPicker"></div>
<input id="classicRedName" value="Czerwoni" placeholder="Nazwa dru≈ºyny">
</div>
<div class="team-card blue">
<h3>Dru≈ºyna Niebieska</h3>
<div class="avatar-picker" id="classicBluePicker"></div>
<input id="classicBlueName" value="Niebiescy" placeholder="Nazwa dru≈ºyny">
</div>
</div>
<div class="game-settings">
<div class="setting-row deck-row">
<div class="deck-selector" id="classicDeckSelector" onclick="toggleDeckPicker('classic')">
<label>Talia kart:</label>
<div class="deck-current">
<span id="classicDeckName">Standardowa</span>
<span class="deck-arrow">‚ñº</span>
</div>
</div>
<div class="deck-picker" id="classicDeckPicker">
<div class="deck-option selected" data-deck="standard">
<div class="deck-info">
<span class="deck-title">Standardowa</span>
<span class="deck-desc">Klasyczne s≈Çowa dla ca≈Çej rodziny. Bezpieczne has≈Ça odpowiednie dla ka≈ºdego wieku.</span>
</div>
</div>
<div class="deck-option" data-deck="adult">
<div class="deck-info">
<span class="deck-title">Dla doros≈Çych (18+)</span>
<span class="deck-desc">Has≈Ça z motywami dla doros≈Çych: alkohol, imprezy, kasyno i wiƒôcej.</span>
</div>
</div>
</div>
<input type="hidden" id="classicDeck" value="standard">
</div>
<div class="setting-row rounds-row">
<div class="rounds-selector" id="classicRoundsSelector" onclick="toggleRoundsPicker('classic')">
<label>Rundy do wygranej:</label>
<div class="rounds-current">
<span id="classicRoundsName">3</span>
<span class="rounds-arrow">‚ñº</span>
</div>
</div>
<div class="rounds-picker" id="classicRoundsPicker">
<div class="rounds-options">
<div class="rounds-option" data-rounds="1">1</div>
<div class="rounds-option" data-rounds="2">2</div>
<div class="rounds-option selected" data-rounds="3">3</div>
<div class="rounds-option" data-rounds="4">4</div>
<div class="rounds-option" data-rounds="5">5</div>
<div class="rounds-option custom" data-rounds="custom">...</div>
</div>
<div class="rounds-custom" id="classicRoundsCustom" style="display:none">
<label>W≈Çasna liczba:</label>
<input type="number" id="classicRoundsInput" min="1" max="99" value="6" onchange="updateCustomRounds('classic')">
</div>
</div>
<input type="hidden" id="classicWinTarget" value="3">
</div>
<div class="setting-row" style="margin:0">
<label>Tryb klucza:</label>
<div class="keymode-toggle">
<span class="keymode-label left">üëÅÔ∏è</span>
<label class="toggle-switch keymode-switch">
<input type="checkbox" id="classicKeyModeToggle" onchange="updateKeyMode('classic', this.checked)">
<span class="toggle-slider"></span>
</label>
<span class="keymode-label right">üîë</span>
</div>
<input type="hidden" id="classicKeyMode" value="preview">
</div>
</div>
<div class="button-group">
<button class="btn-reset" onclick="backToHome()" style="flex:1">‚Üê Powr√≥t</button>
<button class="btn-new" onclick="startClassic()" style="flex:2;font-size:1.3rem">Start</button>
</div>
</div>
</div>

<div class="overlay" id="crazySettings">
<div class="settings-container">
<h2 class="settings-title">Tryb Szalony</h2>
<div class="team-setup">
<div class="team-card red">
<h3>Dru≈ºyna Czerwona</h3>
<div class="avatar-picker" id="crazyRedPicker"></div>
<input id="crazyRedName" value="Czerwoni" placeholder="Nazwa dru≈ºyny">
</div>
<div class="team-card blue">
<h3>Dru≈ºyna Niebieska</h3>
<div class="avatar-picker" id="crazyBluePicker"></div>
<input id="crazyBlueName" value="Niebiescy" placeholder="Nazwa dru≈ºyny">
</div>
</div>
<div class="game-settings">
<h3 style="color:#FF9800;margin-bottom:15px">Zaawansowane</h3>
<div class="setting-row deck-row">
<div class="deck-selector" id="crazyDeckSelector" onclick="toggleDeckPicker('crazy')">
<label>Talia kart:</label>
<div class="deck-current">
<span id="crazyDeckName">Standardowa</span>
<span class="deck-arrow">‚ñº</span>
</div>
</div>
<div class="deck-picker" id="crazyDeckPicker">
<div class="deck-option selected" data-deck="standard">
<div class="deck-info">
<span class="deck-title">Standardowa</span>
<span class="deck-desc">Klasyczne s≈Çowa dla ca≈Çej rodziny. Bezpieczne has≈Ça odpowiednie dla ka≈ºdego wieku.</span>
</div>
</div>
<div class="deck-option" data-deck="adult">
<div class="deck-info">
<span class="deck-title">Dla doros≈Çych (18+)</span>
<span class="deck-desc">Has≈Ça z motywami dla doros≈Çych: alkohol, imprezy, kasyno i wiƒôcej.</span>
</div>
</div>
</div>
<input type="hidden" id="crazyDeck" value="standard">
</div>
<div class="setting-row picker-row">
<div class="picker-selector" id="crazyAssassinsSelector" onclick="togglePicker('crazyAssassins')">
<label>Zab√≥jcy:</label>
<div class="picker-current">
<span id="crazyAssassinsName">1</span>
<span class="picker-arrow">‚ñº</span>
</div>
</div>
<div class="picker-panel" id="crazyAssassinsPanel">
<div class="picker-options">
<div class="picker-option selected" data-value="1">1</div>
<div class="picker-option" data-value="2">2</div>
<div class="picker-option" data-value="3">3</div>
<div class="picker-option" data-value="4">4</div>
<div class="picker-option" data-value="5">5</div>
<div class="picker-option" data-value="6">6</div>
<div class="picker-option" data-value="7">7</div>
</div>
<div class="picker-info">Neutralne: <span id="crazyNeutralDisplay">7</span></div>
</div>
<input type="hidden" id="crazyAssassins" value="1">
<input type="hidden" id="crazyNeutral" value="7">
</div>
<div class="setting-row picker-row">
<div class="picker-selector" id="crazyStarterSelector" onclick="togglePicker('crazyStarter')">
<label>Zaczyna:</label>
<div class="picker-current">
<span id="crazyStarterName">Losowo</span>
<span class="picker-arrow">‚ñº</span>
</div>
</div>
<div class="picker-panel" id="crazyStarterPanel">
<div class="picker-options starter-options">
<div class="picker-option selected" data-value="random">üé≤ Losowo</div>
<div class="picker-option" data-value="red">üî¥ Czerwoni</div>
<div class="picker-option" data-value="blue">üîµ Niebiescy</div>
</div>
</div>
<input type="hidden" id="crazyStarter" value="random">
</div>
<div class="setting-row rounds-row">
<div class="rounds-selector" id="crazyRoundsSelector" onclick="toggleRoundsPicker('crazy')">
<label>Rundy do wygranej:</label>
<div class="rounds-current">
<span id="crazyRoundsName">3</span>
<span class="rounds-arrow">‚ñº</span>
</div>
</div>
<div class="rounds-picker" id="crazyRoundsPicker">
<div class="rounds-options">
<div class="rounds-option" data-rounds="1">1</div>
<div class="rounds-option" data-rounds="2">2</div>
<div class="rounds-option selected" data-rounds="3">3</div>
<div class="rounds-option" data-rounds="4">4</div>
<div class="rounds-option" data-rounds="5">5</div>
<div class="rounds-option custom" data-rounds="custom">...</div>
</div>
<div class="rounds-custom" id="crazyRoundsCustom" style="display:none">
<label>W≈Çasna liczba:</label>
<input type="number" id="crazyRoundsInput" min="1" max="99" value="6" onchange="updateCustomRounds('crazy')">
</div>
</div>
<input type="hidden" id="crazyWinTarget" value="3">
</div>
<div class="setting-row" style="margin:0">
<label>Tryb klucza:</label>
<div class="keymode-toggle">
<span class="keymode-label left">üëÅÔ∏è</span>
<label class="toggle-switch keymode-switch">
<input type="checkbox" id="crazyKeyModeToggle" onchange="updateKeyMode('crazy', this.checked)">
<span class="toggle-slider"></span>
</label>
<span class="keymode-label right">üîë</span>
</div>
<input type="hidden" id="crazyKeyMode" value="preview">
</div>
</div>
<div class="button-group">
<button class="btn-reset" onclick="backToHome()" style="flex:1">‚Üê Powr√≥t</button>
<button class="btn-new" onclick="startCrazy()" style="flex:2;font-size:1.3rem">Start</button>
</div>
</div>
</div>

<div id="gameScreen">
<div class="top-bar">
<div class="team-bar red">
<span class="team-emoji" id="scoreRedEmoji">üêâ</span>
<span class="team-name" id="scoreRedName">Czerwoni</span>
<span class="team-score" id="scoreRedPoints">0</span>
</div>
<div class="top-controls">
<button class="icon-btn" id="newRoundBtn" title="Nowa runda (przytrzymaj)"><svg class="hold-progress" viewBox="0 0 100 100"><path d="M50 2 L85 2 Q98 2 98 15 L98 85 Q98 98 85 98 L15 98 Q2 98 2 85 L2 15 Q2 2 15 2 Z"/></svg><span>üîÑ</span></button>
<button class="icon-btn" id="keyBtn" title="Poka≈º klucz (przytrzymaj)"><svg class="hold-progress" viewBox="0 0 100 100"><path d="M50 2 L85 2 Q98 2 98 15 L98 85 Q98 98 85 98 L15 98 Q2 98 2 85 L2 15 Q2 2 15 2 Z"/></svg><span>üëÅÔ∏è</span></button>
<button class="icon-btn settings-btn" onclick="showO('gameSettings')" title="Ustawienia"><span>‚öôÔ∏è</span></button>
</div>
<div class="team-bar blue">
<span class="team-score" id="scoreBluePoints">0</span>
<span class="team-name" id="scoreBlueName">Niebiescy</span>
<span class="team-emoji" id="scoreBlueEmoji">ü¶à</span>
</div>
</div>
<div class="board-container">
<div class="grid-container" id="board"></div>
</div>
<div class="bottom-bar">
<div class="remaining-cards red" id="redPanel"></div>
<div id="status">ZaczynajƒÖ: ...</div>
<div class="remaining-cards blue" id="bluePanel"></div>
</div>
</div>

<div class="overlay" id="gameSettings">
<div class="settings-container" style="max-width:400px">
<h2 style="font-size:1.8rem;margin-bottom:20px">Ustawienia</h2>
<div style="display:flex;flex-direction:column;gap:15px">
<div class="setting-row" style="margin:0">
<label>D≈∫wiƒôki:</label>
<label class="toggle-switch">
<input type="checkbox" id="gameSoundToggle" onchange="updateSound(this.checked)">
<span class="toggle-slider"></span>
</label>
</div>
<button class="btn-new" onclick="hideO('gameSettings')" style="width:100%">Kontynuuj grƒô</button>
<button class="btn-reset" onclick="hideO('gameSettings');confirmBack()" style="width:100%;padding:15px">Powr√≥t do menu</button>
</div>
</div>
</div>

<div class="overlay" id="endOverlay">
<div class="end-container">
<div class="end-result" id="endResult"></div>
<div class="end-scores">
<div class="end-team red">
<span class="end-emoji" id="endRedEmoji">üêâ</span>
<span class="end-name" id="endRedName">Czerwoni</span>
<span class="end-score" id="endRedScore">0</span>
</div>
<div class="end-vs">VS</div>
<div class="end-team blue">
<span class="end-score" id="endBlueScore">0</span>
<span class="end-name" id="endBlueName">Niebiescy</span>
<span class="end-emoji" id="endBlueEmoji">ü¶à</span>
</div>
</div>
<div class="end-target" id="endTarget">Pierwszy do 3 wygranych</div>
<button class="btn-new btn-next" id="nextRoundBtn" onclick="hideO('endOverlay');initRound()">Kolejna runda ‚Üí</button>
<button class="btn-reset btn-menu" id="matchWonBtn" onclick="resetMatch()" style="display:none">Powr√≥t do menu</button>
</div>
</div>

<div class="overlay" id="assassinOverlay">
<h2>ZAB√ìJCA!</h2>
<p style="font-size:1.2rem;margin:20px 0">Kt√≥ra dru≈ºyna trafi≈Ça na zab√≥jcƒô?</p>
<button class="btn-new" style="background:#e74c3c;margin:10px" onclick="assassinHit('red')"><span id="assRedText">Czerwoni</span></button>
<button class="btn-new" style="background:#3498db;margin:10px" onclick="assassinHit('blue')"><span id="assBlueText">Niebiescy</span></button>
</div>

<div class="overlay" id="keyWarning">
<div class="settings-container" style="max-width:500px">
<h2 style="font-size:2rem;margin-bottom:20px">Poka≈º klucz?</h2>
<p style="font-size:1.2rem;color:#f39c12;margin-bottom:30px">Uwaga! To ujawni wszystkie karty.</p>
<p style="font-size:1rem;color:#ccc;margin-bottom:30px">Upewnij siƒô, ≈ºe tylko szpiedzy widzƒÖ ekran!</p>
<div style="display:flex;gap:15px;justify-content:center">
<button class="btn-reset" onclick="hideO('keyWarning')">Anuluj</button>
<button class="btn-key" onclick="showKey()">Poka≈º</button>
</div>
</div>
</div>

<div class="overlay" id="pinOverlay">
<div class="settings-container" style="max-width:400px">
<h2 style="font-size:1.5rem;margin-bottom:15px">üîë Dane do klucza</h2>
<div style="background:#1a1a1a;border-radius:12px;padding:15px;margin-bottom:15px">
<p style="font-size:0.85rem;color:#888;margin-bottom:5px">Kod gry</p>
<div id="sessionCodeDisplay" style="font-size:2rem;font-weight:bold;color:#4CAF50;letter-spacing:0.3em;font-family:monospace">----</div>
</div>
<div style="background:#1a1a1a;border-radius:12px;padding:15px">
<p style="font-size:0.85rem;color:#888;margin-bottom:5px">PIN</p>
<div class="pin-display" id="pinDisplay" style="margin:0">1234</div>
</div>
<p style="font-size:0.9rem;color:#aaa;margin:15px 0">Podaj te dane kapitanom dru≈ºyn.<br>MogƒÖ je wpisaƒá w menu g≈Ç√≥wnym ‚Üí Klucz kapitana</p>
<div style="display:flex;gap:15px;justify-content:center;margin-top:20px">
<button class="btn-reset" onclick="hideO('pinOverlay')">Zamknij</button>
</div>
</div>
</div>

<div class="overlay" id="captainKeyOverlay">
<div class="settings-container captain-board-container">
<h2 style="font-size:1.3rem;margin-bottom:10px">üîë Klucz kapitana</h2>
<p style="font-size:0.95rem;color:#aaa;margin-bottom:15px">Wpisz kod gry i PIN z ekranu z planszƒÖ</p>
<div class="pin-input-section" style="background:transparent;padding:0">
<div style="margin-bottom:15px">
<label style="display:block;font-size:0.85rem;color:#888;margin-bottom:5px">Kod gry (4 znaki)</label>
<input type="text" id="sessionCodeInput" maxlength="4" placeholder="XXXX" autocomplete="off" style="width:100%;padding:12px;font-size:1.5rem;text-align:center;letter-spacing:0.3em;text-transform:uppercase;border-radius:8px;border:2px solid #444;background:#1a1a1a;color:#4CAF50;font-family:monospace">
</div>
<div class="pin-input-container">
<label style="display:block;font-size:0.85rem;color:#888;margin-bottom:5px">PIN (4 cyfry)</label>
<input type="text" id="captainPinInput" maxlength="4" placeholder="‚óè‚óè‚óè‚óè" autocomplete="off" inputmode="numeric">
</div>
<p class="pin-error" id="captainPinError">Nieprawid≈Çowy PIN</p>
</div>
<div style="display:flex;gap:10px;justify-content:center;margin-top:15px;flex-wrap:wrap">
<button class="btn-reset" onclick="hideCaptainKeyOverlay()">Anuluj</button>
<button class="btn-key" onclick="verifyCaptainPin()">Poka≈º klucz</button>
</div>
</div>
</div>

<div class="overlay" id="captainBoardOverlay">
<div class="settings-container captain-board-container">
<h2 style="font-size:1.3rem;margin-bottom:10px">üîë Klucz planszy</h2>
<div class="captain-board" id="captainBoard"></div>
<div class="captain-legend">
<span class="legend-item"><span class="legend-color red"></span>Czerwoni</span>
<span class="legend-item"><span class="legend-color blue"></span>Niebiescy</span>
<span class="legend-item"><span class="legend-color neutral"></span>Neutralni</span>
<span class="legend-item"><span class="legend-color assassin"></span>Zab√≥jca</span>
</div>
<button class="btn-reset" onclick="confirmCloseCaptainBoard()" style="margin-top:15px">Zamknij</button>
</div>
</div>

<div class="overlay" id="closeCaptainConfirm">
<div class="settings-container" style="max-width:400px">
<h2 style="font-size:1.5rem;margin-bottom:15px">ZamknƒÖƒá klucz?</h2>
<p style="font-size:1rem;color:#f39c12;margin-bottom:20px">Aby ponownie zobaczyƒá klucz, bƒôdziesz musia≈Ç wpisaƒá PIN.</p>
<div style="display:flex;gap:15px;justify-content:center">
<button class="btn-new" onclick="hideO('closeCaptainConfirm')">Zosta≈Ñ</button>
<button class="btn-reset" onclick="hideO('closeCaptainConfirm');hideO('captainBoardOverlay')">Zamknij</button>
</div>
</div>
</div>

<div class="overlay" id="newRoundConfirm">
<div class="settings-container" style="max-width:500px">
<h2 style="font-size:2rem;margin-bottom:20px">Nowa runda?</h2>
<p style="font-size:1.2rem;color:#f39c12;margin-bottom:30px">Obecna rozgrywka zostanie zresetowana.</p>
<div style="display:flex;gap:15px;justify-content:center">
<button class="btn-reset" onclick="hideO('newRoundConfirm')">Anuluj</button>
<button class="btn-new" onclick="hideO('newRoundConfirm');initRound()">Nowa runda</button>
</div>
</div>
</div>

<div class="overlay" id="backConfirm">
<div class="settings-container" style="max-width:500px">
<h2 style="font-size:2rem;margin-bottom:20px">Czy chcesz powr√≥ciƒá do menu?</h2>
<p style="font-size:1.2rem;color:#f39c12;margin-bottom:30px">Ca≈Çy postƒôp meczu zostanie utracony!</p>
<div style="display:flex;gap:15px;justify-content:center">
<button class="btn-key" style="background:#e74c3c" onclick="resetMatch()">Tak</button>
<button class="btn-reset" onclick="hideO('backConfirm')">Nie</button>
</div>
</div>
</div>

<script>
const WORDS=["Dinozaur","L√≥d","Szpieg","Zamek","Ksiƒô≈ºyc","Pies","D≈∫wig","Afryka","Piramida","Pilot","Szpital","Oko","Nied≈∫wied≈∫","Orze≈Ç","Trawa","Bombowiec","PociƒÖg","Doktor","Ziemia","Wieloryb","Szko≈Ça","G√≥ra","But","Bank","Ryba","Anio≈Ç","PajƒÖk","Klucz","Z≈Çoto","Papier","Jab≈Çko","Ogie≈Ñ","Samolot","Kod","Mecz","Tort","Gwiazda","Policja","Woda","Mur","Kr√≥lowa","Rycerz","Wiatr","Radio","Las","Duch","Zegarek","Rzeka","Komputer","KsiƒÖ≈ºka","Kawa","Cukier","Miasto","Most","Grom","S≈Ço≈Ñce","Chmura","≈önieg","Deszcz","Burza","Sztorm","Ocean","Pla≈ºa","Wyspa","D≈ºungla","Pustynia","Lawina","Wulkan","Trzƒôsienie","Robot","Laser","Rakieta","Planeta","Kometa","Satelita","Astronauta","Mars","Gitara","Pianino","Bƒôben","TrƒÖbka","Skrzypce","Opera","Koncert","Muzyka","Malarz","Rze≈∫ba","Galeria","Obraz","Farba","Pƒôdzel","Paleta","Muzeum","Pi≈Çka","Stadion","Bramka","Sƒôdzia","Mistrz","Medal","Puchar","Olimpiada","Smok","Czarodziej","Elf","Krasnolud","Troll","Goblin","Mag","Kapitan","Statek","Kotwica","≈ªagiel","Pirat","Skarb","Mapa","Kompas","Telefon","Ekran","Mysz","Klawiatura","Monitor","Drukarka","Kamera","Mikrofon"];
const ADULT=["Kamasutra","Orgazm","Seks","Erotyka","Striptiz","Kochanek","Gangster","Mafioso","Grzech","Piek≈Ço","Szatan","Demon","Alkohol","W√≥dka","Narkotyk","Dealer","Przemyt","Zab√≥jca","Morderca","Trucizna","Bro≈Ñ","Rewolwer","Karabin","Granat","Dynamit","Poker","Kasyno","Hazard","Ruletka","Oszust","Kanciarz","Wiƒôzienie","Kraty","Kajdanki","Policjant","Areszt","Cela","Wyrok","Whisky","Piwo","Wino","Kac","Impreza","Disco","Klub","Jackpot","Stawka","Blef","Hip-Hop","Rap","Skandal"];
const EMOJIS_RED=["üêâ","ü¶Å","üî•","üå∂Ô∏è","ü¶Ö","üöÄ","‚ö°","üíé"];
const EMOJIS_BLUE=["ü¶à","üê∫","‚ùÑÔ∏è","üåä","ü¶ã","üõ∏","‚≠ê","üîÆ"];

let wordList=WORDS,gameMode='classic',gameOver=false,isSpymaster=false,sideCards={red:[],blue:[]};
const team={red:{name:"Czerwoni",emoji:"üêâ",score:0},blue:{name:"Niebiescy",emoji:"ü¶à",score:0}};
const cfg={winTarget:3,sound:true,assassins:1,starter:'random',startAgents:9,otherAgents:8,neutral:7,width:5,height:5,deckStyle:'white',keyMode:'preview',cardRevealHold:false};
let remaining={red:0,blue:0};
let currentPin='';
let currentBoardData=null; // {words:[], roles:[]}

// Funkcja hashowania PIN-u (SHA-256)
async function hashPin(pin) {
    const encoder = new TextEncoder();
    const data = encoder.encode(pin + 'tajniacy_salt_2024');
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

const $=id=>document.getElementById(id);
let showO=id=>$(id).style.display='flex';
let hideO=id=>$(id).style.display='none';
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};

function toggleStylePicker(mode){
    const row=$(mode+'StyleSelector').closest('.style-row');
    row.classList.toggle('open');
}

function toggleDeckPicker(mode){
    const row=$(mode+'DeckSelector').closest('.deck-row');
    row.classList.toggle('open');
}

function toggleRoundsPicker(mode){
    const row=$(mode+'RoundsSelector').closest('.rounds-row');
    row.classList.toggle('open');
}

function togglePicker(id){
    const row=$(id+'Selector').closest('.picker-row');
    row.classList.toggle('open');
}

function updateCustomRounds(mode){
    const input=$(mode+'RoundsInput');
    const value=Math.max(1,Math.min(99,parseInt(input.value)||1));
    input.value=value;
    $(mode+'WinTarget').value=value;
    $(mode+'RoundsName').textContent=value;
}

function buildPickers(){
    ['classic','crazy'].forEach(mode=>{
        [['Red',EMOJIS_RED,'red'],['Blue',EMOJIS_BLUE,'blue']].forEach(([suffix,emojis,t])=>{
            const picker=$(mode+suffix+'Picker');
            if(!picker)return;
            picker.innerHTML='';
            emojis.forEach((e,i)=>{
                const div=document.createElement('div');
                div.className='avatar-option'+(i===0?' selected':'');
                div.dataset.emoji=e;
                div.textContent=e;
                div.onclick=()=>{
                    picker.querySelectorAll('.avatar-option').forEach(o=>o.classList.remove('selected'));
                    div.classList.add('selected');
                    team[t].emoji=e;
                };
                picker.appendChild(div);
            });
        });
        
        // Deck picker
        const deckPicker=$(mode+'DeckPicker');
        const deckNameEl=$(mode+'DeckName');
        if(deckPicker){
            deckPicker.querySelectorAll('.deck-option').forEach(opt=>{
                opt.onclick=()=>{
                    deckPicker.querySelectorAll('.deck-option').forEach(o=>o.classList.remove('selected'));
                    opt.classList.add('selected');
                    $(mode+'Deck').value=opt.dataset.deck;
                    deckNameEl.textContent=opt.querySelector('.deck-title').textContent;
                };
            });
        }
        
        // Rounds picker
        const roundsPicker=$(mode+'RoundsPicker');
        const roundsNameEl=$(mode+'RoundsName');
        const customEl=$(mode+'RoundsCustom');
        if(roundsPicker){
            roundsPicker.querySelectorAll('.rounds-option').forEach(opt=>{
                opt.onclick=()=>{
                    roundsPicker.querySelectorAll('.rounds-option').forEach(o=>o.classList.remove('selected'));
                    opt.classList.add('selected');
                    
                    if(opt.dataset.rounds==='custom'){
                        customEl.style.display='flex';
                        updateCustomRounds(mode);
                    }else{
                        customEl.style.display='none';
                        $(mode+'WinTarget').value=opt.dataset.rounds;
                        roundsNameEl.textContent=opt.dataset.rounds;
                    }
                };
            });
        }
    });
    
    // Assassins picker (tylko crazy)
    const assassinsPanel=$('crazyAssassinsPanel');
    if(assassinsPanel){
        assassinsPanel.querySelectorAll('.picker-option').forEach(opt=>{
            opt.onclick=()=>{
                assassinsPanel.querySelectorAll('.picker-option').forEach(o=>o.classList.remove('selected'));
                opt.classList.add('selected');
                const val=parseInt(opt.dataset.value);
                $('crazyAssassins').value=val;
                $('crazyAssassinsName').textContent=val;
                const neutral=8-val;
                $('crazyNeutral').value=neutral;
                $('crazyNeutralDisplay').textContent=neutral;
            };
        });
    }
    
    // Starter picker (tylko crazy)
    const starterPanel=$('crazyStarterPanel');
    if(starterPanel){
        starterPanel.querySelectorAll('.picker-option').forEach(opt=>{
            opt.onclick=()=>{
                starterPanel.querySelectorAll('.picker-option').forEach(o=>o.classList.remove('selected'));
                opt.classList.add('selected');
                $('crazyStarter').value=opt.dataset.value;
                $('crazyStarterName').textContent=opt.textContent.trim();
            };
        });
    }
    
    // Inicjalizacja keymode toggles - ustaw domy≈õlnie podglƒÖd jako aktywny
    ['classic','crazy'].forEach(mode=>{
        const toggle = $(mode+'KeyModeToggle');
        if(toggle){
            const container = toggle.closest('.keymode-toggle');
            if(container){
                container.querySelector('.keymode-label.left').classList.add('active');
            }
        }
    });
    
    // Global style picker
    const globalStylePicker=$('globalStylePicker');
    const globalStyleNameEl=$('globalStyleName');
    if(globalStylePicker){
        // Za≈Çaduj zapisany styl
        const savedStyle = localStorage.getItem('tajniacy_style') || 'white';
        $('globalStyle').value = savedStyle;
        
        globalStylePicker.querySelectorAll('.style-option').forEach(opt=>{
            if(opt.dataset.style === savedStyle){
                globalStylePicker.querySelectorAll('.style-option').forEach(o=>o.classList.remove('selected'));
                opt.classList.add('selected');
                globalStyleNameEl.textContent = opt.querySelector('.style-name').textContent;
            }
            opt.onclick=()=>{
                globalStylePicker.querySelectorAll('.style-option').forEach(o=>o.classList.remove('selected'));
                opt.classList.add('selected');
                $('globalStyle').value=opt.dataset.style;
                globalStyleNameEl.textContent=opt.querySelector('.style-name').textContent;
                $('globalStyleSelector').closest('.style-row').classList.remove('open');
                localStorage.setItem('tajniacy_style', opt.dataset.style);
            };
        });
    }
}

function toggleModeCard(card){
    // Je≈õli klikniƒôto w przycisk, nie prze≈ÇƒÖczaj
    if(event.target.closest('.mode-buttons')) return;
    
    const wasOpen = card.classList.contains('open');
    
    // Zamknij wszystkie karty
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('open'));
    
    // Otw√≥rz klikniƒôtƒÖ kartƒô (je≈õli by≈Ça zamkniƒôta)
    if(!wasOpen){
        card.classList.add('open');
    }
}

function selectMode(mode){
    gameMode=mode;
    hideO('homeScreen');
    // Zamknij karty przy wyj≈õciu
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('open'));
    showO(mode==='classic'?'classicSettings':'crazySettings');
}

function showRules(mode){
    const rules = {
        classic: `
            <h3>üéØ Cel gry</h3>
            <p>Dwie dru≈ºyny rywalizujƒÖ, aby jako pierwsze odnale≈∫ƒá wszystkich swoich <span class="highlight">agent√≥w</span> ukrytych pod kartami ze s≈Çowami.</p>
            
            <h3>üë• Dru≈ºyny</h3>
            <p>Gracze dzielƒÖ siƒô na dwie dru≈ºyny: <span class="danger">Czerwonych</span> i <span class="info">Niebieskich</span>. Ka≈ºda dru≈ºyna wybiera <span class="highlight">Szpiega</span> (kapitana), kt√≥ry zna po≈Ço≈ºenie wszystkich kart.</p>
            
            <h3>üéÆ Rozgrywka</h3>
            <ul>
                <li><span class="highlight">Szpieg</span> podaje swojej dru≈ºynie jednowyrazowƒÖ wskaz√≥wkƒô i liczbƒô kart, kt√≥re pasujƒÖ do tej wskaz√≥wki</li>
                <li>Dru≈ºyna pr√≥buje odgadnƒÖƒá karty swoich agent√≥w</li>
                <li>Trafienie karty przeciwnika lub neutralnej ko≈Ñczy turƒô</li>
                <li>Dru≈ºyna zaczynajƒÖca ma <span class="highlight">9 agent√≥w</span>, druga ma <span class="highlight">8</span></li>
            </ul>
            
            <h3>‚ò†Ô∏è Zab√≥jca</h3>
            <p>Na planszy jest <span class="danger">1 zab√≥jca</span>. Dru≈ºyna, kt√≥ra trafi na zab√≥jcƒô, <span class="danger">natychmiast przegrywa</span> rundƒô!</p>
            
            <h3>üèÜ Zwyciƒôstwo</h3>
            <p>Rundƒô wygrywa dru≈ºyna, kt√≥ra pierwsza odkryje wszystkich swoich agent√≥w. Mecz wygrywa dru≈ºyna, kt√≥ra pierwsza wygra ustalonƒÖ liczbƒô rund.</p>
        `,
        crazy: `
            <h3>üéØ Cel gry</h3>
            <p>Takie same zasady jak w trybie klasycznym, ale z <span class="danger">wiƒôkszym ryzykiem</span>!</p>
            
            <h3>‚ò†Ô∏è Wielu zab√≥jc√≥w</h3>
            <p>Mo≈ºesz ustawiƒá od <span class="danger">1 do 7 zab√≥jc√≥w</span> na planszy! Im wiƒôcej zab√≥jc√≥w, tym mniej neutralnych kart i wiƒôksze emocje.</p>
            <ul>
                <li>1 zab√≥jca = 7 neutralnych</li>
                <li>3 zab√≥jc√≥w = 5 neutralnych</li>
                <li>7 zab√≥jc√≥w = 1 neutralna</li>
            </ul>
            
            <h3>üé≤ Wyb√≥r startu</h3>
            <p>W trybie szalonym mo≈ºesz wybraƒá, kt√≥ra dru≈ºyna zaczyna grƒô, zamiast losowania.</p>
            
            <h3>‚ö° Strategia</h3>
            <p>Wiƒôcej zab√≥jc√≥w oznacza:</p>
            <ul>
                <li>Wiƒôksze ryzyko przy zgadywaniu</li>
                <li>Kr√≥tsze, bardziej intensywne rundy</li>
                <li>Ostro≈ºniejsze wskaz√≥wki od Szpiega</li>
            </ul>
            
            <h3>üèÜ Zwyciƒôstwo</h3>
            <p>Zasady wygranej pozostajƒÖ takie same - odkryj wszystkich swoich agent√≥w lub poczekaj, a≈º przeciwnik trafi na zab√≥jcƒô!</p>
        `
    };
    
    $('rulesTitle').textContent = mode === 'classic' ? 'Tryb Klasyczny' : 'Tryb Szalony';
    $('rulesContent').innerHTML = rules[mode];
    showO('rulesOverlay');
}

function backToHome(){hideO('classicSettings');hideO('crazySettings');showO('homeScreen')}

function startClassic(){
    team.red.name=$('classicRedName').value||'Czerwoni';
    team.blue.name=$('classicBlueName').value||'Niebiescy';
    cfg.winTarget=Math.max(1,+$('classicWinTarget').value||3);
    cfg.deckStyle=$('globalStyle').value;
    wordList=$('classicDeck').value==='adult'?ADULT:WORDS;
    cfg.assassins=1;cfg.starter='random';cfg.startAgents=9;cfg.otherAgents=8;cfg.neutral=7;cfg.width=5;cfg.height=5;
    cfg.keyMode=$('classicKeyMode').value;
    team.red.score=team.blue.score=0;
    
    // Nowa gra = nowy kod sesji
    localStorage.removeItem('tajniacy_session_id');
    
    hideO('classicSettings');
    $('gameScreen').style.display='flex';
    $('board').className='grid-container deck-'+cfg.deckStyle;
    document.body.classList.add('game-active');
    updateKeyButtonIcon();
    updateScore();
    initRound();
}

function startCrazy(){
    team.red.name=$('crazyRedName').value||'Czerwoni';
    team.blue.name=$('crazyBlueName').value||'Niebiescy';
    wordList=$('crazyDeck').value==='adult'?ADULT:WORDS;
    cfg.deckStyle=$('globalStyle').value;
    cfg.assassins=Math.max(1,Math.min(7,+$('crazyAssassins').value||1));
    cfg.starter=$('crazyStarter').value;
    cfg.startAgents=9;
    cfg.otherAgents=8;
    cfg.neutral=8-cfg.assassins;
    cfg.width=5;
    cfg.height=5;
    cfg.winTarget=Math.max(1,+$('crazyWinTarget').value||3);
    cfg.keyMode=$('crazyKeyMode').value;
    team.red.score=team.blue.score=0;
    
    // Nowa gra = nowy kod sesji
    localStorage.removeItem('tajniacy_session_id');
    
    hideO('crazySettings');
    $('gameScreen').style.display='flex';
    $('board').className='grid-container deck-'+cfg.deckStyle;
    document.body.classList.add('game-active');
    updateKeyButtonIcon();
    updateScore();
    initRound();
}

function updateScore(){
    $('scoreRedEmoji').textContent=team.red.emoji;$('scoreRedName').textContent=team.red.name;$('scoreRedPoints').textContent=team.red.score;
    $('scoreBlueEmoji').textContent=team.blue.emoji;$('scoreBlueName').textContent=team.blue.name;$('scoreBluePoints').textContent=team.blue.score;
}

function updateKeyButtonIcon(){
    const icon = cfg.keyMode === 'pin' ? 'üîë' : 'üëÅÔ∏è';
    $('keyBtn').querySelector('span').textContent = icon;
}

function createSideCards(){
    ['red','blue'].forEach(c=>{
        const panel=$(c+'Panel');
        panel.innerHTML='';
        sideCards[c]=[];
        for(let i=0;i<remaining[c];i++){
            const card=document.createElement('div');
            card.className='remaining-card';
            card.innerHTML=`<span class="card-emoji">${team[c].emoji}</span><span class="card-num">${i+1}</span>`;
            card.style.opacity='0';
            card.style.transform='scale(0)';
            panel.appendChild(card);
            sideCards[c].push(card);
        }
        // Animacja pojawiania siƒô ≈ºeton√≥w
        setTimeout(()=>animateTokensAppear(sideCards[c]),100);
    });
}

function updateSideCard(c){
    const unrevealed=sideCards[c].filter(e=>!e.classList.contains('revealed'));
    if(unrevealed.length){
        const token=unrevealed[unrevealed.length-1];
        token.classList.add('revealed');
        animateTokenReveal(token);
    }
}

function genLayout(roles,w,h){
    let best = null;
    let bestScore = -Infinity;
    
    // Ma≈Ça szansa na "dziki" uk≈Çad bez ogranicze≈Ñ (mo≈ºe mieƒá 5 w linii)
    if(Math.random() < 0.15){
        return shuffle([...roles]);
    }
    
    // Generuj uk≈Çady i wybierz najlepszy
    for(let attempt = 0; attempt < 40; attempt++){
        const candidate = shuffle([...roles]);
        const score = evaluateDispersion(candidate, w, h);
        if(score > bestScore){
            bestScore = score;
            best = candidate;
        }
    }
    return best;
}

function evaluateDispersion(r, w, h){
    let score = 0;
    
    // Du≈ºa kara za kwadraty 2x2 tego samego typu (czerwone, niebieskie, neutralne)
    for(let row = 0; row < h - 1; row++){
        for(let col = 0; col < w - 1; col++){
            const i = row * w + col;
            const type = r[i];
            if((type === 'red' || type === 'blue' || type === 'neutral') && 
               type === r[i+1] && type === r[i+w] && type === r[i+w+1]){
                score -= 50;
            }
        }
    }
    
    // Kara za skupiska w obszarze 3x3 (tylko 6+ kart)
    for(let row = 0; row <= h - 3; row++){
        for(let col = 0; col <= w - 3; col++){
            let redCount = 0, blueCount = 0, neutralCount = 0;
            for(let dr = 0; dr < 3; dr++){
                for(let dc = 0; dc < 3; dc++){
                    const type = r[(row+dr)*w + col+dc];
                    if(type === 'red') redCount++;
                    if(type === 'blue') blueCount++;
                    if(type === 'neutral') neutralCount++;
                }
            }
            if(redCount >= 6) score -= 40;
            if(blueCount >= 6) score -= 40;
            if(neutralCount >= 5) score -= 30;
        }
    }
    
    return score;
}

function initRound(){
    const board=$('board'),status=$('status');
    board.innerHTML='';hideO('endOverlay');
    gameOver=false;isSpymaster=false;
    document.body.classList.remove('spymaster-mode');
    updateKeyButtonIcon();
    $('keyBtn').classList.remove('active');
    
    const redStarts=cfg.starter==='random'?Math.random()<.5:cfg.starter==='red';
    remaining={red:redStarts?cfg.startAgents:cfg.otherAgents,blue:redStarts?cfg.otherAgents:cfg.startAgents};
    createSideCards();
    
    status.innerHTML=`ZaczynajƒÖ: <span class="team-${redStarts?'red':'blue'}">${team[redStarts?'red':'blue'].emoji} ${team[redStarts?'red':'blue'].name}</span>`;
    
    let roles=[...Array(cfg.assassins).fill('assassin'),...Array(cfg.neutral).fill('neutral'),...Array(remaining.red).fill('red'),...Array(remaining.blue).fill('blue')];
    roles=genLayout(roles,cfg.width,cfg.height);
    
    const words=shuffle([...wordList]).slice(0,cfg.width*cfg.height);
    
    // Zapisz dane planszy dla kapitana
    currentBoardData = {words: words, roles: roles};
    
    // Generuj PIN i zapisz do localStorage (po utworzeniu danych planszy)
    generatePin();
    
    words.forEach((word,i)=>{
        if(i>=roles.length)return;
        const card=document.createElement('div');
        card.className=`card is-${roles[i]}`;
        card.innerHTML=`
            <div class="card-inner">
                <div class="card-back"></div>
                <div class="card-front">${word}</div>
            </div>
        `;
        card.dataset.index = i;
        
        // Funkcja odkrywajƒÖca kartƒô
        const revealCard = () => {
            if(gameOver||isSpymaster||card.classList.contains('revealed')||!card.classList.contains('flipped'))return;
            card.classList.add('revealed');
            playSound('click');
            
            if(roles[i]==='assassin'){
                // Animacja zab√≥jcy - shake + flash
                animateAssassinReveal(card);
                gameOver=true;
                setTimeout(()=>{
                    $('assRedText').textContent=team.red.name;
                    $('assBlueText').textContent=team.blue.name;
                    showO('assassinOverlay');
                },600);
                return;
            }
            
            // Zwyk≈Ça karta - pulse
            animateCardReveal(card);
            
            if(roles[i]==='red'){
                remaining.red--;
                updateSideCard('red');
                if(!remaining.red){
                    gameOver=true; // Blokuj natychmiast
                    // Wygrana - burst
                    setTimeout(()=>animateWinBurst('red'),300);
                    setTimeout(()=>endRound(null,'red'),800);
                }
            }
            if(roles[i]==='blue'){
                remaining.blue--;
                updateSideCard('blue');
                if(!remaining.blue){
                    gameOver=true; // Blokuj natychmiast
                    // Wygrana - burst
                    setTimeout(()=>animateWinBurst('blue'),300);
                    setTimeout(()=>endRound(null,'blue'),800);
                }
            }
        };
        
        // Obs≈Çuga klikniƒôcia / przytrzymania
        let cardHoldTimer = null;
        const CARD_HOLD_TIME = 200;
        
        const startCardHold = (e) => {
            if(gameOver||isSpymaster||card.classList.contains('revealed')||!card.classList.contains('flipped'))return;
            
            if(cfg.cardRevealHold){
                e.preventDefault();
                card.classList.add('holding');
                cardHoldTimer = setTimeout(()=>{
                    card.classList.remove('holding');
                    revealCard();
                    cardHoldTimer = null;
                }, CARD_HOLD_TIME);
            }
        };
        
        const cancelCardHold = () => {
            if(cardHoldTimer){
                clearTimeout(cardHoldTimer);
                cardHoldTimer = null;
            }
            card.classList.remove('holding');
        };
        
        card.onclick = () => {
            if(!cfg.cardRevealHold){
                revealCard();
            }
        };
        
        card.addEventListener('mousedown', startCardHold);
        card.addEventListener('touchstart', startCardHold, {passive: false});
        card.addEventListener('mouseup', cancelCardHold);
        card.addEventListener('mouseleave', cancelCardHold);
        card.addEventListener('touchend', cancelCardHold);
        card.addEventListener('touchcancel', cancelCardHold);
        
        board.appendChild(card);
    });
    
    // Animacja flip kart - rewers na awers
    setTimeout(()=>animateCardsFlip(board.querySelectorAll('.card')),100);
}

function endRound(resultText,winner,isAssassin=false){
    gameOver=true;
    
    // Aktualizuj dane dru≈ºyn w overlay
    $('endRedEmoji').textContent=team.red.emoji;
    $('endRedName').textContent=team.red.name;
    $('endBlueEmoji').textContent=team.blue.emoji;
    $('endBlueName').textContent=team.blue.name;
    
    const resultEl=$('endResult');
    resultEl.className='end-result';
    
    if(winner){
        team[winner].score++;
        updateScore();
        
        // Animacja wyniku w g√≥rnym pasku
        animateScoreUpdate($('score'+winner.charAt(0).toUpperCase()+winner.slice(1)+'Points'));
        
        $('endRedScore').textContent=team.red.score;
        $('endBlueScore').textContent=team.blue.score;
        $('endTarget').textContent=`Do ${cfg.winTarget} wygranych rund`;
        
        if(team[winner].score>=cfg.winTarget){
            // Wygrana meczu
            showConfetti(winner==='red'?'#e74c3c':'#3498db');
            playSound('win');
            resultEl.textContent=`${team[winner].emoji} ${team[winner].name} WYGRYWAJƒÑ MECZ!`;
            resultEl.classList.add('match-won');
            $('nextRoundBtn').style.display='none';
            $('matchWonBtn').style.display='inline-block';
        }else{
            // Wygrana rundy
            playSound('win');
            if(isAssassin){
                resultEl.textContent=resultText;
                resultEl.classList.add('assassin');
            }else{
                resultEl.textContent=`${team[winner].emoji} ${team[winner].name} wygrywajƒÖ rundƒô!`;
                resultEl.classList.add('win-'+winner);
            }
            $('nextRoundBtn').style.display='inline-block';
            $('matchWonBtn').style.display='none';
        }
    }
    
    showO('endOverlay');
}

function assassinHit(loser){
    hideO('assassinOverlay');
    const winner=loser==='red'?'blue':'red';
    endRound(`${team[loser].emoji} ${team[loser].name} trafili na zab√≥jcƒô!`,winner,true);
}

function toggleKey(){
    if(gameOver)return;
    if(!isSpymaster){
        if(cfg.keyMode === 'pin'){
            showO('pinOverlay');
        } else {
            showO('keyWarning');
        }
    }
    else{isSpymaster=false;document.body.classList.remove('spymaster-mode');updateKeyButtonIcon();$('keyBtn').classList.remove('active')}
}

function showKey(){
    hideO('keyWarning');
    hideO('pinOverlay');
    isSpymaster=true;
    document.body.classList.add('spymaster-mode');
    updateKeyButtonIcon();
    $('keyBtn').classList.add('active');
}

async function generatePin(){
    currentPin = String(Math.floor(1000 + Math.random() * 9000));
    $('pinDisplay').textContent = currentPin;
    
    // Hashuj PIN przed zapisaniem
    const pinHash = await hashPin(currentPin);
    
    // Zapisz do localStorage (dla tej samej przeglƒÖdarki)
    localStorage.setItem('tajniacy_pin_hash', pinHash);
    localStorage.setItem('tajniacy_board', JSON.stringify(currentBoardData));
    
    // Zapisz do Firebase (dla innych urzƒÖdze≈Ñ)
    if(db) {
        try {
            // Generuj unikalny ID sesji (lub u≈ºyj istniejƒÖcego)
            let sessionId = localStorage.getItem('tajniacy_session_id');
            if(!sessionId) {
                sessionId = generateSessionCode();
                localStorage.setItem('tajniacy_session_id', sessionId);
            }
            
            await db.ref('games/' + sessionId).set({
                pinHash: pinHash,
                board: currentBoardData,
                createdAt: Date.now()
            });
            
            // Poka≈º kod sesji na ekranie z PIN-em
            if($('sessionCodeDisplay')) {
                $('sessionCodeDisplay').textContent = sessionId;
            }
            console.log('Gra zapisana w Firebase, kod:', sessionId);
        } catch(e) {
            console.log('Firebase niedostƒôpny, dzia≈Ça tylko lokalnie');
        }
    }
}

// Generuj 4-znakowy kod sesji
function generateSessionCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for(let i = 0; i < 4; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

function showCaptainKeyOverlay(){
    $('captainPinInput').value = '';
    $('captainPinInput').classList.remove('error','success');
    $('captainPinError').classList.remove('visible');
    showO('captainKeyOverlay');
    setTimeout(()=>$('captainPinInput').focus(), 300);
}

function goToHub(){
    // Placeholder - do implementacji p√≥≈∫niej
    alert('Funkcja powrotu do HUBu bƒôdzie dostƒôpna wkr√≥tce!');
}

function updateSound(enabled){
    cfg.sound = enabled;
    localStorage.setItem('tajniacy_sound', enabled);
    // Synchronizuj oba togglee
    if($('globalSoundToggle')) $('globalSoundToggle').checked = enabled;
    if($('gameSoundToggle')) $('gameSoundToggle').checked = enabled;
}

function updateKeyMode(mode, isPin){
    const value = isPin ? 'pin' : 'preview';
    $(mode + 'KeyMode').value = value;
    
    // Aktualizuj wizualne pod≈õwietlenie emoji
    const toggle = $(mode + 'KeyModeToggle').closest('.keymode-toggle');
    if(toggle){
        toggle.querySelector('.keymode-label.left').classList.toggle('active', !isPin);
        toggle.querySelector('.keymode-label.right').classList.toggle('active', isPin);
    }
}

function updateCardRevealMode(isHold){
    cfg.cardRevealHold = isHold;
    localStorage.setItem('tajniacy_cardRevealHold', isHold);
    
    // Aktualizuj wizualne pod≈õwietlenie emoji
    const toggle = $('globalCardRevealToggle').closest('.keymode-toggle');
    if(toggle){
        toggle.querySelector('.keymode-label.left').classList.toggle('active', !isHold);
        toggle.querySelector('.keymode-label.right').classList.toggle('active', isHold);
    }
}

function showGlobalSettings(){
    $('globalSoundToggle').checked = cfg.sound;
    $('globalCardRevealToggle').checked = cfg.cardRevealHold;
    
    // Aktualizuj wizualne pod≈õwietlenie emoji dla card reveal
    const toggle = $('globalCardRevealToggle').closest('.keymode-toggle');
    if(toggle){
        toggle.querySelector('.keymode-label.left').classList.toggle('active', !cfg.cardRevealHold);
        toggle.querySelector('.keymode-label.right').classList.toggle('active', cfg.cardRevealHold);
    }
    
    showO('globalSettingsOverlay');
}

function hideCaptainKeyOverlay(){
    hideO('captainKeyOverlay');
    $('captainPinInput').value = '';
    $('captainPinInput').classList.remove('error','success');
    $('captainPinError').classList.remove('visible');
}

async function verifyCaptainPin(){
    const input = $('captainPinInput');
    const error = $('captainPinError');
    const sessionInput = $('sessionCodeInput');
    
    // Pobierz kod sesji (je≈õli wpisany)
    const sessionCode = sessionInput ? sessionInput.value.toUpperCase().trim() : '';
    
    let savedPinHash = null;
    let savedBoard = null;
    
    // Je≈õli jest kod sesji, szukaj w Firebase
    if(sessionCode && sessionCode.length === 4 && db) {
        try {
            error.textContent = 'Szukam gry...';
            error.classList.add('visible');
            error.style.color = '#888';
            
            const snapshot = await db.ref('games/' + sessionCode).once('value');
            if(snapshot.exists()) {
                const data = snapshot.val();
                savedPinHash = data.pinHash;
                savedBoard = data.board;
                error.classList.remove('visible');
            } else {
                error.textContent = 'Nie znaleziono gry o kodzie ' + sessionCode;
                error.style.color = '#e74c3c';
                error.classList.add('visible');
                input.classList.add('error');
                setTimeout(()=>input.classList.remove('error'), 300);
                return;
            }
        } catch(e) {
            console.log('B≈ÇƒÖd Firebase:', e);
            error.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia';
            error.style.color = '#e74c3c';
            error.classList.add('visible');
            return;
        }
    } else {
        // Brak kodu sesji - szukaj w localStorage
        savedPinHash = localStorage.getItem('tajniacy_pin_hash');
        const savedBoardStr = localStorage.getItem('tajniacy_board');
        if(savedBoardStr) {
            try {
                savedBoard = JSON.parse(savedBoardStr);
            } catch(e) {}
        }
    }
    
    if(!savedPinHash || !savedBoard){
        error.textContent = 'Wpisz kod gry lub uruchom grƒô na tym urzƒÖdzeniu';
        error.style.color = '#e74c3c';
        error.classList.add('visible');
        input.classList.add('error');
        setTimeout(()=>input.classList.remove('error'), 300);
        return;
    }
    
    // Hashuj wpisany PIN i por√≥wnaj
    const inputHash = await hashPin(input.value);
    
    if(inputHash === savedPinHash){
        input.classList.remove('error');
        input.classList.add('success');
        error.classList.remove('visible');
        
        try {
            // Najpierw przygotuj planszƒô
            buildCaptainBoard(savedBoard);
            
            // Ukryj input overlay i poka≈º planszƒô
            $('captainKeyOverlay').style.display = 'none';
            $('captainBoardOverlay').style.display = 'flex';
        } catch(e) {
            error.textContent = 'B≈ÇƒÖd wczytywania planszy';
            error.style.color = '#e74c3c';
            error.classList.add('visible');
        }
    } else {
        error.textContent = 'Nieprawid≈Çowy PIN';
        error.style.color = '#e74c3c';
        input.classList.add('error');
        error.classList.add('visible');
        setTimeout(()=>input.classList.remove('error'), 300);
    }
}

function buildCaptainBoard(boardData){
    const board = $('captainBoard');
    board.innerHTML = '';
    
    boardData.words.forEach((word, i) => {
        const card = document.createElement('div');
        card.className = `captain-card is-${boardData.roles[i]}`;
        card.textContent = word;
        board.appendChild(card);
    });
}

function confirmCloseCaptainBoard(){
    showO('closeCaptainConfirm');
}

function confirmNewRound(){
    hideO('gameSettings');
    if(!gameOver&&$('board').children.length)showO('newRoundConfirm');
    else initRound();
}

function confirmBack(){showO('backConfirm')}

function resetMatch(){
    hideO('backConfirm');hideO('endOverlay');hideO('gameSettings');
    $('gameScreen').style.display='none';
    showO('homeScreen');
    document.body.classList.remove('game-active','spymaster-mode');
    $('board').innerHTML='';
    $('redPanel').innerHTML='';
    $('bluePanel').innerHTML='';
    team.red.score=team.blue.score=0;
    gameOver=false;isSpymaster=false;
}

function showConfetti(color){
    const colors = color === '#e74c3c' ? ['#e74c3c','#c0392b','#ff6b6b','#ee5a24'] : ['#3498db','#2980b9','#74b9ff','#0984e3'];
    for(let i=0;i<80;i++){
        const c=document.createElement('div');
        c.className='confetti';
        c.style.left=Math.random()*100+'vw';
        c.style.background=colors[Math.floor(Math.random()*colors.length)];
        c.style.width=(8+Math.random()*10)+'px';
        c.style.height=(8+Math.random()*10)+'px';
        c.style.borderRadius=Math.random()>0.5?'50%':'0';
        document.body.appendChild(c);
        
        anime({
            targets:c,
            translateY:[0,window.innerHeight+100],
            translateX:()=>anime.random(-100,100),
            rotate:()=>anime.random(0,720),
            scale:[1,anime.random(0.5,1.5)],
            opacity:[1,0],
            duration:anime.random(2000,4000),
            easing:'easeOutQuad',
            complete:()=>c.remove()
        });
    }
}

// Animacje Anime.js
function animateCardReveal(card){
    // Pulse + scale
    anime({
        targets:card,
        scale:[1,1.15,1],
        boxShadow:['0 4px 12px rgba(0,0,0,0.3)','0 8px 30px rgba(0,0,0,0.5)','0 4px 12px rgba(0,0,0,0.3)'],
        duration:350,
        easing:'easeOutBack'
    });
}

function animateAssassinReveal(card){
    // Shake + flash
    anime({
        targets:card,
        translateX:[0,-8,8,-8,8,-4,4,0],
        duration:400,
        easing:'easeInOutQuad'
    });
    
    // Flash effect na card-front
    const cardFront = card.querySelector('.card-front');
    if(cardFront){
        anime({
            targets:cardFront,
            boxShadow:['inset 0 0 20px rgba(0,0,0,0.3)','0 0 40px rgba(255,0,0,0.8)','inset 0 0 20px rgba(0,0,0,0.3)'],
            duration:600,
            easing:'easeOutQuad'
        });
    }
    
    playSound('assassin');
}

function animateWinBurst(color){
    const boardRect=$('board').getBoundingClientRect();
    const centerX=boardRect.left+boardRect.width/2;
    const centerY=boardRect.top+boardRect.height/2;
    const burstColor=color==='red'?'#e74c3c':'#3498db';
    const burstColorLight=color==='red'?'#ff6b6b':'#74b9ff';
    
    // Du≈ºy burst z centrum planszy
    for(let i=0;i<50;i++){
        const particle=document.createElement('div');
        const size=10+Math.random()*15;
        particle.style.cssText=`
            position:fixed;
            left:${centerX}px;
            top:${centerY}px;
            width:${size}px;
            height:${size}px;
            background:${Math.random()>0.5?burstColor:burstColorLight};
            border-radius:50%;
            pointer-events:none;
            z-index:9999;
            transform:translate(-50%,-50%);
        `;
        document.body.appendChild(particle);
        
        const angle=Math.random()*Math.PI*2;
        const distance=150+Math.random()*200;
        
        anime({
            targets:particle,
            translateX:Math.cos(angle)*distance,
            translateY:Math.sin(angle)*distance,
            scale:[0,1.5,0],
            opacity:[1,1,0],
            duration:800+Math.random()*400,
            easing:'easeOutCubic',
            complete:()=>particle.remove()
        });
    }
}

function animateCardsFlip(cards){
    // Karty pojawiajƒÖ siƒô najpierw (rewersem)
    cards.forEach(card => {
        card.style.opacity = '1';
    });
    
    // Flip z op√≥≈∫nieniem dla ka≈ºdej karty
    cards.forEach((card, i) => {
        const row = Math.floor(i / 5);
        const col = i % 5;
        // Delay bazowany na odleg≈Ço≈õci od lewego g√≥rnego rogu
        const delay = (row + col) * 120 + 300;
        
        setTimeout(() => {
            card.classList.add('flipped');
        }, delay);
    });
}

function animateTokenReveal(token){
    anime({
        targets:token,
        scale:[1,0.85],
        opacity:[1,0.2],
        duration:300,
        easing:'easeOutQuad'
    });
}

function animateTokensAppear(tokens){
    anime({
        targets:tokens,
        scale:[0,1],
        opacity:[0,1],
        delay:anime.stagger(50),
        duration:300,
        easing:'easeOutBack'
    });
}

function animateOverlayShow(overlay){
    const id = overlay.id;
    anime.set(overlay,{display:'flex'});
    anime({
        targets:overlay,
        opacity:[0,1],
        duration:250,
        easing:'easeOutQuad'
    });
    
    // Home screen - animacje tytu≈Çu i kart tryb√≥w
    if(id === 'homeScreen'){
        const title = overlay.querySelector('.home-title');
        const subtitle = overlay.querySelector('.home-subtitle');
        const modeCards = overlay.querySelectorAll('.mode-card');
        
        if(title){
            anime({
                targets:title,
                translateY:[-30,0],
                opacity:[0,1],
                duration:500,
                easing:'easeOutBack'
            });
        }
        if(subtitle){
            anime({
                targets:subtitle,
                translateY:[-20,0],
                opacity:[0,1],
                duration:400,
                delay:100,
                easing:'easeOutQuad'
            });
        }
        if(modeCards.length){
            anime({
                targets:modeCards,
                translateY:[40,0],
                opacity:[0,1],
                delay:anime.stagger(100,{start:200}),
                duration:500,
                easing:'easeOutBack'
            });
        }
        return;
    }
    
    // Settings screens - prosta animacja
    if(id === 'classicSettings' || id === 'crazySettings'){
        const container = overlay.querySelector('.settings-container');
        if(container){
            anime({
                targets:container,
                translateY:[20,0],
                opacity:[0,1],
                duration:300,
                easing:'easeOutQuad'
            });
        }
        return;
    }
    
    // End overlay - animacja wyniku
    if(id === 'endOverlay'){
        const container = overlay.querySelector('.end-container');
        const result = overlay.querySelector('.end-result');
        const scores = overlay.querySelector('.end-scores');
        const target = overlay.querySelector('.end-target');
        const btns = overlay.querySelectorAll('.end-container button');
        
        if(container) anime.set(container,{opacity:1});
        if(result){
            anime({
                targets:result,
                scale:[0.5,1],
                opacity:[0,1],
                duration:500,
                easing:'easeOutBack'
            });
        }
        if(scores){
            anime({
                targets:scores,
                translateY:[30,0],
                opacity:[0,1],
                delay:200,
                duration:400,
                easing:'easeOutQuad'
            });
        }
        if(target){
            anime({
                targets:target,
                opacity:[0,1],
                delay:350,
                duration:300,
                easing:'easeOutQuad'
            });
        }
        if(btns.length){
            anime({
                targets:btns,
                translateY:[20,0],
                opacity:[0,1],
                delay:anime.stagger(100,{start:450}),
                duration:350,
                easing:'easeOutBack'
            });
        }
        return;
    }
    
    // Domy≈õlna animacja dla pozosta≈Çych overlay (confirmy, warnings)
    const container = overlay.querySelector('.settings-container');
    if(container){
        anime({
            targets:container,
            scale:[0.9,1],
            opacity:[0,1],
            duration:300,
            easing:'easeOutBack'
        });
    }
}

function animateOverlayHide(overlay,callback){
    anime({
        targets:overlay,
        opacity:[1,0],
        duration:200,
        easing:'easeInQuad',
        complete:()=>{
            overlay.style.display='none';
            if(callback)callback();
        }
    });
}

function animateScoreUpdate(el){
    anime({
        targets:el,
        scale:[1,1.3,1],
        duration:400,
        easing:'easeOutBack'
    });
}

function animateButtonHover(btn,enter){
    anime.remove(btn);
    anime({
        targets:btn,
        scale:enter?1.1:1,
        duration:200,
        easing:'easeOutQuad'
    });
}

function animateHoldProgress(btn,progress){
    const circle=btn.querySelector('.hold-progress');
    if(circle){
        circle.style.background=`conic-gradient(#4CAF50 ${progress*360}deg, transparent ${progress*360}deg)`;
    }
}

let audioCtx=null;
function playSound(type){
    if(!cfg.sound)return;
    try{
        if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
        const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
        osc.connect(gain);gain.connect(audioCtx.destination);
        if(type==='assassin'){osc.frequency.value=100;gain.gain.setValueAtTime(.3,audioCtx.currentTime);gain.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.5);osc.start();osc.stop(audioCtx.currentTime+.5)}
        else if(type==='win'){[523,659,784].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.value=f;g.gain.setValueAtTime(.2,audioCtx.currentTime+i*.15);g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+i*.15+.3);o.start(audioCtx.currentTime+i*.15);o.stop(audioCtx.currentTime+i*.15+.3)})}
        else{osc.frequency.value=800;gain.gain.setValueAtTime(.15,audioCtx.currentTime);gain.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.1);osc.start();osc.stop(audioCtx.currentTime+.1)}
    }catch(e){}
}

buildPickers();

// Za≈Çaduj ustawienia d≈∫wiƒôku z localStorage
const savedSound = localStorage.getItem('tajniacy_sound');
if(savedSound !== null){
    cfg.sound = savedSound === 'true';
}

// Za≈Çaduj ustawienia odkrywania kart z localStorage
const savedCardRevealHold = localStorage.getItem('tajniacy_cardRevealHold');
if(savedCardRevealHold !== null){
    cfg.cardRevealHold = savedCardRevealHold === 'true';
}

showO('homeScreen');

// Obs≈Çuga przytrzymania przycisk√≥w z animacjƒÖ
let holdTimer=null;
let holdAnimation=null;
const HOLD_TIME=500;

function setupHoldButton(btnId,action,condition){
    const btn=$(btnId);
    if(!btn)return;
    
    const path=btn.querySelector('svg.hold-progress path');
    const perimeter=384; // przybli≈ºony obw√≥d ≈õcie≈ºki
    if(path){
        path.style.strokeDasharray=perimeter;
        path.style.strokeDashoffset=perimeter;
    }
    
    const startHold=(e)=>{
        // Sprawd≈∫ warunek - je≈õli false, nie uruchamiaj animacji
        if(condition && !condition()){
            return;
        }
        
        e.preventDefault();
        btn.classList.add('holding');
        
        if(path){
            path.style.strokeDashoffset=perimeter;
            holdAnimation=anime({
                targets:path,
                strokeDashoffset:[perimeter,0],
                duration:HOLD_TIME,
                easing:'linear'
            });
        }
        
        holdTimer=setTimeout(()=>{
            btn.classList.remove('holding');
            // Flash effect po zako≈Ñczeniu
            anime({
                targets:btn,
                scale:[1,1.15,1],
                duration:200,
                easing:'easeOutBack'
            });
            if(path){
                path.style.strokeDashoffset=perimeter;
            }
            action();
        },HOLD_TIME);
    };
    
    const cancelHold=()=>{
        if(holdTimer){
            clearTimeout(holdTimer);
            holdTimer=null;
        }
        if(holdAnimation){
            holdAnimation.pause();
        }
        btn.classList.remove('holding');
        if(path){
            anime({
                targets:path,
                strokeDashoffset:perimeter,
                duration:150,
                easing:'easeOutQuad'
            });
        }
    };
    
    btn.addEventListener('mousedown',startHold);
    btn.addEventListener('touchstart',startHold,{passive:false});
    btn.addEventListener('mouseup',cancelHold);
    btn.addEventListener('mouseleave',cancelHold);
    btn.addEventListener('touchend',cancelHold);
    btn.addEventListener('touchcancel',cancelHold);
}

setupHoldButton('newRoundBtn',()=>{
    if(!gameOver&&$('board').children.length)showO('newRoundConfirm');
    else initRound();
});

// keyBtn - hold tylko dla trybu preview, click dla PIN
setupHoldButton('keyBtn',()=>{
    if(gameOver)return;
    if(cfg.keyMode === 'preview' && !isSpymaster){
        showO('keyWarning');
    }
}, ()=> cfg.keyMode === 'preview' && !isSpymaster);

// Obs≈Çuga klikniƒôcia keyBtn
$('keyBtn').addEventListener('click',()=>{
    if(gameOver)return;
    if(isSpymaster){
        toggleKey();
    } else if(cfg.keyMode === 'pin'){
        showO('pinOverlay');
    }
});

// Obs≈Çuga Enter w polu PIN kapitana
$('captainPinInput').addEventListener('keyup',(e)=>{
    if(e.key === 'Enter') verifyCaptainPin();
});

// Animowane przej≈õcia overlay
const origShowO=showO;
showO=id=>{
    const overlay=$(id);
    if(overlay){
        animateOverlayShow(overlay);
    }
    if(id==='gameSettings'){
        $('gameSoundToggle').checked=cfg.sound;
    }
};

const origHideO=hideO;
hideO=id=>{
    const overlay=$(id);
    if(overlay && overlay.style.display!=='none'){
        animateOverlayHide(overlay);
    }
};

// ==================== OBS≈ÅUGA KLAWIATURY ====================
let selectedCardIndex = -1;
let keyboardMode = false;

function getVisibleCards(){
    return Array.from($('board').querySelectorAll('.card:not(.revealed)'));
}

function getAllCards(){
    return Array.from($('board').querySelectorAll('.card'));
}

function updateCardSelection(newIndex){
    const allCards = getAllCards();
    if(allCards.length === 0) return;
    
    // Usu≈Ñ poprzednie zaznaczenie
    allCards.forEach(c => c.classList.remove('keyboard-selected'));
    
    // Ogranicz indeks
    if(newIndex < 0) newIndex = 0;
    if(newIndex >= allCards.length) newIndex = allCards.length - 1;
    
    selectedCardIndex = newIndex;
    allCards[selectedCardIndex].classList.add('keyboard-selected');
    
    // Przewi≈Ñ do widoczno≈õci je≈õli trzeba
    allCards[selectedCardIndex].scrollIntoView({behavior:'smooth', block:'nearest'});
}

function moveSelection(dx, dy){
    if(!keyboardMode || $('gameScreen').style.display === 'none') return;
    
    const cols = 5;
    const allCards = getAllCards();
    if(allCards.length === 0) return;
    
    if(selectedCardIndex < 0) {
        updateCardSelection(0);
        return;
    }
    
    let newIndex = selectedCardIndex;
    const row = Math.floor(selectedCardIndex / cols);
    const col = selectedCardIndex % cols;
    
    if(dx !== 0){
        const newCol = col + dx;
        if(newCol >= 0 && newCol < cols){
            newIndex = row * cols + newCol;
        }
    }
    if(dy !== 0){
        const newRow = row + dy;
        if(newRow >= 0 && newRow < Math.ceil(allCards.length / cols)){
            newIndex = newRow * cols + col;
            if(newIndex >= allCards.length) newIndex = allCards.length - 1;
        }
    }
    
    updateCardSelection(newIndex);
}

function activateSelectedCard(){
    if(selectedCardIndex < 0) return;
    const allCards = getAllCards();
    const card = allCards[selectedCardIndex];
    if(card && !card.classList.contains('revealed') && card.classList.contains('flipped')){
        // Dla klawiatury/gamepada - bezpo≈õrednie odkrycie (pomijamy hold)
        // Symulujemy zdarzenie mousedown + mouseup z op√≥≈∫nieniem lub bezpo≈õredni click
        if(cfg.cardRevealHold){
            // Symuluj przytrzymanie
            const mousedown = new MouseEvent('mousedown', {bubbles: true});
            card.dispatchEvent(mousedown);
            setTimeout(() => {
                const mouseup = new MouseEvent('mouseup', {bubbles: true});
                card.dispatchEvent(mouseup);
            }, 250); // trochƒô d≈Çu≈ºej ni≈º CARD_HOLD_TIME
        } else {
            card.click();
        }
    }
}

function enableKeyboardMode(){
    if(!keyboardMode){
        keyboardMode = true;
        if(selectedCardIndex < 0 && $('gameScreen').style.display !== 'none'){
            updateCardSelection(0);
        }
    }
}

function disableKeyboardMode(){
    keyboardMode = false;
    const allCards = getAllCards();
    allCards.forEach(c => c.classList.remove('keyboard-selected'));
    selectedCardIndex = -1;
}

function getActiveOverlay(){
    const overlays = ['endOverlay','assassinOverlay','keyWarning','pinOverlay','captainKeyOverlay',
                      'captainBoardOverlay','closeCaptainConfirm','newRoundConfirm','backConfirm',
                      'gameSettings','globalSettingsOverlay','rulesOverlay','classicSettings','crazySettings'];
    for(const id of overlays){
        const el = $(id);
        if(el && el.style.display === 'flex') return id;
    }
    return null;
}

// Przytrzymanie klawiszy
let keyHoldTimers = {};

document.addEventListener('keydown', (e) => {
    const activeOverlay = getActiveOverlay();
    const onGameScreen = $('gameScreen').style.display !== 'none' && !activeOverlay;
    
    // Escape - zamknij overlay lub wyjd≈∫ z trybu klucza
    if(e.key === 'Escape'){
        if(activeOverlay){
            // Specjalna obs≈Çuga dla niekt√≥rych overlay√≥w
            if(activeOverlay === 'assassinOverlay') return; // nie zamykaj
            if(activeOverlay === 'captainBoardOverlay'){
                confirmCloseCaptainBoard();
                return;
            }
            // Ustawienia trybu - wr√≥ƒá do menu g≈Ç√≥wnego
            if(activeOverlay === 'classicSettings' || activeOverlay === 'crazySettings'){
                backToHome();
                return;
            }
            hideO(activeOverlay);
        } else if(isSpymaster){
            toggleKey();
        } else if(keyboardMode){
            disableKeyboardMode();
        }
        return;
    }
    
    // Na ekranie gry
    if(onGameScreen && !gameOver){
        // Nawigacja strza≈Çkami / WASD
        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d','W','A','S','D'].includes(e.key)){
            e.preventDefault();
            enableKeyboardMode();
            
            switch(e.key.toLowerCase()){
                case 'arrowup': case 'w': moveSelection(0, -1); break;
                case 'arrowdown': case 's': moveSelection(0, 1); break;
                case 'arrowleft': case 'a': moveSelection(-1, 0); break;
                case 'arrowright': case 'd': moveSelection(1, 0); break;
            }
            return;
        }
        
        // Enter / Spacja - odkryj kartƒô
        if((e.key === 'Enter' || e.key === ' ') && keyboardMode && !isSpymaster){
            e.preventDefault();
            activateSelectedCard();
            return;
        }
        
        // K - klucz (przytrzymaj w trybie preview)
        if(e.key.toLowerCase() === 'k' && !e.repeat){
            e.preventDefault();
            if(cfg.keyMode === 'pin'){
                showO('pinOverlay');
            } else if(!isSpymaster){
                // Przytrzymanie dla trybu preview
                if(!keyHoldTimers['k']){
                    keyHoldTimers['k'] = setTimeout(()=>{
                        showO('keyWarning');
                        keyHoldTimers['k'] = null;
                    }, HOLD_TIME);
                }
            } else {
                toggleKey();
            }
            return;
        }
        
        // N - nowa runda (przytrzymaj)
        if(e.key.toLowerCase() === 'n' && !e.repeat){
            e.preventDefault();
            if(!keyHoldTimers['n']){
                keyHoldTimers['n'] = setTimeout(()=>{
                    if(!gameOver && $('board').children.length){
                        showO('newRoundConfirm');
                    } else {
                        initRound();
                    }
                    keyHoldTimers['n'] = null;
                }, HOLD_TIME);
            }
            return;
        }
        
        // P - ustawienia
        if(e.key.toLowerCase() === 'p'){
            e.preventDefault();
            showO('gameSettings');
            return;
        }
    }
    
    // Na overlayach - Enter potwierdza g≈Ç√≥wnƒÖ akcjƒô
    if(activeOverlay && e.key === 'Enter'){
        e.preventDefault();
        switch(activeOverlay){
            case 'keyWarning':
                showKey();
                break;
            case 'newRoundConfirm':
                hideO('newRoundConfirm');
                initRound();
                break;
            case 'backConfirm':
                resetMatch();
                break;
            case 'captainKeyOverlay':
                verifyCaptainPin();
                break;
            case 'closeCaptainConfirm':
                hideO('closeCaptainConfirm');
                hideO('captainBoardOverlay');
                break;
            case 'gameSettings':
                hideO('gameSettings');
                break;
            case 'globalSettingsOverlay':
                hideO('globalSettingsOverlay');
                break;
            case 'rulesOverlay':
                hideO('rulesOverlay');
                break;
        }
    }
    
    // Na ekranie g≈Ç√≥wnym
    if($('homeScreen').style.display === 'flex' && !activeOverlay){
        if(e.key === '1'){
            selectMode('classic');
        } else if(e.key === '2'){
            selectMode('crazy');
        }
    }
});

document.addEventListener('keyup', (e) => {
    // Anuluj hold timery
    if(e.key.toLowerCase() === 'k' && keyHoldTimers['k']){
        clearTimeout(keyHoldTimers['k']);
        keyHoldTimers['k'] = null;
    }
    if(e.key.toLowerCase() === 'n' && keyHoldTimers['n']){
        clearTimeout(keyHoldTimers['n']);
        keyHoldTimers['n'] = null;
    }
});

// Wy≈ÇƒÖcz tryb klawiatury przy klikniƒôciu myszƒÖ
document.addEventListener('mousedown', () => {
    if(keyboardMode) disableKeyboardMode();
});

// Reset zaznaczenia przy nowej rundzie
const origInitRound = initRound;
initRound = function(){
    disableKeyboardMode();
    origInitRound.apply(this, arguments);
};

// ==================== OBS≈ÅUGA GAMEPADA ====================
let gamepadIndex = null;
let gamepadPrevState = {};
let gamepadHoldTimers = {};
let gamepadAxisCooldown = {x: 0, y: 0};
const AXIS_THRESHOLD = 0.5;
const AXIS_COOLDOWN = 150; // ms miƒôdzy ruchami

window.addEventListener('gamepadconnected', (e) => {
    console.log('Gamepad connected:', e.gamepad.id);
    gamepadIndex = e.gamepad.index;
    gamepadPrevState = {};
});

window.addEventListener('gamepaddisconnected', (e) => {
    console.log('Gamepad disconnected');
    if(gamepadIndex === e.gamepad.index){
        gamepadIndex = null;
        gamepadPrevState = {};
    }
});

function pollGamepad(){
    if(gamepadIndex === null){
        requestAnimationFrame(pollGamepad);
        return;
    }
    
    const gamepads = navigator.getGamepads();
    const gp = gamepads[gamepadIndex];
    
    if(!gp){
        requestAnimationFrame(pollGamepad);
        return;
    }
    
    const now = Date.now();
    const activeOverlay = getActiveOverlay();
    const onGameScreen = $('gameScreen').style.display !== 'none' && !activeOverlay;
    const onHomeScreen = $('homeScreen').style.display === 'flex' && !activeOverlay;
    
    // Mapowanie przycisk√≥w (Xbox / PlayStation):
    // 0 = A / X (potwierd≈∫)
    // 1 = B / O (anuluj)
    // 2 = X / ‚ñ° 
    // 3 = Y / ‚ñ≥ (klucz)
    // 4 = LB / L1
    // 5 = RB / R1
    // 6 = LT / L2
    // 7 = RT / R2
    // 8 = Back/Select / Share
    // 9 = Start / Options (ustawienia)
    // 12 = D-pad Up
    // 13 = D-pad Down
    // 14 = D-pad Left
    // 15 = D-pad Right
    
    // Helper: sprawd≈∫ czy przycisk zosta≈Ç w≈Ça≈õnie wci≈õniƒôty
    const justPressed = (btnIndex) => {
        const pressed = gp.buttons[btnIndex]?.pressed;
        const wasPressed = gamepadPrevState[`btn${btnIndex}`];
        gamepadPrevState[`btn${btnIndex}`] = pressed;
        return pressed && !wasPressed;
    };
    
    // Helper: sprawd≈∫ czy przycisk jest trzymany
    const isHeld = (btnIndex) => gp.buttons[btnIndex]?.pressed;
    
    // D-pad / lewy analog - nawigacja
    let dx = 0, dy = 0;
    
    // D-pad
    if(justPressed(12)) dy = -1; // Up
    if(justPressed(13)) dy = 1;  // Down
    if(justPressed(14)) dx = -1; // Left
    if(justPressed(15)) dx = 1;  // Right
    
    // Lewy analog (z cooldown)
    const axisX = gp.axes[0] || 0;
    const axisY = gp.axes[1] || 0;
    
    if(Math.abs(axisX) > AXIS_THRESHOLD && now > gamepadAxisCooldown.x){
        dx = axisX > 0 ? 1 : -1;
        gamepadAxisCooldown.x = now + AXIS_COOLDOWN;
    }
    if(Math.abs(axisY) > AXIS_THRESHOLD && now > gamepadAxisCooldown.y){
        dy = axisY > 0 ? 1 : -1;
        gamepadAxisCooldown.y = now + AXIS_COOLDOWN;
    }
    
    // Reset cooldown gdy analog wraca do ≈õrodka
    if(Math.abs(axisX) < 0.2) gamepadAxisCooldown.x = 0;
    if(Math.abs(axisY) < 0.2) gamepadAxisCooldown.y = 0;
    
    // Na planszy gry
    if(onGameScreen && !gameOver){
        // Nawigacja
        if(dx !== 0 || dy !== 0){
            enableKeyboardMode();
            moveSelection(dx, dy);
        }
        
        // A / X - odkryj kartƒô
        if(justPressed(0) && keyboardMode && !isSpymaster){
            activateSelectedCard();
        }
        
        // B / O - wyjd≈∫ z trybu klucza
        if(justPressed(1)){
            if(isSpymaster){
                toggleKey();
            } else if(keyboardMode){
                disableKeyboardMode();
            }
        }
        
        // Y / ‚ñ≥ - klucz (przytrzymaj w trybie preview)
        if(justPressed(3)){
            if(cfg.keyMode === 'pin'){
                showO('pinOverlay');
            } else if(isSpymaster){
                toggleKey();
            } else {
                // Rozpocznij timer dla hold
                if(!gamepadHoldTimers['y']){
                    gamepadHoldTimers['y'] = setTimeout(()=>{
                        if(isHeld(3)){
                            showO('keyWarning');
                        }
                        gamepadHoldTimers['y'] = null;
                    }, HOLD_TIME);
                }
            }
        }
        if(!isHeld(3) && gamepadHoldTimers['y']){
            clearTimeout(gamepadHoldTimers['y']);
            gamepadHoldTimers['y'] = null;
        }
        
        // X / ‚ñ° - nowa runda (przytrzymaj)
        if(justPressed(2)){
            if(!gamepadHoldTimers['x']){
                gamepadHoldTimers['x'] = setTimeout(()=>{
                    if(isHeld(2)){
                        if(!gameOver && $('board').children.length){
                            showO('newRoundConfirm');
                        } else {
                            initRound();
                        }
                    }
                    gamepadHoldTimers['x'] = null;
                }, HOLD_TIME);
            }
        }
        if(!isHeld(2) && gamepadHoldTimers['x']){
            clearTimeout(gamepadHoldTimers['x']);
            gamepadHoldTimers['x'] = null;
        }
        
        // Start - ustawienia
        if(justPressed(9)){
            showO('gameSettings');
        }
    }
    
    // Na overlayach
    if(activeOverlay){
        // A - potwierd≈∫
        if(justPressed(0)){
            switch(activeOverlay){
                case 'keyWarning':
                    showKey();
                    break;
                case 'newRoundConfirm':
                    hideO('newRoundConfirm');
                    initRound();
                    break;
                case 'backConfirm':
                    resetMatch();
                    break;
                case 'closeCaptainConfirm':
                    hideO('closeCaptainConfirm');
                    hideO('captainBoardOverlay');
                    break;
                case 'gameSettings':
                    hideO('gameSettings');
                    break;
                case 'globalSettingsOverlay':
                    hideO('globalSettingsOverlay');
                    break;
                case 'rulesOverlay':
                    hideO('rulesOverlay');
                    break;
                case 'endOverlay':
                    if($('nextRoundBtn').style.display !== 'none'){
                        hideO('endOverlay');
                        initRound();
                    } else {
                        resetMatch();
                    }
                    break;
            }
        }
        
        // B - anuluj/zamknij
        if(justPressed(1)){
            if(activeOverlay === 'assassinOverlay') {
                // Nie zamykaj - trzeba wybraƒá dru≈ºynƒô
            } else if(activeOverlay === 'captainBoardOverlay'){
                confirmCloseCaptainBoard();
            } else if(activeOverlay === 'closeCaptainConfirm'){
                hideO('closeCaptainConfirm');
            } else if(activeOverlay === 'classicSettings' || activeOverlay === 'crazySettings'){
                backToHome();
            } else {
                hideO(activeOverlay);
            }
        }
        
        // Assassin overlay - LB/RB do wyboru dru≈ºyny
        if(activeOverlay === 'assassinOverlay'){
            if(justPressed(4)){ // LB - czerwoni
                assassinHit('red');
            }
            if(justPressed(5)){ // RB - niebiescy
                assassinHit('blue');
            }
        }
    }
    
    // Na ekranie g≈Ç√≥wnym
    if(onHomeScreen){
        // A lub nawigacja w prawo - tryb klasyczny (lewy kafelek)
        // Nawigacja do wyboru trybu
        if(justPressed(0) || justPressed(14)){ // A lub D-pad Left
            selectMode('classic');
        }
        if(justPressed(15)){ // D-pad Right
            selectMode('crazy');
        }
        
        // Start - ustawienia
        if(justPressed(9)){
            showGlobalSettings();
        }
        
        // Y - klucz kapitana
        if(justPressed(3)){
            showCaptainKeyOverlay();
        }
    }
    
    requestAnimationFrame(pollGamepad);
}

// Rozpocznij nas≈Çuchiwanie gamepada
requestAnimationFrame(pollGamepad);

// ==========================================
// FIREBASE - KONFIGURACJA (na przysz≈Ço≈õƒá dla trybu online)
// ==========================================

const firebaseConfig = {
    apiKey: "AIzaSyBYFHH9yP_0N0X14_2ooRyhZeXGhR36wIs",
    authDomain: "partyhub-6e16c.firebaseapp.com",
    databaseURL: "https://partyhub-6e16c-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "partyhub-6e16c",
    storageBucket: "partyhub-6e16c.firebasestorage.app",
    messagingSenderId: "58335201591",
    appId: "1:58335201591:web:7c8ab8298ff12beb3cb2b2"
};

// Inicjalizacja Firebase (gotowe do u≈ºycia w trybie online)
let db = null;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    console.log('Firebase gotowy');
} catch(e) {
    console.log('Firebase niedostƒôpny - tryb offline');
}
</script>
</body>
</html>
